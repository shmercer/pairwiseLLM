testthat::test_that("exploitation selection picks highest utility pairs deterministically", {
  samples <- tibble::tibble(
    ID = c("A", "B", "C", "D"),
    text = c("alpha", "bravo", "charlie", "delta")
  )
  state <- pairwiseLLM:::adaptive_state_new(samples, config = list())
  config <- pairwiseLLM:::adaptive_v3_config(state$N)

  candidates <- tibble::tibble(
    i_id = c("A", "A", "B"),
    j_id = c("B", "C", "C"),
    unordered_key = c("A:B", "A:C", "B:C"),
    utility = c(0.9, 0.7, 0.2),
    utility_raw = c(0.9, 0.7, 0.2),
    p_mean = c(0.5, 0.5, 0.5)
  )

  out1 <- pairwiseLLM:::select_exploitation_pairs_v3(
    candidates_with_utility = candidates,
    state = state,
    n_exploit = 2L,
    config = config
  )
  out2 <- pairwiseLLM:::select_exploitation_pairs_v3(
    candidates_with_utility = candidates,
    state = state,
    n_exploit = 2L,
    config = config
  )

  expect_equal(out1$unordered_key, c("A:B", "A:C"))
  expect_equal(out1$unordered_key, out2$unordered_key)
})
