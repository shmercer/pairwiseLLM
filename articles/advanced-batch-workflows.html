<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced: Submitting and Polling Multiple Batches • pairwiseLLM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced: Submitting and Polling Multiple Batches">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pairwiseLLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html">Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-usage-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Usage Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-usage-guides">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with pairwiseLLM</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-batch-workflows.html">Advanced: Submitting and Polling Multiple Batches</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/prompt-template-bias.html">Template Positional Bias</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/shmercer/pairwiseLLM/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced: Submitting and Polling Multiple Batches</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shmercer/pairwiseLLM/blob/master/vignettes/advanced-batch-workflows.Rmd" class="external-link"><code>vignettes/advanced-batch-workflows.Rmd</code></a></small>
      <div class="d-none name"><code>advanced-batch-workflows.Rmd</code></div>
    </div>

    
    
<style>
h1.title {
  display: none;
}
</style>
<p><img src="../../../_temp/Library/pairwiseLLM/images/pairwiseLLM_logo.jpeg" class="r-plt" width="100%" style="display: block; margin: auto;"></p>
<br><h1 style="text-align: center;">
Advanced: Submitting and Polling Multiple Batches
</h1>
<p><br></p>
<div class="section level2">
<h2 id="overview">1. Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette demonstrates how to use <strong>pairwiseLLM</strong>
for more complex <strong>batch workflows</strong>, including:</p>
<ul>
<li>Submitting many batches at once (e.g., across templates, providers,
models, and “thinking” settings)</li>
<li>Polling batches until they complete</li>
<li>Downloading and parsing batch results</li>
<li>Writing a <strong>batch registry CSV</strong> so you can safely
<strong>resume</strong> after interruptions</li>
</ul>
<p>The examples are based on the A/B template testing dev scripts
for:</p>
<ul>
<li>OpenAI (via <code><a href="../reference/run_openai_batch_pipeline.html">run_openai_batch_pipeline()</a></code> +
<code><a href="../reference/openai_get_batch.html">openai_get_batch()</a></code>)</li>
<li>Anthropic (via <code><a href="../reference/run_anthropic_batch_pipeline.html">run_anthropic_batch_pipeline()</a></code> +
<code><a href="../reference/anthropic_get_batch.html">anthropic_get_batch()</a></code>)</li>
<li>Gemini (via low-level helpers such as
<code><a href="../reference/build_gemini_batch_requests.html">build_gemini_batch_requests()</a></code> and
<code><a href="../reference/gemini_create_batch.html">gemini_create_batch()</a></code>)</li>
</ul>
<p>At present, batch helpers are implemented for OpenAI, Anthropic, and
Gemini. Together.ai and Ollama are supported only via the live APIs
(<code><a href="../reference/submit_llm_pairs.html">submit_llm_pairs()</a></code> / <code><a href="../reference/llm_compare_pair.html">llm_compare_pair()</a></code>).</p>
<blockquote>
<p>Note: All heavy API calls in this vignette are set to
<code>eval = FALSE</code> so that the vignette remains CRAN-safe. You
can enable them in your own project.</p>
</blockquote>
<p>For basic function usage, see the companion vignette:</p>
<ul>
<li><a href="https://shmercer.github.io/pairwiseLLM/articles/getting-started.html"><code>vignette("getting-started")</code></a></li>
</ul>
<p>For prompt evaluation and positional-bias diagnostics, see the
companion vignette:</p>
<ul>
<li><a href="https://shmercer.github.io/pairwiseLLM/articles/prompt-template-bias.html"><code>vignette("prompt-template-bias")</code></a></li>
</ul>
</div>
<div class="section level2">
<h2 id="setup-and-api-keys">2. Setup and API Keys<a class="anchor" aria-label="anchor" href="#setup-and-api-keys"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/shmercer/pairwiseLLM" class="external-link">pairwiseLLM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span></code></pre></div>
<p>Required environment variables:</p>
<table class="table">
<thead><tr class="header">
<th>Provider</th>
<th>Environment Variable</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>OpenAI</td>
<td><code>OPENAI_API_KEY</code></td>
</tr>
<tr class="even">
<td>Anthropic</td>
<td><code>ANTHROPIC_API_KEY</code></td>
</tr>
<tr class="odd">
<td>Gemini</td>
<td><code>GEMINI_API_KEY</code></td>
</tr>
</tbody>
</table>
<p>Check which are set:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_llm_api_keys.html">check_llm_api_keys</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; No LLM API keys are currently set for known backends:</span></span>
<span><span class="co">#&gt;   - OpenAI:         OPENAI_API_KEY</span></span>
<span><span class="co">#&gt;   - Anthropic:      ANTHROPIC_API_KEY</span></span>
<span><span class="co">#&gt;   - Google Gemini:  GEMINI_API_KEY</span></span>
<span><span class="co">#&gt;   - Together.ai:    TOGETHER_API_KEY</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use `usethis::edit_r_environ()` to add the keys persistently, e.g.:</span></span>
<span><span class="co">#&gt;   OPENAI_API_KEY    = "YOUR_OPENAI_KEY_HERE"</span></span>
<span><span class="co">#&gt;   ANTHROPIC_API_KEY = "YOUR_ANTHROPIC_KEY_HERE"</span></span>
<span><span class="co">#&gt;   GEMINI_API_KEY    = "YOUR_GEMINI_KEY_HERE"</span></span>
<span><span class="co">#&gt;   TOGETHER_API_KEY  = "YOUR_TOGETHER_KEY_HERE"</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 4</span></span></span>
<span><span class="co">#&gt;   backend   service       env_var           has_key</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> openai    OpenAI        OPENAI_API_KEY    FALSE  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> anthropic Anthropic     ANTHROPIC_API_KEY FALSE  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> gemini    Google Gemini GEMINI_API_KEY    FALSE  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> together  Together.ai   TOGETHER_API_KEY  FALSE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-data-and-prompt-template">3. Example Data and Prompt Template<a class="anchor" aria-label="anchor" href="#example-data-and-prompt-template"></a>
</h2>
<p>We use the built-in writing samples and a single trait
(<code>overall_quality</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_writing_samples"</span>, package <span class="op">=</span> <span class="st">"pairwiseLLM"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trait_description.html">trait_description</a></span><span class="op">(</span><span class="st">"overall_quality"</span><span class="op">)</span></span>
<span><span class="va">td</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; [1] "Overall Quality"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $description</span></span>
<span><span class="co">#&gt; [1] "Overall quality of the writing, considering how well ideas are expressed,\n      how clearly the writing is organized, and how effective the language and\n      conventions are."</span></span></code></pre></div>
<p>Default prompt template:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmpl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_prompt_template.html">set_prompt_template</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">tmpl</span>, <span class="fl">1</span>, <span class="fl">400</span><span class="op">)</span>, <span class="st">"...\n"</span><span class="op">)</span></span>
<span><span class="co">#&gt; You are a debate adjudicator. Your task is to weigh the comparative strengths of two writing samples regarding a specific trait.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; TRAIT: {TRAIT_NAME}</span></span>
<span><span class="co">#&gt; DEFINITION: {TRAIT_DESCRIPTION}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLES:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === SAMPLE_1 ===</span></span>
<span><span class="co">#&gt; {SAMPLE_1}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === SAMPLE_2 ===</span></span>
<span><span class="co">#&gt; {SAMPLE_2}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EVALUATION PROCESS (Mental Simulation):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1.  **Advocate for SAMPLE_1**: Mentally list the single strongest point of evidence that makes SAMPLE_1 the  ...</span></span></code></pre></div>
<p>Construct a modest number of pairs to keep the example light:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pairs_all</span> <span class="op">&lt;-</span> <span class="va">example_writing_samples</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/make_pairs.html">make_pairs</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">40L</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pairs_all</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pairs_forward</span> <span class="op">&lt;-</span> <span class="va">pairs_all</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/sample_pairs.html">sample_pairs</a></span><span class="op">(</span>n_pairs <span class="op">=</span> <span class="va">n_pairs</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/randomize_pair_order.html">randomize_pair_order</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">456</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pairs_reverse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_reverse_pairs.html">sample_reverse_pairs</a></span><span class="op">(</span></span>
<span>  <span class="va">pairs_forward</span>,</span>
<span>  reverse_pct <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  seed        <span class="op">=</span> <span class="fl">789</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">get_pairs_for_direction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">direction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"forward"</span>, <span class="st">"reverse"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">direction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">direction</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">direction</span>, <span class="st">"forward"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pairs_forward</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">pairs_reverse</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="designing-the-batch-grid">4. Designing the Batch Grid<a class="anchor" aria-label="anchor" href="#designing-the-batch-grid"></a>
</h2>
<p>Suppose we want to test several prompt templates across:</p>
<ul>
<li>Anthropic models (with/without “thinking”)</li>
<li>OpenAI models (with/without “thinking” for specific models)</li>
<li>Gemini models (with “thinking” enabled)</li>
</ul>
<p>Here we define a small grid:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">anthropic_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"claude-sonnet-4-5"</span>,</span>
<span>  <span class="st">"claude-haiku-4-5"</span>,</span>
<span>  <span class="st">"claude-opus-4-5"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gemini_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"gemini-3-pro-preview"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">openai_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"gpt-4.1"</span>,</span>
<span>  <span class="st">"gpt-4o"</span>,</span>
<span>  <span class="st">"gpt-5.1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">thinking_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"no_thinking"</span>, <span class="st">"with_thinking"</span><span class="op">)</span></span>
<span><span class="va">directions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"forward"</span>, <span class="st">"reverse"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anthropic_grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  provider  <span class="op">=</span> <span class="st">"anthropic"</span>,</span>
<span>  model     <span class="op">=</span> <span class="va">anthropic_models</span>,</span>
<span>  thinking  <span class="op">=</span> <span class="va">thinking_levels</span>,</span>
<span>  direction <span class="op">=</span> <span class="va">directions</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gemini_grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  provider  <span class="op">=</span> <span class="st">"gemini"</span>,</span>
<span>  model     <span class="op">=</span> <span class="va">gemini_models</span>,</span>
<span>  thinking  <span class="op">=</span> <span class="st">"with_thinking"</span>,</span>
<span>  direction <span class="op">=</span> <span class="va">directions</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">openai_grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  provider  <span class="op">=</span> <span class="st">"openai"</span>,</span>
<span>  model     <span class="op">=</span> <span class="va">openai_models</span>,</span>
<span>  thinking  <span class="op">=</span> <span class="va">thinking_levels</span>,</span>
<span>  direction <span class="op">=</span> <span class="va">directions</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># For example, only allow "with_thinking" for gpt-5.1</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"gpt-5.1"</span> <span class="op">|</span> <span class="va">thinking</span> <span class="op">==</span> <span class="st">"no_thinking"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_grid</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">anthropic_grid</span>,</span>
<span>  <span class="va">gemini_grid</span>,</span>
<span>  <span class="va">openai_grid</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_grid</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 22 × 4</span></span></span>
<span><span class="co">#&gt;    provider  model             thinking      direction</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> anthropic claude-sonnet-4-5 no_thinking   forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> anthropic claude-sonnet-4-5 no_thinking   reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> anthropic claude-sonnet-4-5 with_thinking forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> anthropic claude-sonnet-4-5 with_thinking reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> anthropic claude-haiku-4-5  no_thinking   forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> anthropic claude-haiku-4-5  no_thinking   reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> anthropic claude-haiku-4-5  with_thinking forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> anthropic claude-haiku-4-5  with_thinking reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> anthropic claude-opus-4-5   no_thinking   forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> anthropic claude-opus-4-5   no_thinking   reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 12 more rows</span></span></span></code></pre></div>
<p>We will also imagine multiple prompt templates have been registered.
For simplicity, we use the same <code>tmpl</code> string, but in
practice you would substitute different text:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">templates_tbl</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  template_id     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"test1"</span>, <span class="st">"test2"</span>, <span class="st">"test3"</span>, <span class="st">"test4"</span>, <span class="st">"test5"</span><span class="op">)</span>,</span>
<span>  prompt_template <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">tmpl</span>, <span class="va">tmpl</span>, <span class="va">tmpl</span>, <span class="va">tmpl</span>, <span class="va">tmpl</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">templates_tbl</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span></span>
<span><span class="co">#&gt;   template_id prompt_template</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> test1       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> test2       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> test3       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> test4       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> test5       <span style="color: #949494;">&lt;chr [1]&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="phase-1-submitting-many-batches-no-polling-yet">5. Phase 1: Submitting Many Batches (No Polling Yet)<a class="anchor" aria-label="anchor" href="#phase-1-submitting-many-batches-no-polling-yet"></a>
</h2>
<p>We will:</p>
<ol style="list-style-type: decimal">
<li>Loop over all
<code>(template_id, provider, model, thinking, direction)</code>
combinations.</li>
<li>Submit a batch for each combination.</li>
<li>Record metadata (including <code>batch_id</code>) in an in-memory
<code>jobs</code> list.</li>
<li>Write a <strong>batch index CSV</strong> to disk.</li>
</ol>
<p>Create an output directory:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_dir</span> <span class="op">&lt;-</span> <span class="st">"dev-output/advanced-multi-batch"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">out_dir</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Submit all batches:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">t_row</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">templates_tbl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">template_id</span> <span class="op">&lt;-</span> <span class="va">templates_tbl</span><span class="op">$</span><span class="va">template_id</span><span class="op">[</span><span class="va">t_row</span><span class="op">]</span></span>
<span>  <span class="va">tmpl_string</span> <span class="op">&lt;-</span> <span class="va">templates_tbl</span><span class="op">$</span><span class="va">prompt_template</span><span class="op">[[</span><span class="va">t_row</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">batch_grid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">row</span> <span class="op">&lt;-</span> <span class="va">batch_grid</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span></span>
<span>    <span class="va">provider</span> <span class="op">&lt;-</span> <span class="va">row</span><span class="op">$</span><span class="va">provider</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">row</span><span class="op">$</span><span class="va">model</span></span>
<span>    <span class="va">thinking</span> <span class="op">&lt;-</span> <span class="va">row</span><span class="op">$</span><span class="va">thinking</span></span>
<span>    <span class="va">direction</span> <span class="op">&lt;-</span> <span class="va">row</span><span class="op">$</span><span class="va">direction</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span></span>
<span>      <span class="st">"Submitting batch: template="</span>, <span class="va">template_id</span>,</span>
<span>      <span class="st">" | "</span>, <span class="va">provider</span>, <span class="st">" / "</span>, <span class="va">model</span>,</span>
<span>      <span class="st">" / "</span>, <span class="va">thinking</span>, <span class="st">" / "</span>, <span class="va">direction</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span>    <span class="va">pairs_use</span> <span class="op">&lt;-</span> <span class="fu">get_pairs_for_direction</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span></span>
<span>    <span class="va">is_thinking</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">thinking</span>, <span class="st">"with_thinking"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">prefix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">provider</span>, <span class="va">template_id</span>, <span class="va">model</span>, <span class="va">thinking</span>, <span class="va">direction</span>, </span>
<span>                    sep <span class="op">=</span> <span class="st">"_"</span><span class="op">)</span></span>
<span>    <span class="va">prefix</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"[^A-Za-z0-9_.-]"</span>, <span class="st">"-"</span>, <span class="va">prefix</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">batch_input_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">"_input.jsonl"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">batch_output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">"_output.jsonl"</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">csv_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">prefix</span>, <span class="st">".csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">provider</span>, <span class="st">"openai"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># OpenAI: use the helpers from the dev scripts</span></span>
<span>      <span class="va">include_thoughts</span> <span class="op">&lt;-</span> <span class="va">is_thinking</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^gpt-5\\.1"</span>, <span class="va">model</span><span class="op">)</span></span>
<span></span>
<span>      <span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_openai_batch_pipeline.html">run_openai_batch_pipeline</a></span><span class="op">(</span></span>
<span>        pairs             <span class="op">=</span> <span class="va">pairs_use</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        trait_name        <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">name</span>,</span>
<span>        trait_description <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">description</span>,</span>
<span>        prompt_template   <span class="op">=</span> <span class="va">tmpl_string</span>,</span>
<span>        include_thoughts  <span class="op">=</span> <span class="va">include_thoughts</span>,</span>
<span>        include_raw       <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        batch_input_path  <span class="op">=</span> <span class="va">batch_input_path</span>,</span>
<span>        batch_output_path <span class="op">=</span> <span class="va">batch_output_path</span>,</span>
<span>        poll              <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">jobs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        template_id       <span class="op">=</span> <span class="va">template_id</span>,</span>
<span>        provider          <span class="op">=</span> <span class="va">provider</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        thinking          <span class="op">=</span> <span class="va">thinking</span>,</span>
<span>        direction         <span class="op">=</span> <span class="va">direction</span>,</span>
<span>        prefix            <span class="op">=</span> <span class="va">prefix</span>,</span>
<span>        batch_type        <span class="op">=</span> <span class="st">"openai"</span>,</span>
<span>        batch_id          <span class="op">=</span> <span class="va">pipeline</span><span class="op">$</span><span class="va">batch</span><span class="op">$</span><span class="va">id</span>,</span>
<span>        batch_input_path  <span class="op">=</span> <span class="va">pipeline</span><span class="op">$</span><span class="va">batch_input_path</span>,</span>
<span>        batch_output_path <span class="op">=</span> <span class="va">batch_output_path</span>,</span>
<span>        csv_path          <span class="op">=</span> <span class="va">csv_path</span>,</span>
<span>        done              <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        results           <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">provider</span>, <span class="st">"anthropic"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Anthropic: use run_anthropic_batch_pipeline()</span></span>
<span>      <span class="va">reasoning</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">is_thinking</span><span class="op">)</span> <span class="st">"enabled"</span> <span class="kw">else</span> <span class="st">"none"</span></span>
<span>      <span class="va">temperature_arg</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">is_thinking</span><span class="op">)</span> <span class="fl">0</span> <span class="kw">else</span> <span class="cn">NULL</span></span>
<span></span>
<span>      <span class="va">pipeline</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_anthropic_batch_pipeline.html">run_anthropic_batch_pipeline</a></span><span class="op">(</span></span>
<span>        pairs             <span class="op">=</span> <span class="va">pairs_use</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        trait_name        <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">name</span>,</span>
<span>        trait_description <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">description</span>,</span>
<span>        prompt_template   <span class="op">=</span> <span class="va">tmpl_string</span>,</span>
<span>        reasoning         <span class="op">=</span> <span class="va">reasoning</span>,</span>
<span>        include_thoughts  <span class="op">=</span> <span class="va">is_thinking</span>,</span>
<span>        batch_input_path  <span class="op">=</span> <span class="va">batch_input_path</span>,</span>
<span>        batch_output_path <span class="op">=</span> <span class="va">batch_output_path</span>,</span>
<span>        poll              <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        temperature       <span class="op">=</span> <span class="va">temperature_arg</span>,</span>
<span>        include_raw       <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">jobs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        template_id       <span class="op">=</span> <span class="va">template_id</span>,</span>
<span>        provider          <span class="op">=</span> <span class="va">provider</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        thinking          <span class="op">=</span> <span class="va">thinking</span>,</span>
<span>        direction         <span class="op">=</span> <span class="va">direction</span>,</span>
<span>        prefix            <span class="op">=</span> <span class="va">prefix</span>,</span>
<span>        batch_type        <span class="op">=</span> <span class="st">"anthropic"</span>,</span>
<span>        batch_id          <span class="op">=</span> <span class="va">pipeline</span><span class="op">$</span><span class="va">batch</span><span class="op">$</span><span class="va">id</span>,</span>
<span>        batch_input_path  <span class="op">=</span> <span class="va">pipeline</span><span class="op">$</span><span class="va">batch_input_path</span>,</span>
<span>        batch_output_path <span class="op">=</span> <span class="va">batch_output_path</span>,</span>
<span>        csv_path          <span class="op">=</span> <span class="va">csv_path</span>,</span>
<span>        done              <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        results           <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">provider</span>, <span class="st">"gemini"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># Gemini: typically use low-level helpers, as in the dev scripts</span></span>
<span>      <span class="va">req_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_gemini_batch_requests.html">build_gemini_batch_requests</a></span><span class="op">(</span></span>
<span>        pairs             <span class="op">=</span> <span class="va">pairs_use</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        trait_name        <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">name</span>,</span>
<span>        trait_description <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">description</span>,</span>
<span>        prompt_template   <span class="op">=</span> <span class="va">tmpl_string</span>,</span>
<span>        thinking_level    <span class="op">=</span> <span class="st">"low"</span>, <span class="co"># example</span></span>
<span>        include_thoughts  <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gemini_create_batch.html">gemini_create_batch</a></span><span class="op">(</span></span>
<span>        requests    <span class="op">=</span> <span class="va">req_tbl</span><span class="op">$</span><span class="va">request</span>,</span>
<span>        model       <span class="op">=</span> <span class="va">model</span>,</span>
<span>        api_key     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.getenv.html" class="external-link">Sys.getenv</a></span><span class="op">(</span><span class="st">"GEMINI_API_KEY"</span><span class="op">)</span>,</span>
<span>        api_version <span class="op">=</span> <span class="st">"v1beta"</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">batch_name</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">name</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>        <span class="st">"Gemini batch did not return a `name` field."</span>,</span>
<span>        call. <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>      <span class="op">)</span></span>
<span></span>
<span>      <span class="va">jobs</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1L</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        template_id       <span class="op">=</span> <span class="va">template_id</span>,</span>
<span>        provider          <span class="op">=</span> <span class="va">provider</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        thinking          <span class="op">=</span> <span class="va">thinking</span>,</span>
<span>        direction         <span class="op">=</span> <span class="va">direction</span>,</span>
<span>        prefix            <span class="op">=</span> <span class="va">prefix</span>,</span>
<span>        batch_type        <span class="op">=</span> <span class="st">"gemini"</span>,</span>
<span>        batch_id          <span class="op">=</span> <span class="va">batch_name</span>,</span>
<span>        batch_input_path  <span class="op">=</span> <span class="va">batch_input_path</span>,</span>
<span>        batch_output_path <span class="op">=</span> <span class="va">batch_output_path</span>,</span>
<span>        csv_path          <span class="op">=</span> <span class="va">csv_path</span>,</span>
<span>        done              <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>        results           <span class="op">=</span> <span class="cn">NULL</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level3">
<h3 id="writing-a-batch-registry-csv-important">5.1 Writing a Batch Registry CSV (Important!)<a class="anchor" aria-label="anchor" href="#writing-a-batch-registry-csv-important"></a>
</h3>
<p>To avoid losing batch IDs if your session dies, write a compact index
of all jobs to disk:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jobs_tbl</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  idx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">jobs</span><span class="op">)</span>,</span>
<span>  template_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"template_id"</span><span class="op">)</span>,</span>
<span>  provider <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"provider"</span><span class="op">)</span>,</span>
<span>  model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"model"</span><span class="op">)</span>,</span>
<span>  thinking <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"thinking"</span><span class="op">)</span>,</span>
<span>  direction <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"direction"</span><span class="op">)</span>,</span>
<span>  prefix <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"prefix"</span><span class="op">)</span>,</span>
<span>  batch_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"batch_type"</span><span class="op">)</span>,</span>
<span>  batch_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"batch_id"</span><span class="op">)</span>,</span>
<span>  batch_input_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"batch_input_path"</span><span class="op">)</span>,</span>
<span>  batch_output_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"batch_output_path"</span><span class="op">)</span>,</span>
<span>  csv_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"csv_path"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">jobs_index_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"batch_jobs_index.csv"</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">jobs_tbl</span>, <span class="va">jobs_index_path</span><span class="op">)</span></span>
<span></span>
<span><span class="va">jobs_index_path</span></span></code></pre></div>
<p>You can now <strong>stop R</strong> or close RStudio safely — all
critical details are in <code>batch_jobs_index.csv</code>.</p>
</div>
</div>
<div class="section level2">
<h2 id="phase-2-polling-downloading-and-parsing">6. Phase 2: Polling, Downloading, and Parsing<a class="anchor" aria-label="anchor" href="#phase-2-polling-downloading-and-parsing"></a>
</h2>
<p>In a <em>new</em> session, you can:</p>
<ol style="list-style-type: decimal">
<li>Reload the batch index CSV<br>
</li>
<li>Rebuild the <code>jobs</code> list<br>
</li>
<li>Poll providers for batch status<br>
</li>
<li>Download and parse results when complete<br>
</li>
<li>Save per-job CSVs of parsed results</li>
</ol>
<p>First, helper functions for terminal states:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">is_terminal_openai</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">status</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">status</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"completed"</span>, <span class="st">"failed"</span>, <span class="st">"cancelled"</span>, <span class="st">"expired"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">is_terminal_anthropic</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">status</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">status</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ended"</span>, <span class="st">"errored"</span>, <span class="st">"canceled"</span>, <span class="st">"expired"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">is_terminal_gemini</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">state</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SUCCEEDED"</span>, <span class="st">"FAILED"</span>, <span class="st">"CANCELLED"</span>, <span class="st">"EXPIRED"</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Now the polling loop, with a small delay between jobs to reduce 429
(rate limit) risks:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">interval_seconds</span> <span class="op">&lt;-</span> <span class="fl">60</span></span>
<span><span class="va">per_job_delay</span> <span class="op">&lt;-</span> <span class="fl">2</span> <span class="co"># seconds between polling calls</span></span>
<span></span>
<span><span class="co"># Reload batch index</span></span>
<span><span class="va">jobs_index_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"batch_jobs_index.csv"</span><span class="op">)</span></span>
<span><span class="va">jobs_tbl</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">jobs_index_path</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rebuild jobs list skeleton</span></span>
<span><span class="va">jobs</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>  <span class="va">jobs_tbl</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">idx</span>, <span class="va">template_id</span>, <span class="va">provider</span>, <span class="va">model</span>, <span class="va">thinking</span>, <span class="va">direction</span>,</span>
<span>           <span class="va">prefix</span>, <span class="va">batch_type</span>, <span class="va">batch_id</span>,</span>
<span>           <span class="va">batch_input_path</span>, <span class="va">batch_output_path</span>, <span class="va">csv_path</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      template_id       <span class="op">=</span> <span class="va">template_id</span>,</span>
<span>      provider          <span class="op">=</span> <span class="va">provider</span>,</span>
<span>      model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>      thinking          <span class="op">=</span> <span class="va">thinking</span>,</span>
<span>      direction         <span class="op">=</span> <span class="va">direction</span>,</span>
<span>      prefix            <span class="op">=</span> <span class="va">prefix</span>,</span>
<span>      batch_type        <span class="op">=</span> <span class="va">batch_type</span>,</span>
<span>      batch_id          <span class="op">=</span> <span class="va">batch_id</span>,</span>
<span>      batch_input_path  <span class="op">=</span> <span class="va">batch_input_path</span>,</span>
<span>      batch_output_path <span class="op">=</span> <span class="va">batch_output_path</span>,</span>
<span>      csv_path          <span class="op">=</span> <span class="va">csv_path</span>,</span>
<span>      done              <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>      results           <span class="op">=</span> <span class="cn">NULL</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">unfinished</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"done"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unfinished</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Polling "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unfinished</span><span class="op">)</span>, <span class="st">" unfinished batch(es)..."</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="va">unfinished</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">job</span> <span class="op">&lt;-</span> <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">job</span><span class="op">$</span><span class="va">done</span><span class="op">)</span> <span class="kw">next</span></span>
<span></span>
<span>    <span class="va">batch_type</span> <span class="op">&lt;-</span> <span class="va">job</span><span class="op">$</span><span class="va">batch_type</span></span>
<span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">batch_type</span>, <span class="st">"openai"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/openai_get_batch.html">openai_get_batch</a></span><span class="op">(</span><span class="va">job</span><span class="op">$</span><span class="va">batch_id</span><span class="op">)</span></span>
<span>      <span class="va">status</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">status</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"unknown"</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  [OpenAI] "</span>, <span class="va">job</span><span class="op">$</span><span class="va">prefix</span>, <span class="st">" status: "</span>, <span class="va">status</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">is_terminal_openai</span><span class="op">(</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">status</span>, <span class="st">"completed"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="fu"><a href="../reference/openai_download_batch_output.html">openai_download_batch_output</a></span><span class="op">(</span></span>
<span>            batch_id <span class="op">=</span> <span class="va">job</span><span class="op">$</span><span class="va">batch_id</span>,</span>
<span>            path     <span class="op">=</span> <span class="va">job</span><span class="op">$</span><span class="va">batch_output_path</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/parse_openai_batch_output.html">parse_openai_batch_output</a></span><span class="op">(</span><span class="va">job</span><span class="op">$</span><span class="va">batch_output_path</span><span class="op">)</span></span>
<span>          <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">res</span></span>
<span>          <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">job</span><span class="op">$</span><span class="va">csv_path</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"    -&gt; Results written to: "</span>, <span class="va">job</span><span class="op">$</span><span class="va">csv_path</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">done</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">batch_type</span>, <span class="st">"anthropic"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/anthropic_get_batch.html">anthropic_get_batch</a></span><span class="op">(</span><span class="va">job</span><span class="op">$</span><span class="va">batch_id</span><span class="op">)</span></span>
<span>      <span class="va">status</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">processing_status</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"unknown"</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  [Anthropic] "</span>, <span class="va">job</span><span class="op">$</span><span class="va">prefix</span>, <span class="st">" status: "</span>, <span class="va">status</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">is_terminal_anthropic</span><span class="op">(</span><span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">status</span>, <span class="st">"ended"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">output_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/anthropic_download_batch_results.html">anthropic_download_batch_results</a></span><span class="op">(</span></span>
<span>            batch_id    <span class="op">=</span> <span class="va">job</span><span class="op">$</span><span class="va">batch_id</span>,</span>
<span>            output_path <span class="op">=</span> <span class="va">job</span><span class="op">$</span><span class="va">batch_output_path</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/parse_anthropic_batch_output.html">parse_anthropic_batch_output</a></span><span class="op">(</span></span>
<span>            jsonl_path  <span class="op">=</span> <span class="va">output_path</span>,</span>
<span>            tag_prefix  <span class="op">=</span> <span class="st">"&lt;BETTER_SAMPLE&gt;"</span>,</span>
<span>            tag_suffix  <span class="op">=</span> <span class="st">"&lt;/BETTER_SAMPLE&gt;"</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">res</span></span>
<span>          <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">job</span><span class="op">$</span><span class="va">csv_path</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"    -&gt; Results written to: "</span>, <span class="va">job</span><span class="op">$</span><span class="va">csv_path</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">done</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">batch_type</span>, <span class="st">"gemini"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">batch</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gemini_get_batch.html">gemini_get_batch</a></span><span class="op">(</span><span class="va">job</span><span class="op">$</span><span class="va">batch_id</span><span class="op">)</span></span>
<span>      <span class="va">state</span> <span class="op">&lt;-</span> <span class="va">batch</span><span class="op">$</span><span class="va">state</span> <span class="op"><a href="https://rdrr.io/r/base/Control.html" class="external-link">%||%</a></span> <span class="st">"STATE_UNSPECIFIED"</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"  [Gemini] "</span>, <span class="va">job</span><span class="op">$</span><span class="va">prefix</span>, <span class="st">" state: "</span>, <span class="va">state</span><span class="op">)</span></span>
<span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu">is_terminal_gemini</span><span class="op">(</span><span class="va">state</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">state</span>, <span class="st">"SUCCEEDED"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">raw_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/gemini_download_batch_results.html">gemini_download_batch_results</a></span><span class="op">(</span><span class="va">job</span><span class="op">$</span><span class="va">batch_id</span><span class="op">)</span></span>
<span></span>
<span>          <span class="va">res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/parse_gemini_batch_output.html">parse_gemini_batch_output</a></span><span class="op">(</span></span>
<span>            raw_results <span class="op">=</span> <span class="va">raw_res</span>,</span>
<span>            tag_prefix  <span class="op">=</span> <span class="st">"&lt;BETTER_SAMPLE&gt;"</span>,</span>
<span>            tag_suffix  <span class="op">=</span> <span class="st">"&lt;/BETTER_SAMPLE&gt;"</span></span>
<span>          <span class="op">)</span></span>
<span></span>
<span>          <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">results</span> <span class="op">&lt;-</span> <span class="va">res</span></span>
<span>          <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">job</span><span class="op">$</span><span class="va">csv_path</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"    -&gt; Results written to: "</span>, <span class="va">job</span><span class="op">$</span><span class="va">csv_path</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>        <span class="va">jobs</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">done</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">per_job_delay</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">unfinished</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"done"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unfinished</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Sleeping "</span>, <span class="va">interval_seconds</span>, <span class="st">" seconds before next poll..."</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="va">interval_seconds</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"All batches have reached a terminal state."</span><span class="op">)</span></span></code></pre></div>
<p>At the end of this loop:</p>
<ul>
<li>All completed batches have their outputs downloaded.</li>
<li>Each job has a parsed results CSV (<code>csv_path</code>).</li>
<li>You can now perform consistency and positional-bias analyses, or fit
BT/Elo models.</li>
</ul>
</div>
<div class="section level2">
<h2 id="resuming-after-interruption">7. Resuming After Interruption<a class="anchor" aria-label="anchor" href="#resuming-after-interruption"></a>
</h2>
<p>If the polling loop is interrupted:</p>
<ol style="list-style-type: decimal">
<li>Restart R.</li>
<li>Reload <code>batch_jobs_index.csv</code>.</li>
<li>Rebuild <code>jobs</code> as above.</li>
<li>Recompute <code>unfinished</code> and re-enter the polling
loop.</li>
</ol>
<p>Because all of the essential metadata (provider, model, template,
direction, batch IDs, file paths) is stored in the registry CSV, you can
safely recover and continue.</p>
<p>For example:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">jobs_index_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_dir</span>, <span class="st">"batch_jobs_index.csv"</span><span class="op">)</span></span>
<span><span class="va">jobs_tbl</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">jobs_index_path</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Rebuild jobs list as before...</span></span>
<span><span class="co"># Then:</span></span>
<span><span class="va">unfinished</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">jobs</span>, <span class="va">`[[`</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>, <span class="st">"done"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unfinished</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Resuming polling for "</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">unfinished</span><span class="op">)</span>, <span class="st">" unfinished batch(es)."</span><span class="op">)</span></span>
<span>  <span class="co"># ... re-enter the polling loop ...</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"All jobs are already complete."</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="next-steps">8. Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<p>Once you have per-job results CSVs (e.g., one per template × model ×
thinking × direction), you can:</p>
<ul>
<li>Compute <strong>reverse consistency</strong> with
<code><a href="../reference/compute_reverse_consistency.html">compute_reverse_consistency()</a></code>
</li>
<li>Analyze <strong>positional bias</strong> with
<code><a href="../reference/check_positional_bias.html">check_positional_bias()</a></code>
</li>
<li>Aggregate results by provider/model/template using standard
<code>dplyr</code> pipelines</li>
<li>Fit <strong>Bradley–Terry</strong> models with
<code><a href="../reference/build_bt_data.html">build_bt_data()</a></code> + <code><a href="../reference/fit_bt_model.html">fit_bt_model()</a></code>
</li>
<li>Fit <strong>Elo</strong> models with <code><a href="../reference/fit_elo_model.html">fit_elo_model()</a></code>
(when <code>EloChoice</code> is installed)</li>
</ul>
</div>
<div class="section level2">
<h2 id="citation">9. Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<blockquote>
<p>Mercer, S. (2025). <em>Advanced: Submitting and Polling Multiple
Batches</em> (Version 1.0.0) [R package vignette]. In <em>pairwiseLLM:
Pairwise Comparison Tools for Large Language Model-Based Writing
Evaluation</em>. <a href="https://shmercer.github.io/pairwiseLLM/" class="uri">https://shmercer.github.io/pairwiseLLM/</a></p>
</blockquote>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sterett H. Mercer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
