<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Advanced: Submitting and Polling Multiple Batches • pairwiseLLM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Inter-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Advanced: Submitting and Polling Multiple Batches">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pairwiseLLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-usage-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Usage Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-usage-guides">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with pairwiseLLM</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-batch-workflows.html">Advanced: Submitting and Polling Multiple Batches</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-adaptive-pairing" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Adaptive Pairing</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-adaptive-pairing">
<li><a class="dropdown-item" href="../articles/adaptive-pairing.html">⭐ Adaptive Pairing &amp; Ranking (Tutorial)</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian-btl-adaptive-pairing-design.html">Design: Bayesian BTL + Adaptive Pairing (v3.1)</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/prompt-template-bias.html">Template Positional Bias</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/shmercer/pairwiseLLM" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Advanced: Submitting and Polling Multiple Batches</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shmercer/pairwiseLLM/blob/master/vignettes/advanced-batch-workflows.Rmd" class="external-link"><code>vignettes/advanced-batch-workflows.Rmd</code></a></small>
      <div class="d-none name"><code>advanced-batch-workflows.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="overview">1. Overview<a class="anchor" aria-label="anchor" href="#overview"></a>
</h2>
<p>This vignette demonstrates how to use <strong>pairwiseLLM</strong>
for <strong>Batch API workflows</strong> (server-side batching), which
are distinct from the live API calls described in the <a href="https://shmercer.github.io/pairwiseLLM/articles/getting-started.html">Getting
Started</a> vignette.</p>
<p>Batch workflows are ideal for large-scale jobs because they:</p>
<ul>
<li>Allow submitting thousands of pairs at once<br>
</li>
<li>Are often cheaper (e.g., discounted batch pricing on some
providers)<br>
</li>
<li>Avoid client-side timeout and connection issues<br>
</li>
<li>Can be polled and resumed even if your local R session ends</li>
</ul>
<p>Supported Batch API providers:</p>
<ul>
<li>
<strong>OpenAI</strong> (batch pipeline:
<code><a href="../reference/run_openai_batch_pipeline.html">run_openai_batch_pipeline()</a></code>)</li>
<li>
<strong>Anthropic</strong> (batch pipeline:
<code><a href="../reference/run_anthropic_batch_pipeline.html">run_anthropic_batch_pipeline()</a></code>)</li>
<li>
<strong>Gemini</strong> (batch pipeline:
<code><a href="../reference/run_gemini_batch_pipeline.html">run_gemini_batch_pipeline()</a></code>)</li>
</ul>
<blockquote>
<p><strong>Recommended approach:</strong> For <em>multiple</em> batches
(e.g., templates × providers × models × forward/reverse), use:</p>
<ul>
<li>
<code><a href="../reference/llm_submit_pairs_multi_batch.html">llm_submit_pairs_multi_batch()</a></code> to <strong>split +
submit</strong> jobs (no polling; writes an optional registry CSV)</li>
<li>
<code><a href="../reference/llm_resume_multi_batches.html">llm_resume_multi_batches()</a></code> to <strong>poll + download +
parse</strong> results (can resume from a registry on disk)</li>
</ul>
<p>These helpers orchestrate the provider-specific pipelines without
forcing you to write your own polling loops.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong> <strong>Together.ai</strong> and
<strong>Ollama</strong> do not currently support a native Batch API
compatible with this workflow. For those providers, use the
<strong>live</strong> API wrapper <code><a href="../reference/submit_llm_pairs.html">submit_llm_pairs()</a></code> as
described in the <a href="https://shmercer.github.io/pairwiseLLM/articles/getting-started.html">Getting
Started</a> vignette.</p>
</blockquote>
<p>In this vignette, we will cover:</p>
<ul>
<li>Designing a grid of provider/model/thinking/direction
combinations</li>
<li>Submitting <em>many</em> batch jobs using the multi-batch
helpers</li>
<li>Polling and resuming safely via on-disk registries</li>
<li>Producing per-run and merged results tables</li>
</ul>
<blockquote>
<p>Note: All heavy API calls in this vignette are set to
<code>eval = FALSE</code> so that the vignette remains CRAN-safe. You
can enable them in your own project.</p>
</blockquote>
<p>For basic function usage, see the companion vignette:</p>
<ul>
<li><a href="https://shmercer.github.io/pairwiseLLM/articles/getting-started.html"><code>vignette("getting-started")</code></a></li>
</ul>
<p>For prompt evaluation and positional-bias diagnostics, see the
companion vignette:</p>
<ul>
<li><a href="https://shmercer.github.io/pairwiseLLM/articles/prompt-template-bias.html"><code>vignette("prompt-template-bias")</code></a></li>
</ul>
</div>
<div class="section level2">
<h2 id="setup-and-api-keys">2. Setup and API Keys<a class="anchor" aria-label="anchor" href="#setup-and-api-keys"></a>
</h2>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/shmercer/pairwiseLLM" class="external-link">pairwiseLLM</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://readr.tidyverse.org" class="external-link">readr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://stringr.tidyverse.org" class="external-link">stringr</a></span><span class="op">)</span></span></code></pre></div>
<p>Required environment variables:</p>
<table class="table">
<thead><tr class="header">
<th>Provider</th>
<th>Environment Variable</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>OpenAI</td>
<td><code>OPENAI_API_KEY</code></td>
</tr>
<tr class="even">
<td>Anthropic</td>
<td><code>ANTHROPIC_API_KEY</code></td>
</tr>
<tr class="odd">
<td>Gemini</td>
<td><code>GEMINI_API_KEY</code></td>
</tr>
</tbody>
</table>
<p>Check which are set:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/check_llm_api_keys.html">check_llm_api_keys</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">#&gt; No LLM API keys are currently set for known backends:</span></span>
<span><span class="co">#&gt;   - OpenAI:         OPENAI_API_KEY</span></span>
<span><span class="co">#&gt;   - Anthropic:      ANTHROPIC_API_KEY</span></span>
<span><span class="co">#&gt;   - Google Gemini:  GEMINI_API_KEY</span></span>
<span><span class="co">#&gt;   - Together.ai:    TOGETHER_API_KEY</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Use `usethis::edit_r_environ()` to add the keys persistently, e.g.:</span></span>
<span><span class="co">#&gt;   OPENAI_API_KEY    = "YOUR_OPENAI_KEY_HERE"</span></span>
<span><span class="co">#&gt;   ANTHROPIC_API_KEY = "YOUR_ANTHROPIC_KEY_HERE"</span></span>
<span><span class="co">#&gt;   GEMINI_API_KEY    = "YOUR_GEMINI_KEY_HERE"</span></span>
<span><span class="co">#&gt;   TOGETHER_API_KEY  = "YOUR_TOGETHER_KEY_HERE"</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 4</span></span></span>
<span><span class="co">#&gt;   backend   service       env_var           has_key</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> openai    OpenAI        OPENAI_API_KEY    FALSE  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> anthropic Anthropic     ANTHROPIC_API_KEY FALSE  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> gemini    Google Gemini GEMINI_API_KEY    FALSE  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> together  Together.ai   TOGETHER_API_KEY  FALSE</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example-data-and-prompt-template">3. Example Data and Prompt Template<a class="anchor" aria-label="anchor" href="#example-data-and-prompt-template"></a>
</h2>
<p>We use the built-in writing samples and a single trait
(<code>overall_quality</code>).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"example_writing_samples"</span>, package <span class="op">=</span> <span class="st">"pairwiseLLM"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/trait_description.html">trait_description</a></span><span class="op">(</span><span class="st">"overall_quality"</span><span class="op">)</span></span>
<span><span class="va">td</span></span>
<span><span class="co">#&gt; $name</span></span>
<span><span class="co">#&gt; [1] "Overall Quality"</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $description</span></span>
<span><span class="co">#&gt; [1] "Overall quality of the writing, considering how well ideas are expressed,\n      how clearly the writing is organized, and how effective the language and\n      conventions are."</span></span></code></pre></div>
<p>Default prompt template:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tmpl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_prompt_template.html">set_prompt_template</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">tmpl</span>, <span class="fl">1</span>, <span class="fl">400</span><span class="op">)</span>, <span class="st">"...</span></span>
<span><span class="st">"</span><span class="op">)</span></span>
<span><span class="co">#&gt; You are a debate adjudicator. Your task is to weigh the comparative strengths of two writing samples regarding a specific trait.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; TRAIT: {TRAIT_NAME}</span></span>
<span><span class="co">#&gt; DEFINITION: {TRAIT_DESCRIPTION}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; SAMPLES:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === SAMPLE_1 ===</span></span>
<span><span class="co">#&gt; {SAMPLE_1}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; === SAMPLE_2 ===</span></span>
<span><span class="co">#&gt; {SAMPLE_2}</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; EVALUATION PROCESS (Mental Simulation):</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; 1.  **Advocate for SAMPLE_1**: Mentally list the single strongest point of evidence that makes SAMPLE_1 the  ...</span></span></code></pre></div>
<p>Construct a modest number of pairs to keep the example light:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pairs_all</span> <span class="op">&lt;-</span> <span class="va">example_writing_samples</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/make_pairs.html">make_pairs</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">40L</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pairs_all</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pairs_forward</span> <span class="op">&lt;-</span> <span class="va">pairs_all</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/sample_pairs.html">sample_pairs</a></span><span class="op">(</span>n_pairs <span class="op">=</span> <span class="va">n_pairs</span>, seed <span class="op">=</span> <span class="fl">123</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/randomize_pair_order.html">randomize_pair_order</a></span><span class="op">(</span>seed <span class="op">=</span> <span class="fl">456</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pairs_reverse</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sample_reverse_pairs.html">sample_reverse_pairs</a></span><span class="op">(</span></span>
<span>  <span class="va">pairs_forward</span>,</span>
<span>  reverse_pct <span class="op">=</span> <span class="fl">1.0</span>,</span>
<span>  seed        <span class="op">=</span> <span class="fl">789</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">get_pairs_for_direction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">direction</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"forward"</span>, <span class="st">"reverse"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">direction</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.arg.html" class="external-link">match.arg</a></span><span class="op">(</span><span class="va">direction</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">direction</span>, <span class="st">"forward"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pairs_forward</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">pairs_reverse</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="designing-the-batch-grid">4. Designing the Batch Grid<a class="anchor" aria-label="anchor" href="#designing-the-batch-grid"></a>
</h2>
<p>Suppose we want to test several prompt templates across:</p>
<ul>
<li>Anthropic models (with/without “thinking”)</li>
<li>OpenAI models (with/without “thinking” for specific models)</li>
<li>Gemini models (with “thinking” enabled)</li>
</ul>
<p>Here we define a small grid:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">anthropic_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"claude-sonnet-4-5"</span>,</span>
<span>  <span class="st">"claude-haiku-4-5"</span>,</span>
<span>  <span class="st">"claude-opus-4-5"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gemini_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"gemini-3-pro-preview"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">openai_models</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  <span class="st">"gpt-4.1"</span>,</span>
<span>  <span class="st">"gpt-4o"</span>,</span>
<span>  <span class="st">"gpt-5.1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">thinking_levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"no_thinking"</span>, <span class="st">"with_thinking"</span><span class="op">)</span></span>
<span><span class="va">directions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"forward"</span>, <span class="st">"reverse"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">anthropic_grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  provider  <span class="op">=</span> <span class="st">"anthropic"</span>,</span>
<span>  model     <span class="op">=</span> <span class="va">anthropic_models</span>,</span>
<span>  thinking  <span class="op">=</span> <span class="va">thinking_levels</span>,</span>
<span>  direction <span class="op">=</span> <span class="va">directions</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">gemini_grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  provider  <span class="op">=</span> <span class="st">"gemini"</span>,</span>
<span>  model     <span class="op">=</span> <span class="va">gemini_models</span>,</span>
<span>  thinking  <span class="op">=</span> <span class="st">"with_thinking"</span>,</span>
<span>  direction <span class="op">=</span> <span class="va">directions</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">openai_grid</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand_grid.html" class="external-link">expand_grid</a></span><span class="op">(</span></span>
<span>  provider  <span class="op">=</span> <span class="st">"openai"</span>,</span>
<span>  model     <span class="op">=</span> <span class="va">openai_models</span>,</span>
<span>  thinking  <span class="op">=</span> <span class="va">thinking_levels</span>,</span>
<span>  direction <span class="op">=</span> <span class="va">directions</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="co"># For example, only allow "with_thinking" for gpt-5.1</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">model</span> <span class="op">==</span> <span class="st">"gpt-5.1"</span> <span class="op">|</span> <span class="va">thinking</span> <span class="op">==</span> <span class="st">"no_thinking"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_grid</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="va">anthropic_grid</span>,</span>
<span>  <span class="va">gemini_grid</span>,</span>
<span>  <span class="va">openai_grid</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">batch_grid</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 22 × 4</span></span></span>
<span><span class="co">#&gt;    provider  model             thinking      direction</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span> anthropic claude-sonnet-4-5 no_thinking   forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span> anthropic claude-sonnet-4-5 no_thinking   reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span> anthropic claude-sonnet-4-5 with_thinking forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span> anthropic claude-sonnet-4-5 with_thinking reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span> anthropic claude-haiku-4-5  no_thinking   forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span> anthropic claude-haiku-4-5  no_thinking   reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span> anthropic claude-haiku-4-5  with_thinking forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span> anthropic claude-haiku-4-5  with_thinking reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span> anthropic claude-opus-4-5   no_thinking   forward  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span> anthropic claude-opus-4-5   no_thinking   reverse  </span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 12 more rows</span></span></span></code></pre></div>
<p>We will also imagine multiple prompt templates have been registered.
For simplicity, we use the same <code>tmpl</code> string, but in
practice you would substitute different text:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">templates_tbl</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  template_id     <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"test1"</span>, <span class="st">"test2"</span>, <span class="st">"test3"</span>, <span class="st">"test4"</span>, <span class="st">"test5"</span><span class="op">)</span>,</span>
<span>  prompt_template <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">tmpl</span>, <span class="va">tmpl</span>, <span class="va">tmpl</span>, <span class="va">tmpl</span>, <span class="va">tmpl</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">templates_tbl</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 5 × 2</span></span></span>
<span><span class="co">#&gt;   template_id prompt_template</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>         </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> test1       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> test2       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> test3       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> test4       <span style="color: #949494;">&lt;chr [1]&gt;</span>      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> test5       <span style="color: #949494;">&lt;chr [1]&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="submitting-many-batches-with-the-multibatch-helpers">5. Submitting Many Batches with the Multi‑Batch Helpers<a class="anchor" aria-label="anchor" href="#submitting-many-batches-with-the-multibatch-helpers"></a>
</h2>
<p>The key idea is:</p>
<ul>
<li>Each <strong>combination</strong> of
<code>(template_id, provider, model, thinking, direction)</code> becomes
a <strong>run</strong>
</li>
<li>Each run writes its files into its own subdirectory (so file names
never collide)</li>
<li>Within each run you can still split into multiple segments using
<code>batch_size</code> or <code>n_segments</code>
</li>
</ul>
<div class="section level3">
<h3 id="create-a-run-plan-and-output-directory">5.1 Create a run plan and output directory<a class="anchor" aria-label="anchor" href="#create-a-run-plan-and-output-directory"></a>
</h3>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out_root</span> <span class="op">&lt;-</span> <span class="st">"dev-output/advanced-multi-batch"</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/files2.html" class="external-link">dir.create</a></span><span class="op">(</span><span class="va">out_root</span>, recursive <span class="op">=</span> <span class="cn">TRUE</span>, showWarnings <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">run_plan</span> <span class="op">&lt;-</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/expand.html" class="external-link">crossing</a></span><span class="op">(</span></span>
<span>  <span class="va">templates_tbl</span> <span class="op">|&gt;</span> <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">prompt_template</span><span class="op">)</span>,</span>
<span>  <span class="va">batch_grid</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    run_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">template_id</span>, <span class="va">provider</span>, <span class="va">model</span>, <span class="va">thinking</span>, <span class="va">direction</span>, sep <span class="op">=</span> <span class="st">"__"</span><span class="op">)</span>,</span>
<span>    run_id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"[^A-Za-z0-9_.-]+"</span>, <span class="st">"-"</span>, <span class="va">run_id</span><span class="op">)</span>,</span>
<span>    run_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_root</span>, <span class="va">run_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="va">run_plan</span> <span class="op">|&gt;</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">run_id</span>, <span class="va">template_id</span>, <span class="va">provider</span>, <span class="va">model</span>, <span class="va">thinking</span>, <span class="va">direction</span>, <span class="va">run_dir</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="submit-all-runs-no-polling">5.2 Submit all runs (no polling)<a class="anchor" aria-label="anchor" href="#submit-all-runs-no-polling"></a>
</h3>
<p>Below we submit each run using
<code><a href="../reference/llm_submit_pairs_multi_batch.html">llm_submit_pairs_multi_batch()</a></code>. This returns a
<code>jobs</code> list and writes a <code>jobs_registry.csv</code> under
each run directory (because <code>write_registry = TRUE</code>).</p>
<p>Provider-specific options can be forwarded via <code>...</code>. In
the example below we:</p>
<ul>
<li>Enable “thinking” output where applicable</li>
<li>Ask providers to include raw outputs in addition to parsed tags
(helpful for debugging)</li>
</ul>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">submit_one_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">template_id</span>, <span class="va">prompt_template</span>, <span class="va">provider</span>, <span class="va">model</span>, <span class="va">thinking</span>, <span class="va">direction</span>, <span class="va">run_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pairs_use</span>   <span class="op">&lt;-</span> <span class="fu">get_pairs_for_direction</span><span class="op">(</span><span class="va">direction</span><span class="op">)</span></span>
<span>  <span class="va">is_thinking</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">thinking</span>, <span class="st">"with_thinking"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Provider-specific knobs (passed through via ...)</span></span>
<span>  <span class="va">extra_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">provider</span>, <span class="st">"openai"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Only request thoughts for models that support them in this workflow</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">include_thoughts</span> <span class="op">&lt;-</span> <span class="va">is_thinking</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"^gpt-5\\.1"</span>, <span class="va">model</span><span class="op">)</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">include_raw</span>      <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">provider</span>, <span class="st">"anthropic"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">reasoning</span>        <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">is_thinking</span><span class="op">)</span> <span class="st">"enabled"</span> <span class="kw">else</span> <span class="st">"none"</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">include_thoughts</span> <span class="op">&lt;-</span> <span class="va">is_thinking</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">include_raw</span>      <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="co"># Optional: set deterministic temperature when not using reasoning</span></span>
<span>    <span class="co"># Optional: set deterministic temperature when not using reasoning</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">is_thinking</span><span class="op">)</span> <span class="va">extra_args</span><span class="op">$</span><span class="va">temperature</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">provider</span>, <span class="st">"gemini"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">include_thoughts</span> <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">thinking_level</span>   <span class="op">&lt;-</span> <span class="st">"low"</span>   <span class="co"># example</span></span>
<span>    <span class="va">extra_args</span><span class="op">$</span><span class="va">include_raw</span>      <span class="op">&lt;-</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span></span>
<span>    <span class="st">"Submitting: "</span>, <span class="va">template_id</span>, <span class="st">" | "</span>, <span class="va">provider</span>, <span class="st">" / "</span>, <span class="va">model</span>,</span>
<span>    <span class="st">" / "</span>, <span class="va">thinking</span>, <span class="st">" / "</span>, <span class="va">direction</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># Split strategy:</span></span>
<span>  <span class="co"># - For real jobs, use batch_size (e.g., 500–5000) or n_segments (e.g., 10–50)</span></span>
<span>  <span class="co"># - Here we keep it simple and submit a single segment per run</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span></span>
<span>    <span class="va">llm_submit_pairs_multi_batch</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>        pairs             <span class="op">=</span> <span class="va">pairs_use</span>,</span>
<span>        backend           <span class="op">=</span> <span class="va">provider</span>,</span>
<span>        model             <span class="op">=</span> <span class="va">model</span>,</span>
<span>        trait_name        <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">name</span>,</span>
<span>        trait_description <span class="op">=</span> <span class="va">td</span><span class="op">$</span><span class="va">description</span>,</span>
<span>        prompt_template   <span class="op">=</span> <span class="va">prompt_template</span>,</span>
<span>        n_segments        <span class="op">=</span> <span class="fl">1L</span>,</span>
<span>        output_dir        <span class="op">=</span> <span class="va">run_dir</span>,</span>
<span>        write_registry    <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>        verbose           <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>      <span class="op">)</span>,</span>
<span>      <span class="va">extra_args</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">run_results</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap</a></span><span class="op">(</span></span>
<span>  <span class="va">run_plan</span>,</span>
<span>  <span class="va">submit_one_run</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Store a lightweight manifest so you can resume later without rebuilding run_plan</span></span>
<span><span class="va">manifest</span> <span class="op">&lt;-</span> <span class="va">run_plan</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>registry_path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">run_dir</span>, <span class="st">"jobs_registry.csv"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">manifest_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_root</span>, <span class="st">"run_manifest.csv"</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">manifest</span>, <span class="va">manifest_path</span><span class="op">)</span></span>
<span></span>
<span><span class="va">manifest_path</span></span></code></pre></div>
<p>At this point, each run directory contains:</p>
<ul>
<li>JSONL input/output placeholders (one per segment)</li>
<li>A <code>jobs_registry.csv</code> that records all batch IDs and file
paths for that run</li>
</ul>
<p>You can safely stop R or restart your machine after submission.</p>
</div>
</div>
<div class="section level2">
<h2 id="polling-downloading-and-parsing-resumable">6. Polling, Downloading, and Parsing (Resumable)<a class="anchor" aria-label="anchor" href="#polling-downloading-and-parsing-resumable"></a>
</h2>
<p>To poll all runs, read the manifest and call
<code><a href="../reference/llm_resume_multi_batches.html">llm_resume_multi_batches()</a></code> for each <code>run_dir</code>.
If you restart R, you can resume <strong>without</strong> keeping the
<code>jobs</code> objects in memory by setting <code>jobs = NULL</code>
and pointing to <code>output_dir</code> (the function will load
<code>jobs_registry.csv</code>).</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manifest_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_root</span>, <span class="st">"run_manifest.csv"</span><span class="op">)</span></span>
<span><span class="va">manifest</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">manifest_path</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">poll_one_run</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">run_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/llm_resume_multi_batches.html">llm_resume_multi_batches</a></span><span class="op">(</span></span>
<span>    jobs               <span class="op">=</span> <span class="cn">NULL</span>,   <span class="co"># load from jobs_registry.csv in run_dir</span></span>
<span>    output_dir         <span class="op">=</span> <span class="va">run_dir</span>,</span>
<span>    interval_seconds   <span class="op">=</span> <span class="fl">60</span>,</span>
<span>    per_job_delay      <span class="op">=</span> <span class="fl">2</span>,</span>
<span>    write_results_csv  <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co"># writes batch_XX_results.csv files</span></span>
<span>    write_registry     <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co"># refreshes jobs_registry.csv with done flags</span></span>
<span>    keep_jsonl         <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    verbose            <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>    write_combined_csv <span class="op">=</span> <span class="cn">TRUE</span>,   <span class="co"># writes combined_results.csv inside run_dir</span></span>
<span>    combined_csv_path  <span class="op">=</span> <span class="st">"combined_results.csv"</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">polled</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">manifest</span><span class="op">$</span><span class="va">run_dir</span>, <span class="va">poll_one_run</span><span class="op">)</span></span></code></pre></div>
<div class="section level3">
<h3 id="building-a-single-merged-results-table-all-runs">6.1 Building a single merged results table (all runs)<a class="anchor" aria-label="anchor" href="#building-a-single-merged-results-table-all-runs"></a>
</h3>
<p>Each element of <code>polled</code> contains a <code>combined</code>
tibble for that run (i.e., all segments bound together). We can attach
run metadata (template/provider/model/thinking/direction) and then bind
all runs into one master table.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combined_all</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_dfr</a></span><span class="op">(</span></span>
<span>  <span class="va">polled</span>,</span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">manifest</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">res</span>, <span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">meta</span> <span class="op">&lt;-</span> <span class="va">manifest</span><span class="op">[</span><span class="va">i</span>, <span class="op">]</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">res</span><span class="op">$</span><span class="va">combined</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">res</span><span class="op">$</span><span class="va">combined</span> <span class="op">|&gt;</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>        template_id <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">template_id</span>,</span>
<span>        provider    <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">provider</span>,</span>
<span>        model       <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">model</span>,</span>
<span>        thinking    <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">thinking</span>,</span>
<span>        direction   <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">direction</span>,</span>
<span>        run_id      <span class="op">=</span> <span class="va">meta</span><span class="op">$</span><span class="va">run_id</span></span>
<span>      <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_root</span>, <span class="st">"combined_all_runs.csv"</span><span class="op">)</span></span>
<span><span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/write_delim.html" class="external-link">write_csv</a></span><span class="op">(</span><span class="va">combined_all</span>, <span class="va">combined_path</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined_path</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="resuming-after-interruption">7. Resuming After Interruption<a class="anchor" aria-label="anchor" href="#resuming-after-interruption"></a>
</h2>
<p>Resuming jobs is possible:</p>
<ul>
<li>Submission writes <code>jobs_registry.csv</code> under each run
directory</li>
<li>Polling can be restarted at any time by calling
<code>llm_resume_multi_batches(jobs = NULL, output_dir = &lt;run_dir&gt;)</code>
</li>
<li>If you keep a <code>run_manifest.csv</code> with
<code>run_dir</code> paths, resuming <em>all</em> runs is just a
loop</li>
</ul>
<p>Example: resume only unfinished runs (based on each run’s
registry):</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">manifest</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">out_root</span>, <span class="st">"run_manifest.csv"</span><span class="op">)</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">needs_poll</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">run_dir</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">reg_path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">run_dir</span>, <span class="st">"jobs_registry.csv"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.exists</a></span><span class="op">(</span><span class="va">reg_path</span><span class="op">)</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">reg</span> <span class="op">&lt;-</span> <span class="fu">readr</span><span class="fu">::</span><span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html" class="external-link">read_csv</a></span><span class="op">(</span><span class="va">reg_path</span>, show_col_types <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">reg</span><span class="op">$</span><span class="va">done</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">unfinished_dirs</span> <span class="op">&lt;-</span> <span class="va">manifest</span><span class="op">$</span><span class="va">run_dir</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">manifest</span><span class="op">$</span><span class="va">run_dir</span>, <span class="va">needs_poll</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="va">polled</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map</a></span><span class="op">(</span><span class="va">unfinished_dirs</span>, <span class="va">poll_one_run</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="next-steps">8. Next Steps<a class="anchor" aria-label="anchor" href="#next-steps"></a>
</h2>
<p>Once you have per-run results CSVs (e.g., one per template × model ×
thinking × direction), you can:</p>
<ul>
<li>Compute <strong>reverse consistency</strong> with
<code><a href="../reference/compute_reverse_consistency.html">compute_reverse_consistency()</a></code>
</li>
<li>Analyze <strong>positional bias</strong> with
<code><a href="../reference/check_positional_bias.html">check_positional_bias()</a></code>
</li>
<li>Aggregate results by provider/model/template using standard
<code>dplyr</code> pipelines</li>
<li>Fit <strong>Bradley–Terry</strong> models with
<code><a href="../reference/build_bt_data.html">build_bt_data()</a></code> + <code><a href="../reference/fit_bt_model.html">fit_bt_model()</a></code>
</li>
<li>Fit <strong>Elo</strong> models with <code><a href="../reference/fit_elo_model.html">fit_elo_model()</a></code>
(when <code>EloChoice</code> is installed)</li>
</ul>
</div>
<div class="section level2">
<h2 id="citation">9. Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h2>
<blockquote>
<p>Mercer, S. H. (2025). <em>Advanced: Submitting and polling multiple
batches</em> [R package vignette]. In <em>pairwiseLLM: Pairwise
comparison tools for large language model-based writing evaluation</em>.
<a href="https://doi.org/10.32614/CRAN.package.pairwiseLLM" class="external-link uri">https://doi.org/10.32614/CRAN.package.pairwiseLLM</a></p>
</blockquote>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sterett H. Mercer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
