<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Bayesian BTL Adaptive Pairing Design ‚Ä¢ pairwiseLLM</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Inter-0.4.10/font.css" rel="stylesheet">
<link href="../deps/JetBrains_Mono-0.4.10/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Bayesian BTL Adaptive Pairing Design">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">pairwiseLLM</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../index.html"><span class="fa fa-home"></span> Home</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-usage-guides" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Usage Guides</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-usage-guides">
<li><a class="dropdown-item" href="../articles/getting-started.html">Getting Started with pairwiseLLM</a></li>
    <li><a class="dropdown-item" href="../articles/advanced-batch-workflows.html">Advanced: Submitting and Polling Multiple Batches</a></li>
  </ul>
</li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-adaptive-pairing" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Adaptive Pairing</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-adaptive-pairing">
<li><a class="dropdown-item" href="../articles/adaptive-pairing.html">Adaptive Pairing &amp; Ranking</a></li>
    <li><a class="dropdown-item" href="../articles/bayesian-btl-adaptive-pairing-design.html">Design: Bayesian BTL Adaptive Pairing</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../articles/prompt-template-bias.html">Template Positional Bias</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/shmercer/pairwiseLLM" aria-label="GitHub"><span class="fa fa-github"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Bayesian BTL Adaptive Pairing Design</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/shmercer/pairwiseLLM/blob/master/vignettes/bayesian-btl-adaptive-pairing-design.Rmd" class="external-link"><code>vignettes/bayesian-btl-adaptive-pairing-design.Rmd</code></a></small>
      <div class="d-none name"><code>bayesian-btl-adaptive-pairing-design.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="bayesian-btl-adaptive-pairing-design">Bayesian BTL Adaptive Pairing Design<a class="anchor" aria-label="anchor" href="#bayesian-btl-adaptive-pairing-design"></a>
</h2>
<p><strong>Stable Rankings, Robust Inference, and Fully Auditable
Adaptive Sampling</strong></p>
<hr>
<div class="section level3">
<h3 id="scope-and-goals">Scope and Goals<a class="anchor" aria-label="anchor" href="#scope-and-goals"></a>
</h3>
<p>This document specifies a hybrid adaptive paired-comparison design
for ranking <strong>N</strong> items using:</p>
<ol style="list-style-type: decimal">
<li>Online step-by-step pair selection driven by TrueSkill (fast,
uncertainty-aware), and<br>
</li>
<li>Intermittent global inference using Bayesian Bradley‚ÄìTerry‚ÄìLuce
(BTL) MCMC (Stan) for Œ∏ estimates, diagnostics, and stopping.</li>
</ol>
<p>Selection is organized into Pollitt-style rounds that explicitly
balance global scale identification and local refinement. Each round
schedules a fixed number of committed comparisons and allocates them
across four pair types:</p>
<ul>
<li>Rolling anchor links, which connect non-anchor items to a small,
dynamically updated set of reference items to provide high-bandwidth
global calibration;</li>
<li>Long-range links, which connect non-anchor items that are widely
separated in the current ranking to strengthen global connectivity;</li>
<li>Mid-range links, which connect moderately separated items to
stabilize scale structure; and</li>
<li>Local refinement links, which compare nearby items to improve
fine-grained ordering.</li>
</ul>
<p>Pair selection operates step-by-step within this round structure. At
each step, candidate pairs are generated according to the active round
stage and passed through a canonical selection pipeline that enforces
hard invariants, duplicate controls, star caps, and
exploration‚Äìexploitation routing. Pair utility is evaluated using a fast
online selection heuristic, while Bayesian Bradley‚ÄìTerry‚ÄìLuce inference
is used exclusively for estimating latent scores (Œ∏), diagnostics, and
stopping decisions.</p>
<p>The design supports: * 30 ‚â§ N ‚â§ 2000 items, with mechanisms that
scale to large N through percentile-based strata and bounded candidate
sets; * a single judge producing binary outcomes (no ties); and * fully
auditable logs at the step, round, and refit levels.</p>
<p>By explicitly budgeting comparisons that promote global linking while
retaining locally informative comparisons, the design aims to achieve
rapid global identifiability of the latent scale together with efficient
local discrimination.</p>
<hr>
</div>
<div class="section level3">
<h3 id="user-facing-overview">User-facing overview<a class="anchor" aria-label="anchor" href="#user-facing-overview"></a>
</h3>
<p>For a practical tutorial using <code><a href="../reference/adaptive_rank.html">adaptive_rank()</a></code>, see:</p>
<ul>
<li><a href="adaptive-pairing.html">Adaptive Pairing &amp;
Ranking</a></li>
</ul>
<hr>
</div>
<div class="section level3">
<h3 id="global-definitions-normative">Global Definitions (normative)<a class="anchor" aria-label="anchor" href="#global-definitions-normative"></a>
</h3>
<div class="section level4">
<h4 id="indices">Indices<a class="anchor" aria-label="anchor" href="#indices"></a>
</h4>
<ul>
<li>
<strong>Step</strong>: one attempted selection and (if valid) one
committed comparison.</li>
<li>
<strong>Pair (committed comparison)</strong>: a step that produced a
valid judge outcome and was committed.</li>
</ul>
</div>
<div class="section level4">
<h4 id="counts-and-keys">Counts and keys<a class="anchor" aria-label="anchor" href="#counts-and-keys"></a>
</h4>
<ul>
<li>
<code>pair_obs_count[{i,j}]</code>: number of
<strong>committed</strong> comparisons observed for unordered endpoints
<code>{i,j}</code>.</li>
<li>
<code>pair_obs_count_ordered[(A,B)]</code>: number of committed
comparisons observed with ordered presentation <code>(A,B)</code>. Keyed
by ordered endpoint ids (e.g., (i,j)), not by rank positions.</li>
<li>
<code>pair_key(i,j)</code>: canonical unordered key with
<code>i&lt;j</code> (implementation note: stable string or integer
hash).</li>
</ul>
</div>
<div class="section level4">
<h4 id="ordering-precedence">Ordering precedence<a class="anchor" aria-label="anchor" href="#ordering-precedence"></a>
</h4>
<p>When constraints conflict, apply this priority order:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Hard invariants</strong> (self-pairs forbidden;
transactional commit; order-reversal on repeats)</li>
<li><strong>Duplicate policy</strong></li>
<li><strong>Star caps</strong></li>
<li><strong>Exploration / quota routing</strong></li>
<li>
<strong>Position-balance preference</strong> (best-effort; never a
hard filter)</li>
</ol>
<p>This prevents deadlocks and ensures deterministic behavior across
implementations.</p>
</div>
<div class="section level4">
<h4 id="terminology-note-normative">Terminology note (normative)<a class="anchor" aria-label="anchor" href="#terminology-note-normative"></a>
</h4>
<p>This design distinguishes between:</p>
<ul>
<li>
<strong>Rounds</strong> (<code>round_id</code>): Pollitt-style
scheduling units that allocate a fixed number of committed comparisons
across pair types.</li>
<li>
<strong>Refits</strong> (<code>refit_id</code>): Bayesian BTL
posterior updates triggered by accumulated committed comparisons.</li>
</ul>
<p>Rounds occur more frequently than refits. Multiple rounds typically
occur between successive refits.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="statistical-model">1. Statistical Model<a class="anchor" aria-label="anchor" href="#statistical-model"></a>
</h3>
<p>This design supports four closely related Bradley‚ÄìTerry‚ÄìLuce (BTL)
model variants. All variants share the same latent ability parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œ∏</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\theta_i</annotation></semantics></math>
(one per item), and differ only in whether they include:</p>
<ul>
<li>a <strong>global lapse / random‚Äëresponse rate</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œµ</mi><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math>
(‚Äúsometimes the judge answers at random‚Äù), and/or</li>
<li>a <strong>global position bias</strong>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
(‚Äúthe judge slightly prefers the item shown in position A /
first‚Äù).</li>
</ul>
<p><strong>Default (recommended):</strong> <strong>BT + position bias +
lapse</strong> (Model D).<br>
Use simpler variants only when you have a reason (e.g., you are certain
there is no position effect, or you want the minimal model).</p>
<hr>
<div class="section level4">
<h4 id="notation-common-to-all-variants">1.1 Notation (common to all variants)<a class="anchor" aria-label="anchor" href="#notation-common-to-all-variants"></a>
</h4>
<p>For each comparison
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">k = 1,\dots,M</annotation></semantics></math>:</p>
<ul>
<li>Items are presented in <strong>ordered</strong> positions:
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">A[k]</annotation></semantics></math>
(position A / first) vs
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow><annotation encoding="application/x-tex">B[k]</annotation></semantics></math>
(position B / second).</li>
<li>Outcome:
<ul>
<li>
<code>Y[k] = 1</code> means A wins (the judge chose the first
item)</li>
<li>
<code>Y[k] = 0</code> means B wins (the judge chose the second
item)</li>
</ul>
</li>
</ul>
<p>Define the latent quality difference:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mi>k</mi></msub><mo>=</mo><msub><mi>Œ∏</mi><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>‚àí</mo><msub><mi>Œ∏</mi><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub></mrow><annotation encoding="application/x-tex">
d_k = \theta_{A[k]} - \theta_{B[k]}
</annotation></semantics></math></p>
<p>Define the baseline Bradley‚ÄìTerry win probability:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÄ</mi><mi>k</mi></msub><mo>=</mo><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>d</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\pi_k = \text{logit}^{-1}(d_k)
</annotation></semantics></math></p>
<hr>
</div>
<div class="section level4">
<h4 id="model-options-choose-one">1.2 Model options (choose one)<a class="anchor" aria-label="anchor" href="#model-options-choose-one"></a>
</h4>
<div class="section level5">
<h5 id="model-a-regular-btl-no-lapse-no-position-bias">Model A ‚Äî Regular BTL (no lapse, no position bias)<a class="anchor" aria-label="anchor" href="#model-a-regular-btl-no-lapse-no-position-bias"></a>
</h5>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>k</mi></msub><mo>=</mo><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>‚àí</mo><msub><mi>Œ∏</mi><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p_k = \text{logit}^{-1}(\theta_{A[k]} - \theta_{B[k]})
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>k</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Bernoulli</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
Y_k \sim \text{Bernoulli}(p_k)
</annotation></semantics></math></p>
<p><strong>Interpretation:</strong> the judge‚Äôs choice depends only on
the latent quality difference; all randomness is ‚Äúordinary‚Äù Bernoulli
variation.</p>
<hr>
</div>
<div class="section level5">
<h5 id="model-b-btl-lapse-epsilon">Model B ‚Äî BTL + lapse
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œµ</mi><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math>
)<a class="anchor" aria-label="anchor" href="#model-b-btl-lapse-epsilon"></a>
</h5>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>k</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>œµ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>‚àí</mo><msub><mi>Œ∏</mi><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>œµ</mi><mo>‚ãÖ</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">
p_k = (1-\epsilon)\,\text{logit}^{-1}(\theta_{A[k]} - \theta_{B[k]}) + \epsilon \cdot 0.5
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>k</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Bernoulli</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
Y_k \sim \text{Bernoulli}(p_k)
</annotation></semantics></math></p>
<p><strong>Interpretation:</strong> most of the time the judge follows
Bradley‚ÄìTerry; with probability
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œµ</mi><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math>)
the judge responds like a fair coin‚Äëflip. This single parameter absorbs
occasional random mistakes without complicating the model.</p>
<hr>
</div>
<div class="section level5">
<h5 id="model-c-btl-position-bias-b">Model C ‚Äî BTL + position bias
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>)<a class="anchor" aria-label="anchor" href="#model-c-btl-position-bias-b"></a>
</h5>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>k</mi></msub><mo>=</mo><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>‚àí</mo><msub><mi>Œ∏</mi><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>+</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p_k = \text{logit}^{-1}(\theta_{A[k]} - \theta_{B[k]} + b)
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>k</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Bernoulli</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
Y_k \sim \text{Bernoulli}(p_k)
</annotation></semantics></math></p>
<p><strong>Interpretation:</strong> the judge has a consistent side
preference:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>&gt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">b &gt; 0</annotation></semantics></math>:
favors position A (first)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>&lt;</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">b &lt; 0</annotation></semantics></math>:
favors position B (second)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">b = 0</annotation></semantics></math>:
no position preference</li>
</ul>
<hr>
</div>
<div class="section level5">
<h5 id="model-d-btl-position-bias-lapse-b-epsilon-default">Model D ‚Äî BTL + position bias + lapse
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>,</mo><mi>œµ</mi></mrow><annotation encoding="application/x-tex">b, \epsilon</annotation></semantics></math>)
(<strong>default</strong>)<a class="anchor" aria-label="anchor" href="#model-d-btl-position-bias-lapse-b-epsilon-default"></a>
</h5>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>k</mi></msub><mo>=</mo><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><mi>œµ</mi><mo stretchy="true" form="postfix">)</mo></mrow><mspace width="0.167em"></mspace><msup><mtext mathvariant="normal">logit</mtext><mrow><mo>‚àí</mo><mn>1</mn></mrow></msup><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mrow><mi>A</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>‚àí</mo><msub><mi>Œ∏</mi><mrow><mi>B</mi><mrow><mo stretchy="true" form="prefix">[</mo><mi>k</mi><mo stretchy="true" form="postfix">]</mo></mrow></mrow></msub><mo>+</mo><mi>b</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>œµ</mi><mo>‚ãÖ</mo><mn>0.5</mn></mrow><annotation encoding="application/x-tex">
p_k = (1-\epsilon)\,\text{logit}^{-1}(\theta_{A[k]} - \theta_{B[k]} + b) + \epsilon \cdot 0.5
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mi>k</mi></msub><mo>‚àº</mo><mtext mathvariant="normal">Bernoulli</mtext><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>p</mi><mi>k</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
Y_k \sim \text{Bernoulli}(p_k)
</annotation></semantics></math></p>
<p><strong>Interpretation:</strong> combines both protections:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
accounts for systematic position preference (if present)</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>œµ</mi><annotation encoding="application/x-tex">\epsilon</annotation></semantics></math>
accounts for occasional random responding</li>
</ul>
<p>This is the most robust default when the ‚Äújudge‚Äù is an LLM or other
noisy rater.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="priors-and-identifiability-all-variants">1.3 Priors and identifiability (all variants)<a class="anchor" aria-label="anchor" href="#priors-and-identifiability-all-variants"></a>
</h4>
<ul>
<li>
<p>Raw abilities:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>Œ∏</mi><mi>i</mi><mrow><mi>r</mi><mi>a</mi><mi>w</mi></mrow></msubsup><mo>‚àº</mo><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\theta^{raw}_i \sim \mathcal{N}(0,1)
</annotation></semantics></math></p>
</li>
<li>
<p>Centered abilities (hard identifiability constraint):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>=</mo><msubsup><mi>Œ∏</mi><mi>i</mi><mrow><mi>r</mi><mi>a</mi><mi>w</mi></mrow></msubsup><mo>‚àí</mo><mfrac><mn>1</mn><mi>N</mi></mfrac><munderover><mo>‚àë</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msubsup><mi>Œ∏</mi><mi>j</mi><mrow><mi>r</mi><mi>a</mi><mi>w</mi></mrow></msubsup></mrow><annotation encoding="application/x-tex">
\theta_i = \theta^{raw}_i - \frac{1}{N}\sum_{j=1}^N \theta^{raw}_j
</annotation></semantics></math></p>
<p>Ensuring:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><munderover><mo>‚àë</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></munderover><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">
\sum_{i=1}^N \theta_i = 0
</annotation></semantics></math></p>
</li>
<li>
<p>Lapse parameter (Models B and D):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>œµ</mi><mo>‚àº</mo><mtext mathvariant="normal">Beta</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mn>2</mn><mo>,</mo><mn>20</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\epsilon \sim \text{Beta}(2,20)
</annotation></semantics></math></p>
</li>
<li>
<p>Position bias parameter (Models C and D):</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>b</mi><mo>‚àº</mo><mi>ùí©</mi><mrow><mo stretchy="true" form="prefix">(</mo><mn>0</mn><mo>,</mo><mn>0.3</mn><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
b \sim \mathcal{N}(0, 0.3)
</annotation></semantics></math></p>
</li>
<li>
<p><strong>Interpretation:</strong></p>
<ul>
<li>The normal prior on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œ∏</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>
fixes the latent scale; centering removes additive indeterminacy.</li>
<li>The Beta prior reflects that random responses are expected to be
rare but non‚Äëzero.<br>
</li>
<li>The Normal prior on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
is weakly informative: it allows mild position bias while shrinking
extreme bias toward zero.</li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section level3">
<h3 id="data-structures-and-invariants">2. Data Structures and Invariants<a class="anchor" aria-label="anchor" href="#data-structures-and-invariants"></a>
</h3>
<div class="section level4">
<h4 id="core-stores">2.1 Core Stores<a class="anchor" aria-label="anchor" href="#core-stores"></a>
</h4>
<p>For each comparison
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>1</mn><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><mi>M</mi></mrow><annotation encoding="application/x-tex">k = 1,\dots,M</annotation></semantics></math>:</p>
<ul>
<li>
<code>A[k]</code>, <code>B[k]</code>: item indices (ordered
presentation)</li>
<li>
<code>Y[k]</code>: outcome (1 = A wins, 0 = B wins)</li>
</ul>
<p>Tracking structures (all counts are over committed comparisons
only):</p>
<ul>
<li>
<code>deg[i]</code>: total committed comparisons involving item
<code>i</code>
</li>
<li>
<code>pos_count_A[i]</code>: number of times item <code>i</code>
appears in position A (first) in committed comparisons</li>
<li>
<code>pos_count_B[i]</code>: number of times item <code>i</code>
appears in position B (second) in committed comparisons</li>
</ul>
<p>Pair repetition tracking:</p>
<ul>
<li>
<code>pair_obs_count[{i,j}]</code>: total committed observations of
unordered pair <code>{i,j}</code> (with canonical key
<code>i&lt;j</code>)</li>
<li>
<code>pair_obs_count_ordered[(A,B)]</code>: committed observations
of ordered presentation <code>(A,B)</code>
</li>
<li>
<code>pair_last_order[{i,j}]</code>: ordered presentation
<code>(A,B)</code> used in the most recent <strong>committed</strong>
comparison for unordered pair <code>{i,j}</code> (needed to enforce
order-reversal).</li>
</ul>
<p>Implementation note (normative intent):
<code>pair_obs_count[{i,j}] = pair_obs_count_ordered[(i,j)] + pair_obs_count_ordered[(j,i)]</code>
when <code>i != j</code>.</p>
<blockquote>
<p><strong>Step definition (normative).</strong> The adaptive controller
operates in steps. Each step attempts to select one unordered pair
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{i,j\}</annotation></semantics></math>
for judgment, assigns presentation order
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>,</mo><mi>B</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(A,B)</annotation></semantics></math>,
submits it to the judge, and commits the result transactionally if
valid. TrueSkill is updated immediately after each committed result. If
the judge response is invalid, the step is recorded with
<code>pair_id = NA</code> and no counts are updated.</p>
</blockquote>
<hr>
</div>
<div class="section level4">
<h4 id="hard-invariants">2.2 Hard Invariants<a class="anchor" aria-label="anchor" href="#hard-invariants"></a>
</h4>
<ol style="list-style-type: decimal">
<li>
<p><strong>Warm-start connectivity guarantee</strong> The warm-start
procedure (¬ß3.1) must produce a connected comparison graph over all
items. After warm-start, the graph remains connected because edges are
only added (never removed). Therefore, ‚Äúconnectivity‚Äù is not used as a
per-step candidate filter after warm-start.</p>
<p>Coverage and representation are enforced via:</p>
<ul>
<li>early-phase coverage quota (¬ß3.2), and</li>
<li>star caps (¬ß6.1), and</li>
<li>exploration routing (¬ß7.5).</li>
</ul>
</li>
<li><p><strong>Transactional updates</strong><br>
Comparisons are committed only if the judge returns a valid response. A
judge response is valid iff it deterministically maps to Y ‚àà {0,1} for
the presented (A,B) (i.e., selects exactly one of A or B). Any other
response (missing, malformed, tie, both-selected, refusal/timeout) is
invalid. If the response is invalid or missing, the step is recorded
with <code>pair_id = NA</code>, and no state updates occur: do not
update TrueSkill, <code>deg</code>, <code>pos_count_A/B</code>,
<code>pair_obs_count</code>, or any other counters or logs that are
defined over committed comparisons. Candidate-generation diagnostics for
that step (e.g., <code>n_candidates_generated</code>,
<code>fallback_path</code>) may still be logged, but any fields defined
only for committed comparisons must remain <code>NA</code> and no
committed-comparison state is updated.</p></li>
<li>
<p><strong>Duplicate control with enforced order
reversal</strong></p>
<ul>
<li>Repeated unordered pairs must reverse presentation order.</li>
<li>Additional repeats are allowed only for persistently ambiguous
pairs.</li>
</ul>
</li>
<li><p><strong>Position balance</strong><br>
Approximate 50/50 A/B exposure is enforced <em>after</em> unordered pair
selection, except where order reversal is required by invariant
(3).</p></li>
</ol>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="warmstart-design">3. Warm‚ÄëStart Design<a class="anchor" aria-label="anchor" href="#warmstart-design"></a>
</h3>
<div class="section level4">
<h4 id="shuffled-chain-construction-default">3.1 Shuffled Chain Construction (default)<a class="anchor" aria-label="anchor" href="#shuffled-chain-construction-default"></a>
</h4>
<ol style="list-style-type: decimal">
<li><p>Shuffle item ids using the run RNG seed</p></li>
<li>
<p>Add comparisons:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">[</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><msub><mi>d</mi><mn>1</mn></msub><mo>,</mo><mi>i</mi><msub><mi>d</mi><mn>2</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><msub><mi>d</mi><mn>2</mn></msub><mo>,</mo><mi>i</mi><msub><mi>d</mi><mn>3</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mi>‚Ä¶</mi><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><msub><mi>d</mi><mrow><mi>N</mi><mo>‚àí</mo><mn>1</mn></mrow></msub><mo>,</mo><mi>i</mi><msub><mi>d</mi><mi>N</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">
\bigl[(id_1, id_2), (id_2, id_3), \dots, (id_{N-1}, id_N)\bigr]
</annotation></semantics></math></p>
</li>
</ol>
<p><strong>Properties</strong></p>
<ul>
<li>Guarantees connectivity</li>
<li>Guarantees <code>min_degree ‚â• 1</code>
</li>
<li>Requires exactly <code>N‚àí1</code> comparisons</li>
<li>Avoids structural artifacts from input order</li>
</ul>
</div>
<div class="section level4">
<h4 id="early-phase-coverage-completion">3.2 Early-Phase Coverage Completion<a class="anchor" aria-label="anchor" href="#early-phase-coverage-completion"></a>
</h4>
<p>After warm start:</p>
<ul>
<li><p>Adaptive pairing begins immediately.</p></li>
<li>
<p>A <strong>coverage quota routing probability</strong> is enforced
until <code>min_degree ‚â• 2</code>:</p>
<ul>
<li>Define <code>quota_eps</code> (default 0.20).</li>
<li>While <code>min_degree &lt; 2</code>, with probability
<code>quota_eps</code>, the selected pair must include at least one
endpoint from the low-degree set (defined in ¬ß5.1.1).</li>
</ul>
</li>
<li><p>After <code>min_degree ‚â• 2</code>, the quota is
disabled.</p></li>
</ul>
<p>This quota is implemented step-by-step and therefore targets the
stated fraction only in expectation over steps.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="automatic-defaults-functions-of-n">4. Automatic Defaults (Functions of N)<a class="anchor" aria-label="anchor" href="#automatic-defaults-functions-of-n"></a>
</h3>
<div class="section level4">
<h4 id="scope-of-automatic-defaults">4.1 Scope of Automatic Defaults<a class="anchor" aria-label="anchor" href="#scope-of-automatic-defaults"></a>
</h4>
<p>This section defines adaptive defaults that scale with the number of
items N. Unless explicitly stated otherwise, all defaults in ¬ß4 are
normative and apply globally throughout the run.</p>
</div>
<div class="section level4">
<h4 id="exploration-rate-coverage-oriented-one-pair-steps">4.2 Exploration Rate (Coverage-Oriented, One-Pair Steps)<a class="anchor" aria-label="anchor" href="#exploration-rate-coverage-oriented-one-pair-steps"></a>
</h4>
<p>The adaptive algorithm maintains an explicit exploration rate,
denoted <code>explore_rate</code>, which controls the probability that a
single selection step is routed to a coverage-oriented exploration
policy rather than pure utility maximization.</p>
</div>
<div class="section level4">
<h4 id="definition-per-step">Definition (per step)<a class="anchor" aria-label="anchor" href="#definition-per-step"></a>
</h4>
<p>At each step, after candidate generation and filtering:</p>
<ul>
<li>With probability <code>explore_rate</code>, choose the next pair
using exploration selection.</li>
<li>With probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>‚àí</mo><mrow><mi mathvariant="normal">e</mi><mi mathvariant="normal">x</mi><mi mathvariant="normal">p</mi><mi mathvariant="normal">l</mi><mi mathvariant="normal">o</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">_</mi><mi mathvariant="normal">r</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">t</mi><mi mathvariant="normal">e</mi></mrow></mrow><annotation encoding="application/x-tex">1-\mathrm{explore\_rate}</annotation></semantics></math>,
choose the next pair using exploitation selection.</li>
</ul>
<p>Exploration and exploitation are defined in ¬ß7.5.</p>
</div>
<div class="section level4">
<h4 id="interpretation-under-trueskill-pairing">Interpretation under TrueSkill pairing<a class="anchor" aria-label="anchor" href="#interpretation-under-trueskill-pairing"></a>
</h4>
<p>Exploration is not uniform random sampling. Instead, exploration
selects pairs that preferentially include items with:</p>
<ul>
<li>low cumulative degree, and/or</li>
<li>low recent participation (as used by star caps in ¬ß6.1),</li>
</ul>
<p>while still pairing them using a weak TrueSkill heuristic (e.g.,
closest
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>Œº</mi><annotation encoding="application/x-tex">\mu</annotation></semantics></math>
among eligible partners).</p>
<p>This ensures exploration:</p>
<ul>
<li>improves coverage and connectivity,</li>
<li>reduces the risk of isolated or weakly connected items,</li>
<li>avoids wasting comparisons on obviously uninformative
mismatches.</li>
</ul>
</div>
<div class="section level4">
<h4 id="defaults">Defaults<a class="anchor" aria-label="anchor" href="#defaults"></a>
</h4>
<p>The exploration rate is a function of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>:</p>
<pre><code>explore_rate = clamp(0.10, 0.25, 0.20 ‚àí 0.02 * log10(N))</code></pre>
</div>
<div class="section level4">
<h4 id="logging">Logging<a class="anchor" aria-label="anchor" href="#logging"></a>
</h4>
<p>Each step must log:</p>
<ul>
<li>
<code>is_explore_step</code> (TRUE/FALSE)</li>
<li>
<code>explore_reason</code> (e.g., ‚Äúprobabilistic‚Äù,
‚Äúcoverage_quota_override‚Äù)</li>
<li>degree summaries of selected endpoints (e.g., <code>deg_i</code>,
<code>deg_j</code>)</li>
<li>whether the chosen pair was forced by a fallback stage</li>
</ul>
<div class="section level5">
<h5 id="late-stage-exploration-taper">Late-stage exploration taper<a class="anchor" aria-label="anchor" href="#late-stage-exploration-taper"></a>
</h5>
<p>When <code>global_identified == TRUE</code>, the effective
exploration rate is reduced:</p>
<pre><code><span><span class="va">explore_rate_used</span> <span class="op">=</span> <span class="va">explore_rate</span> <span class="op">*</span> <span class="va">explore_taper_mult</span></span></code></pre>
<p><strong>Default:</strong></p>
<pre><code><span><span class="va">explore_taper_mult</span> <span class="op">=</span> <span class="fl">0.50</span></span></code></pre>
<p>This modification applies only after global identifiability is
achieved and does not affect early-phase coverage behavior.</p>
<p><strong>Logging:</strong> - Per step:
<code>explore_rate_used</code></p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="refit-cadence">4.3 Refit Cadence<a class="anchor" aria-label="anchor" href="#refit-cadence"></a>
</h4>
<p>Refits are triggered by increases in the average degree of the
committed comparison graph.</p>
<p>Let:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mtext mathvariant="normal">done</mtext></msub><annotation encoding="application/x-tex">M_{\text{done}}</annotation></semantics></math>
be the number of completed / committed comparisons (i.e., with valid
outcomes),</li>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
be the number of items.</li>
</ul>
<p>Define:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover><mi>d</mi><mo accent="true">¬Ø</mo></mover><mo>=</mo><mfrac><mrow><mn>2</mn><msub><mi>M</mi><mtext mathvariant="normal">done</mtext></msub></mrow><mi>N</mi></mfrac></mrow><annotation encoding="application/x-tex">
\overline{d} = \frac{2 M_{\text{done}}}{N}
</annotation></semantics></math></p>
<p>A refit is eligible when:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œî</mi><mrow><mo stretchy="true" form="prefix">(</mo><mover><mi>d</mi><mo accent="true">¬Ø</mo></mover><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚â•</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">
\Delta(\overline{d}) \ge 1
</annotation></semantics></math></p>
<p>Equivalently, refit after at least:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œî</mi><msub><mi>M</mi><mtext mathvariant="normal">done</mtext></msub><mo>‚â•</mo><mrow><mo stretchy="true" form="prefix">‚åà</mo><mfrac><mi>N</mi><mn>2</mn></mfrac><mo stretchy="true" form="postfix">‚åâ</mo></mrow></mrow><annotation encoding="application/x-tex">
\Delta M_{\text{done}} \ge \left\lceil \frac{N}{2} \right\rceil
</annotation></semantics></math></p>
<p>new completed comparisons since the last refit, subject to
clamps:</p>
<pre><code><span><span class="va">refit_pairs_target</span> <span class="op">=</span> <span class="fu">clamp</span><span class="op">(</span><span class="fl">100</span>, <span class="fl">5000</span>, <span class="fu">ceil</span><span class="op">(</span><span class="va">N</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p><strong>Operational rule:</strong> refit triggers are evaluated using
completed comparisons only (not scheduled/inflight pairs). Warm-start
comparisons count toward
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>M</mi><mtext mathvariant="normal">done</mtext></msub><annotation encoding="application/x-tex">M_{\text{done}}</annotation></semantics></math>
and therefore toward the first refit trigger.</p>
</div>
<div class="section level4">
<h4 id="effective-sample-size-ess-thresholds">4.4 Effective Sample Size (ESS) Thresholds<a class="anchor" aria-label="anchor" href="#effective-sample-size-ess-thresholds"></a>
</h4>
<p>Minimum effective sample size requirements scale with the number of
items to ensure that Monte Carlo noise remains negligible for global
quantities (rank stability, correlations, reliability) as model
dimension grows.</p>
<p>Define the default ESS thresholds as functions of <code>N</code>:</p>
<pre><code><span><span class="va">ess_bulk_min</span> <span class="op">=</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">400</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">20</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ess_bulk_min_near_stop</span> <span class="op">=</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">50</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p><strong>Interpretation:</strong></p>
<ul>
<li>The <code>sqrt(N)</code> scaling increases strictness for larger
problems without making refits prohibitively expensive.</li>
<li>The lower bounds (400, 1000) ensure reasonable behavior for small
<code>N</code>.</li>
<li>
<code>ess_bulk_min</code> applies during normal operation (Phase
2).</li>
<li>
<code>ess_bulk_min_near_stop</code> applies only after Phase 3 entry
(¬ß5.4).</li>
</ul>
<p>Both thresholds are computed once per run and printed explicitly at
each refit.</p>
<hr>
</div>
<div class="section level4">
<h4 id="defaults-summary-normative">4.5 Defaults Summary (normative)<a class="anchor" aria-label="anchor" href="#defaults-summary-normative"></a>
</h4>
<table class="table">
<colgroup>
<col width="50%">
<col width="50%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Default</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>C_max</code></td>
<td><code>20000</code></td>
</tr>
<tr class="even">
<td><code>quota_eps</code></td>
<td><code>0.20</code></td>
</tr>
<tr class="odd">
<td><code>explore_rate</code></td>
<td><code>clamp(0.10, 0.25, 0.20 ‚àí 0.02 * log10(N))</code></td>
</tr>
<tr class="even">
<td><code>explore_resample_max</code></td>
<td><code>10</code></td>
</tr>
<tr class="odd">
<td><code>explore_nonlocal_rate</code></td>
<td><code>0.15</code></td>
</tr>
<tr class="even">
<td><code>cap_frac</code></td>
<td><code>0.08</code></td>
</tr>
<tr class="odd">
<td><code>dup_p_margin</code></td>
<td><code>0.05</code></td>
</tr>
<tr class="even">
<td><code>dup_max_obs</code></td>
<td><code>2</code></td>
</tr>
<tr class="odd">
<td><code>dup_max_obs_relaxed</code></td>
<td><code>3</code></td>
</tr>
<tr class="even">
<td><code>q</code></td>
<td><code>0.90</code></td>
</tr>
<tr class="odd">
<td><code>refit_pairs_target</code></td>
<td><code>clamp(100, 5000, ceil(N/2))</code></td>
</tr>
<tr class="even">
<td><code>round_pairs_target</code></td>
<td><code>ceil(refit_pairs_target / 2)</code></td>
</tr>
<tr class="odd">
<td><code>W_cap</code></td>
<td><code>max(200, min(2000, refit_pairs_target))</code></td>
</tr>
<tr class="even">
<td><code>ess_bulk_min</code></td>
<td><code>max(400, round(20 * sqrt(N)))</code></td>
</tr>
<tr class="odd">
<td><code>ess_bulk_min_near_stop</code></td>
<td><code>max(1000, round(50 * sqrt(N)))</code></td>
</tr>
<tr class="even">
<td>
<code>near_tie_p_low</code>, <code>near_tie_p_high</code>
</td>
<td>
<code>0.40</code>, <code>0.60</code>
</td>
</tr>
<tr class="odd">
<td><code>repeat_in_round_budget</code></td>
<td><code>2</code></td>
</tr>
<tr class="even">
<td><code>anchor_frac_early</code></td>
<td><code>0.30</code></td>
</tr>
<tr class="odd">
<td><code>anchor_frac_late</code></td>
<td><code>0.20</code></td>
</tr>
<tr class="even">
<td><code>anchor_rounds_early</code></td>
<td><code>4</code></td>
</tr>
<tr class="odd">
<td><code>long_frac_early</code></td>
<td><code>0.10</code></td>
</tr>
<tr class="even">
<td><code>long_frac_late</code></td>
<td><code>0.05</code></td>
</tr>
<tr class="odd">
<td><code>long_rounds_early</code></td>
<td><code>4</code></td>
</tr>
<tr class="even">
<td><code>mid_frac</code></td>
<td><code>0.10</code></td>
</tr>
<tr class="odd">
<td><code>k_total</code></td>
<td><code>clamp(10, 40, round(0.10 * N))</code></td>
</tr>
<tr class="even">
<td><code>k_top</code></td>
<td><code>round(0.30 * k_total)</code></td>
</tr>
<tr class="odd">
<td><code>k_bot</code></td>
<td><code>k_top</code></td>
</tr>
<tr class="even">
<td><code>k_mid</code></td>
<td><code>k_total - k_top - k_bot</code></td>
</tr>
<tr class="odd">
<td><code>top_band_pct</code></td>
<td><code>0.10</code></td>
</tr>
<tr class="even">
<td><code>top_band_bins</code></td>
<td><code>5</code></td>
</tr>
<tr class="odd">
<td><code>K_base</code></td>
<td>
<code>5</code> if <code>N&lt;60</code>; <code>10</code> if
<code>60‚â§N&lt;150</code>; <code>12</code> if <code>150‚â§N&lt;400</code>;
<code>20</code> if <code>N‚â•400</code>
</td>
</tr>
<tr class="even">
<td><code>long_min_dist</code></td>
<td><code>ceil(0.5 * K_base)</code></td>
</tr>
<tr class="odd">
<td><code>mid_min_dist</code></td>
<td><code>2</code></td>
</tr>
<tr class="even">
<td><code>mid_max_dist</code></td>
<td><code>min(4, K_base - 1)</code></td>
</tr>
</tbody>
</table>
</div>
<div class="section level4">
<h4 id="global-identifiability-state">4.5.1 Global Identifiability State<a class="anchor" aria-label="anchor" href="#global-identifiability-state"></a>
</h4>
<p>The adaptive controller maintains a derived Boolean state indicating
whether the global latent scale is sufficiently identified to permit
aggressive local refinement.</p>
<p>Define, at each refit:</p>
<pre><code>
global_identified =
(reliability_EAP ‚â• global_identified_reliability_min)
AND
(ts_btl_rank_spearman ‚â• global_identified_rank_corr_min)
</code></pre>
<p><strong>Defaults (normative):</strong></p>
<pre><code><span></span>
<span><span class="va">global_identified_reliability_min</span> <span class="op">=</span> <span class="fl">0.80</span></span>
<span><span class="va">global_identified_rank_corr_min</span>   <span class="op">=</span> <span class="fl">0.90</span></span></code></pre>
<p><strong>Interpretation:</strong></p>
<p>When <code>global_identified = TRUE</code>, posterior uncertainty is
no longer dominated by global scale ambiguity. Subsequent adaptive
sampling should prioritize local discrimination and boundary refinement
rather than long-range connectivity.</p>
<p>This state affects: - round-stage quota allocation (¬ß4.6.2), -
long-link eligibility (¬ß5.1.2), - exploration rate (¬ß4.2), - and
star-cap overrides (¬ß6.1.1).</p>
<p><strong>Logging:</strong></p>
<p>Each refit must log: - <code>global_identified</code> (TRUE/FALSE) -
the threshold values used.</p>
</div>
<div class="section level4">
<h4 id="round-cadence-and-quotas-normative">4.6 Round Cadence and Quotas (normative)<a class="anchor" aria-label="anchor" href="#round-cadence-and-quotas-normative"></a>
</h4>
<p>Selection is organized into rounds. A round is a planning construct
that schedules a fixed number of committed comparisons (valid judge
outcomes only). Pair selection still operates step-by-step (¬ß7), but
each step is assigned to a round stage (¬ß7.2).</p>
<div class="section level5">
<h5 id="round-size-committed-comparisons">4.6.1 Round size (committed comparisons)<a class="anchor" aria-label="anchor" href="#round-size-committed-comparisons"></a>
</h5>
<p>Let: - <code>refit_pairs_target = clamp(100, 5000, ceil(N/2))</code>
(¬ß4.3)</p>
<p>Define:</p>
<pre><code><span></span>
<span><span class="va">round_pairs_target</span> <span class="op">=</span> <span class="fu">ceil</span><span class="op">(</span><span class="va">refit_pairs_target</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span></code></pre>
<p>Design intent: approximately 2 rounds per refit.</p>
<p>Rounds count committed comparisons only. Invalid judge outcomes do
not advance the round‚Äôs committed-pair counter (¬ß2.2 Invariant 2).</p>
</div>
<div class="section level5">
<h5 id="round-stage-quotas">4.6.2 Round stage quotas<a class="anchor" aria-label="anchor" href="#round-stage-quotas"></a>
</h5>
<p>Each round has four pair-type stages with target committed
counts:</p>
<ol style="list-style-type: decimal">
<li><code>anchor_link</code></li>
<li><code>long_link</code></li>
<li><code>mid_link</code></li>
<li><code>local_link</code></li>
</ol>
<p>Base quotas are computed as:</p>
<pre><code><span></span>
<span><span class="va">anchor_quota</span> <span class="op">=</span> <span class="fu">ceil</span><span class="op">(</span><span class="va">anchor_frac</span> <span class="op">*</span> <span class="va">round_pairs_target</span><span class="op">)</span></span>
<span><span class="va">long_quota</span>   <span class="op">=</span> <span class="fu">ceil</span><span class="op">(</span><span class="va">long_frac</span>   <span class="op">*</span> <span class="va">round_pairs_target</span><span class="op">)</span></span>
<span><span class="va">mid_quota</span>    <span class="op">=</span> <span class="fu">ceil</span><span class="op">(</span><span class="va">mid_frac</span>    <span class="op">*</span> <span class="va">round_pairs_target</span><span class="op">)</span></span>
<span><span class="va">local_quota</span>  <span class="op">=</span> <span class="va">round_pairs_target</span> <span class="op">-</span> <span class="op">(</span><span class="va">anchor_quota</span> <span class="op">+</span> <span class="va">long_quota</span> <span class="op">+</span> <span class="va">mid_quota</span><span class="op">)</span></span></code></pre>
</div>
</div>
<div class="section level4">
<h4 id="time-varying-base-fractions">Time-varying base fractions<a class="anchor" aria-label="anchor" href="#time-varying-base-fractions"></a>
</h4>
<ul>
<li>For rounds <code>round_id ‚â§ anchor_rounds_early</code>:
<ul>
<li><code>anchor_frac = anchor_frac_early</code></li>
</ul>
</li>
<li>Else:
<ul>
<li><code>anchor_frac = anchor_frac_late</code></li>
</ul>
</li>
<li>For rounds <code>round_id ‚â§ long_rounds_early</code>:
<ul>
<li><code>long_frac = long_frac_early</code></li>
</ul>
</li>
<li>Else:
<ul>
<li><code>long_frac = long_frac_late</code></li>
</ul>
</li>
<li>
<code>mid_frac</code> is constant.</li>
</ul>
</div>
<div class="section level4">
<h4 id="global-identifiability-taper">Global-identifiability taper<a class="anchor" aria-label="anchor" href="#global-identifiability-taper"></a>
</h4>
<p>If <code>global_identified == TRUE</code> at the most recent refit
(¬ß4.5.1):</p>
<pre><code><span></span>
<span><span class="va">long_frac_effective</span> <span class="op">=</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">long_frac_floor</span>, <span class="va">long_frac</span> <span class="op">*</span> <span class="va">long_taper_mult</span><span class="op">)</span></span></code></pre>
<p><strong>Defaults (normative):</strong></p>
<pre><code><span></span>
<span><span class="va">long_taper_mult</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span><span class="va">long_frac_floor</span> <span class="op">=</span> <span class="fl">0.02</span></span></code></pre>
<p>Define:</p>
<pre><code><span><span class="va">long_quota_raw</span> <span class="op">=</span> <span class="fu">ceil</span><span class="op">(</span><span class="va">long_frac</span> <span class="op">*</span> <span class="va">round_pairs_target</span><span class="op">)</span></span>
<span></span>
<span><span class="va">long_quota_effective</span> <span class="op">=</span></span>
<span>    <span class="fu">ceil</span><span class="op">(</span><span class="va">long_frac_effective</span> <span class="op">*</span> <span class="va">round_pairs_target</span><span class="op">)</span></span>
<span></span>
<span><span class="va">long_quota_removed</span> <span class="op">=</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">long_quota_raw</span> <span class="op">-</span> <span class="va">long_quota_effective</span><span class="op">)</span></span>
<span></span>
<span><span class="va">realloc_to_mid</span> <span class="op">=</span></span>
<span>    <span class="fu">ceil</span><span class="op">(</span><span class="va">mid_bonus_frac</span> <span class="op">*</span> <span class="va">long_quota_removed</span><span class="op">)</span></span>
<span></span>
<span><span class="va">realloc_to_local</span> <span class="op">=</span></span>
<span>    <span class="va">long_quota_removed</span> <span class="op">-</span> <span class="va">realloc_to_mid</span></span></code></pre>
<p>Apply reallocation:</p>
<pre><code>mid_quota   += realloc_to_mid
local_quota += realloc_to_local</code></pre>
</div>
<div class="section level4">
<h4 id="design-intent">Design intent<a class="anchor" aria-label="anchor" href="#design-intent"></a>
</h4>
<p>After global scale identification, long-range links yield diminishing
marginal information. v3.1 explicitly reallocates this budget to
higher-yield local and mid-range refinement while retaining a minimal
long-link trickle to preserve graph robustness.</p>
</div>
<div class="section level4">
<h4 id="logging-1">Logging<a class="anchor" aria-label="anchor" href="#logging-1"></a>
</h4>
<p>At the refit following each completed round, the following fields
must be logged: - <code>long_quota_raw</code> -
<code>long_quota_effective</code> - <code>long_quota_removed</code> -
<code>realloc_to_mid</code> - <code>realloc_to_local</code></p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="candidate-generation-and-feasibility-safeguards">5. Candidate Generation and Feasibility Safeguards<a class="anchor" aria-label="anchor" href="#candidate-generation-and-feasibility-safeguards"></a>
</h3>
</div>
<div class="section level3">
<h3 id="rank-strata-and-percentile-top-band-normative">5.0 Rank Strata and Percentile Top-Band (normative)<a class="anchor" aria-label="anchor" href="#rank-strata-and-percentile-top-band-normative"></a>
</h3>
<p>Candidate generation is done using rank strata that can scale to N up
to 2000 while supporting: - local refinement, - mid/long links, and - a
percentile-based top band for finer control near the top of the
scale.</p>
<p>All strata are defined over the current ordering <code>rank_mu</code>
(TrueSkill Œº) with deterministic tie-breaking: - primary: Œº descending -
tie-break: item_id ascending</p>
<p>Let <code>r(x)</code> be the 1..N rank index of item x in
<code>rank_mu</code>.</p>
<div class="section level4">
<h4 id="base-strata-global">5.0.1 Base strata (global)<a class="anchor" aria-label="anchor" href="#base-strata-global"></a>
</h4>
<p>Define <code>K_base</code> strata for the full rank list.</p>
<p>Normative default: - N &lt; 60: <code>K_base = 5</code> - 60 ‚â§ N &lt;
150: <code>K_base = 10</code> - 150 ‚â§ N &lt; 400:
<code>K_base = 12</code> - N ‚â• 400: <code>K_base = 20</code></p>
<p>Items are assigned to equal-count bins by rank index (approximately
N/K_base per stratum; last stratum may differ by ‚â§1).</p>
</div>
<div class="section level4">
<h4 id="percentile-based-top-band-required-for-large-n">5.0.2 Percentile-based top band (required for large N)<a class="anchor" aria-label="anchor" href="#percentile-based-top-band-required-for-large-n"></a>
</h4>
<p>To support decision-relevant resolution near the top, there is a top
band defined by percentile and that is subdivided more finely than the
rest.</p>
<p>Parameters: - <code>top_band_pct</code> (default 0.10): top 10% of
items by <code>rank_mu</code> - <code>top_band_bins</code> (default 5):
subdivide the top band into 5 equal-count bins (each ~2% of items)</p>
<p>Construction: 1) Let <code>T = ceil(top_band_pct * N)</code> be the
count in the top band. 2) Split ranks 1..T into
<code>top_band_bins</code> equal-count bins (¬±1). 3) The remaining ranks
(T+1..N) are split into <code>K_base</code> strata as in 5.0.1.</p>
<p>This yields: - fine-grained ‚Äútop percentiles‚Äù strata for top-k
boundary control, - coarse-but-scalable strata for the remainder.</p>
<p>For N ‚â• 400, implementations should prefer computing strata from rank
indices directly (no O(N^2) pair enumeration) and generate candidates
via sampled partner pools per item, subject to <code>C_max</code>.</p>
</div>
<div class="section level4">
<h4 id="stratum-distance">5.0.3 Stratum distance<a class="anchor" aria-label="anchor" href="#stratum-distance"></a>
</h4>
<p>Define: -
<code>dist_stratum(i,j) = |stratum(i) - stratum(j)|</code></p>
<p>Pair-type stages impose constraints on <code>dist_stratum</code>
(¬ß7.2).</p>
</div>
</div>
<div class="section level3">
<h3 id="candidate-pools-normative-stage-specific">5.1 Candidate Pools (normative; stage-specific)<a class="anchor" aria-label="anchor" href="#candidate-pools-normative-stage-specific"></a>
</h3>
<p>Candidates are generated according to the active round stage. After
generation, all candidates pass through the canonical pipeline
(¬ß5.2.1).</p>
<div class="section level4">
<h4 id="stage-anchor_link">5.1.1 Stage: anchor_link<a class="anchor" aria-label="anchor" href="#stage-anchor_link"></a>
</h4>
<p>Anchor-link candidates are unordered pairs <code>{i,j}</code> where:
- <code>i ‚àà anchors</code> (rolling anchor set; ¬ß7.1), and -
<code>j ‚àâ anchors</code>.</p>
<p>Partner targeting is stage-specific but must respect all hard
invariants, duplicate rules, and star caps via the canonical
pipeline.</p>
</div>
<div class="section level4">
<h4 id="stage-long_link">5.1.2 Stage: long_link<a class="anchor" aria-label="anchor" href="#stage-long_link"></a>
</h4>
<p>Generate unordered candidates <code>{i,j}</code> such that:</p>
<ul>
<li>
<code>i</code> and <code>j</code> are non-anchors, and</li>
<li>
<code>dist_stratum(i,j) ‚â• long_min_dist</code>.</li>
</ul>
<p><strong>Additional posterior gate:</strong></p>
<p>When <code>global_identified == TRUE</code>, a long-link candidate
<code>{i,j}</code> is eligible only if:</p>
<pre><code>
p_ij_posterior ‚àà [p_long_low, p_long_high]
</code></pre>
<p><strong>Defaults (normative):</strong></p>
<pre><code><span></span>
<span><span class="va">p_long_low</span>  <span class="op">=</span> <span class="fl">0.10</span></span>
<span><span class="va">p_long_high</span> <span class="op">=</span> <span class="fl">0.90</span></span></code></pre>
<p>Where <code>p_ij_posterior</code> is the posterior win probability
<code>Pr(Œ∏_i &gt; Œ∏_j | posterior)</code> computed at the most recent
refit.</p>
<p><strong>Fallback rule:</strong> If posterior probabilities are
unavailable (e.g., prior to the first refit), use the TrueSkill proxy
<code>p_ij</code>.</p>
<p><strong>Interpretation:</strong></p>
<p>This gate prevents expending long-range comparisons on pairs that are
already effectively decided once global scale has stabilized.</p>
<p><strong>Logging:</strong></p>
<p>Each attempted long-link step must log: - <code>long_gate_pass</code>
(TRUE/FALSE) - <code>long_gate_reason</code> (e.g.,
<code>posterior_extreme</code>, <code>posterior_unavailable</code>)</p>
</div>
<div class="section level4">
<h4 id="stage-mid_link">5.1.3 Stage: mid_link<a class="anchor" aria-label="anchor" href="#stage-mid_link"></a>
</h4>
<p>Generate unordered candidates <code>{i,j}</code> such that: -
<code>i</code> and <code>j</code> are non-anchors, and -
<code>mid_min_dist ‚â§ dist_stratum(i,j) ‚â§ mid_max_dist</code></p>
<p>Defaults:</p>
<pre><code><span></span>
<span><span class="va">mid_min_dist</span> <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="va">mid_max_dist</span> <span class="op">=</span> <span class="fl">4</span></span></code></pre>
<p>If K_base &lt; 10, clamp mid_max_dist to K_base-1.</p>
</div>
<div class="section level4">
<h4 id="stage-local_link">5.1.4 Stage: local_link<a class="anchor" aria-label="anchor" href="#stage-local_link"></a>
</h4>
<p>Generate unordered candidates <code>{i,j}</code> such that: - both
endpoints are eligible for local selection (anchors allowed or
disallowed by config; default allow), - and either: - same stratum, or -
adjacent stratum (<code>dist_stratum ‚â§ 1</code>)</p>
<p>Optional local enrichment (recommended for small N): - If local
candidate count is below a small threshold, allow
<code>dist_stratum ‚â§ 2</code> before invoking the fallback ladder.</p>
<div class="section level5">
<h5 id="local-link-prioritization">5.1.4.1 Local-link prioritization<a class="anchor" aria-label="anchor" href="#local-link-prioritization"></a>
</h5>
<p>When <code>global_identified == TRUE</code>, local-link selection is
biased toward pairs that resolve remaining posterior ambiguity.</p>
<p>Within the eligible local candidate set:</p>
<p>Priority is given to pairs satisfying one or more of: - near-tie
condition:</p>
<pre><code>|p_ij ‚àí 0.5| minimal</code></pre>
<ul>
<li>boundary refinement: items whose current EAP ranks lie within a
window around the top-k cutoff. ‚ÄúCurrent EAP ranks‚Äù refers to the most
recent refit‚Äôs EAP ranking when available; otherwise use the proxy
ranking <code>rank_mu</code>.</li>
</ul>
<p><strong>Defaults (normative):</strong></p>
<pre><code><span><span class="va">boundary_k</span> <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="va">boundary_window</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fu">ceil</span><span class="op">(</span><span class="fl">0.05</span> <span class="op">*</span> <span class="va">N</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">boundary_frac</span> <span class="op">=</span> <span class="fl">0.15</span>   <span class="co"># fraction of local quota</span></span></code></pre>
<p>This prioritization affects only utility ranking within the local
stage and does not override invariants, duplicate rules, or star
caps.</p>
<p><strong>Logging:</strong> -
<code>local_priority_mode ‚àà {standard, near_tie, boundary}</code></p>
</div>
</div>
<div class="section level4">
<h4 id="candidate-cap-c_max">5.1.5 Candidate cap (C_max)<a class="anchor" aria-label="anchor" href="#candidate-cap-c_max"></a>
</h4>
<p>All generated candidate sets are capped at:</p>
<pre><code>
C_max = 20,000 unordered pairs per selection attempt
</code></pre>
<p>If the set exceeds <code>C_max</code>, subsample uniformly without
replacement using a stage-specific deterministic seed derived from: -
run seed - <code>step_id</code> - stage id (anchor/long/mid/local) -
fallback stage id (if applicable)</p>
<p>Uniform subsampling is normative: do not subsample by utility or rank
position.</p>
</div>
<div class="section level4">
<h4 id="per-round-exposure-constraint-pollitt-style-soft">5.1.6 Per-round exposure constraint (Pollitt-style; soft)<a class="anchor" aria-label="anchor" href="#per-round-exposure-constraint-pollitt-style-soft"></a>
</h4>
<p>Within a round, the goal is to have ‚â§1 appearance per item.</p>
<p>Normative policy (‚Äúsoft Pollitt‚Äù): - disallow selecting an item
already used in the current round, - except permit up to
<code>repeat_in_round_budget</code> total repeated item-uses per round
(default 2), - repeated-use is allowed only for items in the bottom
quartile of <code>recent_deg</code> (under-represented) and only after
stage-local candidate starvation would otherwise occur.</p>
<p>This rule is applied as an additional hard filter within candidate
generation for the active stage (before duplicate and star-cap filters),
because it operates at the round-plan level.</p>
<hr>
</div>
<div class="section level4">
<h4 id="candidate-starvation-detection">5.2 Candidate Starvation Detection<a class="anchor" aria-label="anchor" href="#candidate-starvation-detection"></a>
</h4>
<p>Within a step, the controller may attempt multiple fallback stages
(¬ß5.3). A step is considered starved only if no valid pair is selected
after exhausting all fallback stages.</p>
<p>Define:</p>
<pre><code>candidate_starved = (no valid pair selected after all fallback stages)</code></pre>
<p>Per-step logs must also record the first attempt that succeeded (if
any) via <code>fallback_used</code> and <code>fallback_path</code>.</p>
<p>Note: <code>candidate_starved = TRUE</code> at the step level
indicates failure after exhausting all fallback stages for the current
step. Run termination occurs only if all round stages are exhausted
without producing a valid pair (¬ß7.7).</p>
<hr>
</div>
<div class="section level4">
<h4 id="canonical-candidate-pipeline-normative">5.2.1 Canonical candidate pipeline (normative)<a class="anchor" aria-label="anchor" href="#canonical-candidate-pipeline-normative"></a>
</h4>
<p>Within any selection attempt (base or fallback stage), candidates
must be processed in the following order:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Generate</strong> an unordered candidate set <code>C</code>
(deduplicated unordered pairs).</li>
<li>
<strong>Compute</strong> TrueSkill quantities for each
<code>{i,j}</code> in <code>C</code>: <code>p_ij</code> and
<code>U0_ij</code>.</li>
<li>
<strong>Apply hard filters</strong>:
<ul>
<li>remove self-pairs,</li>
<li>remove pairs that violate any hard invariant (including enforced
order-reversal feasibility for repeats).</li>
</ul>
</li>
<li>
<strong>Apply duplicate policy</strong> (default or relaxed
depending on stage).</li>
<li>
<strong>Apply star caps</strong> (¬ß6.1.1) as an eligibility
filter.</li>
<li>
<strong>Apply optional continuous degree regularization</strong> (if
enabled) to produce final utility <code>U_ij</code>.</li>
<li>
<strong>Select</strong> the next unordered pair using
exploration/exploitation (¬ß7.5).</li>
</ol>
<p>Logging counts must refer to these pipeline points:</p>
<ul>
<li>
<code>n_candidates_generated</code>: number of unordered pairs after
Step 1</li>
<li>
<code>n_candidates_after_hard_filters</code>: after Step 3</li>
<li>
<code>n_candidates_after_duplicates</code>: after Step 4</li>
<li>
<code>n_candidates_after_star_caps</code>: after Step 5</li>
<li>
<code>n_candidates_scored</code>: after Step 6 (equals
<code>n_candidates_after_star_caps</code> if regularization is off)</li>
</ul>
<p><code>n_candidates_after_filters</code> (if kept) must equal
<code>n_candidates_after_star_caps</code>.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="feasibility-fallback-ladder-within-stage">5.3 Feasibility Fallback Ladder (within-stage)<a class="anchor" aria-label="anchor" href="#feasibility-fallback-ladder-within-stage"></a>
</h3>
<p>Candidate generation can fail within a stage due to star caps,
duplicates, round exposure constraints, or thin strata.</p>
<p>The fallback ladder is applied within the active round stage first.
If all within-stage fallback attempts fail, the stage is declared
starved and the controller proceeds to the next round stage
(¬ß7.2.5).</p>
<p>Hard invariants are never relaxed.</p>
<div class="section level4">
<h4 id="within-stage-fallback-stages-in-order">5.3.1 Within-stage fallback stages (in order)<a class="anchor" aria-label="anchor" href="#within-stage-fallback-stages-in-order"></a>
</h4>
<p>For a given step under a given round stage, attempt:</p>
<ol style="list-style-type: decimal">
<li>
<strong>base</strong>: stage‚Äôs default candidate rule (¬ß5.1)</li>
<li>
<strong>expand_locality</strong>: widen locality <em>within the
stage definition</em> (e.g., local dist_stratum threshold from ‚â§1 to ‚â§2;
mid range from 2‚Äì4 to 1‚Äì5)</li>
<li>
<strong>uncertainty_pool</strong>: keep stage constraints but
temporarily increase exploration routing for this step:
<ul>
<li><code>explore_rate_used = min(0.50, 2 * explore_rate)</code></li>
<li>Note: this temporary increase applies to explore_rate_used, not the
base explore_rate.</li>
</ul>
</li>
<li>
<strong>dup_relax</strong>: same as uncertainty_pool but allow
relaxed duplicates (¬ß5.3.2)</li>
<li>
<strong>global_safe</strong>: as final within-stage backstop,
enumerate all unordered pairs that satisfy the stage‚Äôs type constraint
(anchor/non-anchor and distance band) with minimal locality
restrictions</li>
</ol>
<p>If still no valid pair is found: - mark step as
<code>candidate_starved=TRUE</code> for that attempt and return control
to the round controller to move to the next stage.</p>
<p>Logging must record: - active round stage - within-stage
fallback_used and fallback_path - whether stage starvation occurred</p>
<div class="section level5">
<h5 id="duplicate-allowance-rule-normative-trueskill-based">5.3.2 Duplicate allowance rule (normative; TrueSkill-based)<a class="anchor" aria-label="anchor" href="#duplicate-allowance-rule-normative-trueskill-based"></a>
</h5>
<p>Duplicate policy is applied at pipeline Step 4 (¬ß5.2.1) and depends
on stage:</p>
<ul>
<li>
<strong>Default policy</strong>: allow at most
<code>dup_max_obs</code> committed observations per unordered pair.</li>
<li>
<strong>Relaxed policy</strong> (only in stage
<code>dup_relax</code>): allow at most
<code>dup_max_obs_relaxed</code>.</li>
</ul>
<p>For an unordered pair <code>{i,j}</code> with current TrueSkill win
probability <code>p_ij</code> and base utility <code>U0_ij</code>,
repeats beyond the second committed observation are allowed
<strong>only</strong> if all conditions hold:</p>
<ol style="list-style-type: decimal">
<li><p>Persistent ambiguity (TrueSkill-based):
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mrow><mo stretchy="true" form="prefix">|</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>‚àí</mo><mn>0.5</mn><mo stretchy="true" form="postfix">|</mo></mrow><mo>‚â§</mo><mtext mathvariant="normal">dup_p_margin</mtext></mrow><annotation encoding="application/x-tex">
|p_{ij} - 0.5| \le \text{dup\_p\_margin}
</annotation></semantics></math></p></li>
<li>
<p>High utility relative to the <em>eligible</em> candidate set of
the current attempt:</p>
<p>Let <code>C_eligible</code> be the candidate set <strong>after hard
filters and star caps</strong>, but <strong>before</strong> applying
duplicate relaxation logic for this pair. Define:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mtext mathvariant="normal">dup_threshold</mtext></msub><mo>=</mo><msub><mtext mathvariant="normal">Quantile</mtext><mi>q</mi></msub><mo stretchy="false" form="prefix">{</mo><mi>U</mi><msub><mn>0</mn><mrow><mi>u</mi><mi>v</mi></mrow></msub><mo>:</mo><mo stretchy="false" form="prefix">{</mo><mi>u</mi><mo>,</mo><mi>v</mi><mo stretchy="false" form="postfix">}</mo><mo>‚àà</mo><msub><mi>C</mi><mtext mathvariant="normal">eligible</mtext></msub><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">
U_{\text{dup\_threshold}} = \text{Quantile}_q\{U0_{uv} : \{u,v\} \in C_{\text{eligible}}\}
</annotation></semantics></math> Require:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><msub><mn>0</mn><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>‚â•</mo><msub><mi>U</mi><mtext mathvariant="normal">dup_threshold</mtext></msub></mrow><annotation encoding="application/x-tex">
U0_{ij} \ge U_{\text{dup\_threshold}}
</annotation></semantics></math></p>
</li>
<li><p>Observation cap:</p></li>
</ol>
<pre><code>pair_obs_count[{i,j}] &lt; dup_max_obs # default policy
pair_obs_count[{i,j}] &lt; dup_max_obs_relaxed # relaxed policy (dup_relax only)</code></pre>
<p><strong>Defaults:</strong></p>
<pre><code><span><span class="va">dup_p_margin</span> <span class="op">=</span> <span class="fl">0.05</span> <span class="co"># repeats allowed when p_ij ‚àà [0.45, 0.55]</span></span>
<span><span class="va">dup_max_obs</span> <span class="op">=</span> <span class="fl">2</span> <span class="co"># max committed observations per unordered pair under default policy</span></span>
<span><span class="va">dup_max_obs_relaxed</span> <span class="op">=</span> <span class="fl">3</span> <span class="co"># max committed observations per unordered pair in dup_relax stage</span></span>
<span><span class="va">q</span> <span class="op">=</span> <span class="fl">0.90</span> <span class="co"># utility quantile threshold</span></span></code></pre>
<p><strong>Order invariants:</strong> Order-reversal is always enforced
for repeated unordered pairs (¬ß7.6), regardless of duplicate policy.</p>
</div>
<div class="section level5">
<h5 id="logging-requirements-audit">Logging requirements (audit)<a class="anchor" aria-label="anchor" href="#logging-requirements-audit"></a>
</h5>
<p>At minimum, the per-step log must record:</p>
<ul>
<li><code>candidate_starved</code></li>
<li>
<code>fallback_used</code> and full <code>fallback_path</code>
(e.g., <code>base&gt;expand_locality&gt;dup_relax</code>)</li>
<li>
<code>starvation_reason</code> (best-effort classification;
<code>NA</code> if not starved)</li>
</ul>
<p>Additionally, the implementation must internally capture per-attempt
counts (generated/surviving) to support debugging, but only the
step-level fields above are required in the public <code>step_log</code>
schema.</p>
</div>
</div>
<div class="section level4">
<h4 id="phase-3-entry-near-stop-behavior">5.4 Phase 3 Entry (Near-Stop Behavior)<a class="anchor" aria-label="anchor" href="#phase-3-entry-near-stop-behavior"></a>
</h4>
<p>Phase 3 is intended to tighten numerical accuracy requirements as the
run approaches stopping.</p>
<div class="section level5">
<h5 id="entry-criterion-evaluated-only-at-refits">Entry criterion (evaluated only at refits)<a class="anchor" aria-label="anchor" href="#entry-criterion-evaluated-only-at-refits"></a>
</h5>
<p>Phase 3 is entered at refit <code>t</code> if:</p>
<pre><code>Rel_EAP(t) ‚â• (eap_reliability_min ‚àí 0.05)</code></pre>
<p>and the MCMC diagnostics gate passes using the <strong>Phase 2 ESS
threshold</strong> (<code>ess_bulk_min</code>).</p>
</div>
<div class="section level5">
<h5 id="normative-behavior-in-phase-3">Normative behavior in Phase 3<a class="anchor" aria-label="anchor" href="#normative-behavior-in-phase-3"></a>
</h5>
<p>Phase 3 modifies <strong>only</strong> the diagnostics strictness
used at refits.</p>
<p>In Phase 3:</p>
<ul>
<li>the posterior is considered usable only if:</li>
</ul>
<pre><code>min_ess_bulk ‚â• ess_bulk_min_near_stop</code></pre>
<ul>
<li>all other aspects of the adaptive algorithm are unchanged:
<ul>
<li>pair selection,</li>
<li>exploration/exploitation routing,</li>
<li>star caps,</li>
<li>fallback ladder,</li>
<li>logging behavior.</li>
</ul>
</li>
</ul>
<p>This ensures that near stopping, Monte Carlo error is negligible
relative to true posterior uncertainty.</p>
<hr>
</div>
</div>
</div>
<div class="section level3">
<h3 id="utility-function-trueskill-based">6. Utility Function (TrueSkill-based)<a class="anchor" aria-label="anchor" href="#utility-function-trueskill-based"></a>
</h3>
<p>For unordered
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">{</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="false" form="postfix">}</mo></mrow><annotation encoding="application/x-tex">\{i,j\}</annotation></semantics></math>,
each item has:</p>
<ul>
<li>mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>Œº</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\mu_i</annotation></semantics></math>
</li>
<li>uncertainty
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>œÉ</mi><mi>i</mi></msub><annotation encoding="application/x-tex">\sigma_i</annotation></semantics></math>
</li>
</ul>
<p>Let:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><msub><mi>Œº</mi><mi>i</mi></msub><mo>‚àí</mo><msub><mi>Œº</mi><mi>j</mi></msub></mrow><annotation encoding="application/x-tex">
d_{ij} = \mu_i - \mu_j
</annotation></semantics></math></p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>s</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup><mo>=</mo><msubsup><mi>œÉ</mi><mi>i</mi><mn>2</mn></msubsup><mo>+</mo><msubsup><mi>œÉ</mi><mi>j</mi><mn>2</mn></msubsup><mo>+</mo><mn>2</mn><msup><mi>Œ≤</mi><mn>2</mn></msup></mrow><annotation encoding="application/x-tex">
s_{ij}^2 = \sigma_i^2 + \sigma_j^2 + 2\beta^2
</annotation></semantics></math></p>
<p>Define the implied win probability:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mi>Œ¶</mi><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><msub><mi>d</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><msqrt><msubsup><mi>s</mi><mrow><mi>i</mi><mi>j</mi></mrow><mn>2</mn></msubsup></msqrt></mfrac><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
p_{ij} = \Phi\left(\frac{d_{ij}}{\sqrt{s_{ij}^2}}\right)
</annotation></semantics></math></p>
<p>Define base utility:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>U</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>‚àí</mo><msub><mi>p</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
U_0(i,j) = p_{ij}(1-p_{ij})
</annotation></semantics></math></p>
<p>This peaks at maximal outcome uncertainty.</p>
<hr>
</div>
<div class="section level3">
<h3 id="degree-control-and-star-caps">
<strong>6.1 Degree Control and Star Caps</strong><a class="anchor" aria-label="anchor" href="#degree-control-and-star-caps"></a>
</h3>
<p>Under TrueSkill pairing:</p>
<ul>
<li>uncertainty (œÉ) naturally shrinks for frequently sampled items,</li>
<li>aggressive degree regularization is unnecessary and can be overly
conservative.</li>
</ul>
<p>Therefore, degree control is implemented using:</p>
<ol style="list-style-type: decimal">
<li>early-phase coverage constraints (¬ß3.2), and</li>
<li>star caps (this section), rather than strong continuous penalties in
the utility function.</li>
</ol>
<hr>
<div class="section level4">
<h4 id="star-caps-default-enabled">6.1.1 Star Caps (default enabled)<a class="anchor" aria-label="anchor" href="#star-caps-default-enabled"></a>
</h4>
<p>A <strong>star cap</strong> limits how frequently any single item may
appear in recent comparisons, preventing ‚Äústar nodes‚Äù that dominate the
sampling budget.</p>
<div class="section level5">
<h5 id="definition">Definition<a class="anchor" aria-label="anchor" href="#definition"></a>
</h5>
<p>Maintain a rolling window of the most recent completed
comparisons:</p>
<pre><code><span><span class="va">W_cap</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fl">200</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="fl">2000</span>, <span class="va">refit_pairs_target</span><span class="op">)</span><span class="op">)</span></span></code></pre>
<p>where <code>refit_pairs_target</code> is defined in ¬ß4.3.</p>
<p>For each item (i), define:</p>
<pre><code>recent_deg[i] = number of appearances of i in the last W_cap comparisons</code></pre>
<p>A candidate unordered pair <code>{i,j}</code> is
<strong>ineligible</strong> if either endpoint violates the cap:</p>
<pre><code>recent_deg[i] &gt; cap_count  OR  recent_deg[j] &gt; cap_count</code></pre>
<p>Where:</p>
<pre><code><span><span class="va">cap_count</span> <span class="op">=</span> <span class="fu">ceil</span><span class="op">(</span><span class="va">cap_frac</span> <span class="op">*</span> <span class="va">W_cap</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="defaults-1">Defaults<a class="anchor" aria-label="anchor" href="#defaults-1"></a>
</h5>
<pre><code><span><span class="va">cap_frac</span> <span class="op">=</span> <span class="fl">0.08</span></span></code></pre>
<p>This ensures that no item participates in more than approximately 8%
of recent comparisons.</p>
<p><strong>Interpretation:</strong></p>
<ul>
<li>Prevents runaway focus on boundary items</li>
<li>Preserves adaptivity while enforcing fairness</li>
<li>Scales automatically with run length and refit cadence</li>
</ul>
</div>
<div class="section level5">
<h5 id="conditional-near-tie-override">Conditional near-tie override<a class="anchor" aria-label="anchor" href="#conditional-near-tie-override"></a>
</h5>
<p>When <code>global_identified == TRUE</code>, a star-cap rejection may
be overridden only if:</p>
<ol style="list-style-type: decimal">
<li>the pair is a near-tie:</li>
</ol>
<pre><code>|p_ij ‚àí 0.5| ‚â§ p_star_override_margin</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>both endpoints have acceptable total exposure (<code>deg</code> not
extreme),</li>
<li>and the per-round override budget is not exceeded.</li>
</ol>
<p><strong>Defaults:</strong></p>
<pre><code><span><span class="va">p_star_override_margin</span> <span class="op">=</span> <span class="fl">0.05</span></span>
<span><span class="va">star_override_budget_per_round</span> <span class="op">=</span> <span class="fl">1</span></span></code></pre>
<p>Overrides apply only to local-link and mid-link stages.</p>
<p><strong>Logging (per step):</strong> -
<code>star_override_used</code> (TRUE/FALSE) -
<code>star_override_reason</code></p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="interaction-with-utility">6.1.2 Interaction with Utility<a class="anchor" aria-label="anchor" href="#interaction-with-utility"></a>
</h4>
<p>Operationally, star caps are applied as the eligibility filter at
pipeline Step 5 (¬ß5.2.1), after computing <code>p_ij</code> and base
utility <code>U0_ij</code>, and before any optional continuous degree
regularization that produces <code>U_ij</code>.</p>
<p>Star caps: * do not modify utility values, * do not affect candidate
generation, * do not override hard invariants.</p>
<p>If star caps eliminate too many high-utility pairs, the standard
fallback ladder (¬ß5.3) applies unchanged.</p>
<hr>
</div>
<div class="section level4">
<h4 id="optional-continuous-degree-regularization-off-by-default">6.1.3 Optional Continuous Degree Regularization (off by
default)<a class="anchor" aria-label="anchor" href="#optional-continuous-degree-regularization-off-by-default"></a>
</h4>
<p>Continuous degree regularization may be enabled only as a secondary
guardrail if star behavior persists.</p>
<p>If enabled, it must satisfy all of the following:</p>
<ul>
<li>
<strong>Gated</strong>: applied only when both items have
<code>deg ‚â• 2</code>
</li>
<li>
<strong>Weak</strong>: exponent Œ± ‚â§ 0.1</li>
<li>
<strong>Capped</strong>: maximum penalty multiplier ‚â§ 2‚Äì3√ó</li>
</ul>
<p>Form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>U</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mi>e</mi><msub><mi>g</mi><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>d</mi><mi>e</mi><msub><mi>g</mi><mi>j</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>Œ±</mi></msup></mfrac></mrow><annotation encoding="application/x-tex">
U(i,j) = \frac{U_0(i,j)}{((deg_i+1)(deg_j+1))^{\alpha}}
</annotation></semantics></math></p>
<p>This option is disabled by default and should be activated only with
explicit justification.</p>
<hr>
</div>
<div class="section level4">
<h4 id="logging-and-audit">6.1.4 Logging and Audit<a class="anchor" aria-label="anchor" href="#logging-and-audit"></a>
</h4>
<p>The following star-cap diagnostics must be recorded:</p>
<p><strong>Per step (<code>step_log</code>):</strong></p>
<ul>
<li><code>star_cap_rejects</code></li>
<li>
<code>star_cap_reject_items</code> (count of unique items triggering
rejections)</li>
</ul>
<p><strong>Per refit (<code>round_log</code>):</strong></p>
<ul>
<li>total star-cap rejects since last refit</li>
<li>proportion of candidate rejections due to star caps</li>
<li>max and median <code>recent_deg</code>
</li>
</ul>
<p>These fields allow retrospective analysis of whether star caps were
binding and whether they materially influenced pairing behavior.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="pair-selection-procedure-round-controller-step-engine">7. Pair Selection Procedure (Round Controller + Step Engine)<a class="anchor" aria-label="anchor" href="#pair-selection-procedure-round-controller-step-engine"></a>
</h3>
<p>Pair selection still occurs as one-pair steps (¬ß2.1 Step definition),
but steps are scheduled by a round controller that enforces
Pollitt-style exposure and budgets global linking.</p>
<div class="section level4">
<h4 id="rolling-anchors-normative">7.1 Rolling anchors (normative)<a class="anchor" aria-label="anchor" href="#rolling-anchors-normative"></a>
</h4>
<p>Anchors are defined from the current ranking proxy and refreshed at
refit time (default) or optionally every round.</p>
<p>Normative default: refresh anchors every refit using BTL EAP means
when available; otherwise TrueSkill Œº.</p>
<p>Anchor set size: -
<code>k_total = clamp(10, 40, round(0.10 * N))</code> -
<code>k_top = round(0.30 * k_total)</code> - <code>k_bot = k_top</code>
- <code>k_mid = k_total - k_top - k_bot</code></p>
<p>Anchors are selected as: - <code>k_top</code> highest-ranked items, -
<code>k_bot</code> lowest-ranked items, - <code>k_mid</code> centered
around the median rank.</p>
<p>Anchors are used only for scheduling; they do not alter stopping
criteria.</p>
</div>
<div class="section level4">
<h4 id="round-controller-normative">7.2 Round controller (normative)<a class="anchor" aria-label="anchor" href="#round-controller-normative"></a>
</h4>
<p>This section describes execution of the round plan defined in ¬ß4.6;
it does not redefine quotas or cadence.</p>
<p>Each round plans <code>round_pairs_target</code> committed
comparisons (¬ß4.6.1) and proceeds through stages in order:</p>
<ol style="list-style-type: decimal">
<li>anchor_link until <code>anchor_quota</code> committed pairs</li>
<li>long_link until <code>long_quota</code> committed pairs</li>
<li>mid_link until <code>mid_quota</code> committed pairs</li>
<li>local_link until <code>local_quota</code> committed pairs</li>
</ol>
<p>Within each stage, each committed comparison is produced by executing
the standard step engine:</p>
<ul>
<li>generate candidates per stage (¬ß5.1),</li>
<li>apply the canonical pipeline (¬ß5.2.1) unchanged,</li>
<li>route to exploration vs exploitation per rules (¬ß7.5),</li>
<li>assign order with reversal and position-balance (¬ß7.6),</li>
<li>commit transactionally (¬ß2.2 invariant 2).</li>
</ul>
</div>
<div class="section level4">
<h4 id="stage-specific-partner-targeting-selection-scoring">7.2.1 Stage-specific partner targeting (selection scoring)<a class="anchor" aria-label="anchor" href="#stage-specific-partner-targeting-selection-scoring"></a>
</h4>
<p>Stage constraints define the candidate set. Within that set, apply
the selection rules: - exploitation: choose max utility (U0 or U if
regularization enabled) - exploration: use exploration logic, but
constrained to the stage‚Äôs candidate set</p>
</div>
<div class="section level4">
<h4 id="handling-stage-starvation-normative">7.2.2 Handling stage starvation (normative)<a class="anchor" aria-label="anchor" href="#handling-stage-starvation-normative"></a>
</h4>
<p>If a stage cannot produce valid pairs after exhausting its
within-stage fallback ladder (¬ß5.3), the round controller: - logs stage
starvation and the shortfall count, - proceeds to the next stage.</p>
<p>Stages are not revisited within the same round.</p>
</div>
<div class="section level4">
<h4 id="soft-pollitt-exposure-enforcement">7.2.3 Soft Pollitt exposure enforcement<a class="anchor" aria-label="anchor" href="#soft-pollitt-exposure-enforcement"></a>
</h4>
<p>Within a round, items are intended to appear at most once, but v3
permits a small repeat budget (¬ß5.1.6) to prevent deadlocks.</p>
</div>
<div class="section level4">
<h4 id="refit-cadence-and-continuity">7.2.4 Refit cadence and continuity<a class="anchor" aria-label="anchor" href="#refit-cadence-and-continuity"></a>
</h4>
<p>Refits are triggered exactly as in ¬ß4.3, using committed pairs only.
The existence of rounds does not change refit eligibility.</p>
<hr>
</div>
<div class="section level4">
<h4 id="degree-control-is-enforced-via-the-canonical-pipeline-normative">7.3 Degree control is enforced via the canonical pipeline
(normative)<a class="anchor" aria-label="anchor" href="#degree-control-is-enforced-via-the-canonical-pipeline-normative"></a>
</h4>
<p>Degree control is not a separate selection phase. It is enforced
<em>only</em> through the canonical candidate pipeline (¬ß5.2.1), which
fixes the order of computation and filtering for every stage and
fallback attempt.</p>
<p><strong>Normative implementation rule:</strong> - Star caps (¬ß6.1.1)
MUST be applied as an eligibility filter at pipeline Step 5 (¬ß5.2.1),
after computing <code>p_ij</code> / <code>U0_ij</code> and after
duplicate policy, and before any optional continuous degree
regularization.</p>
<p>Accordingly: - Star caps do not modify <code>U0_ij</code> values;
they only remove ineligible candidates. - If star caps eliminate too
many candidates, the fallback ladder (¬ß5.3) applies unchanged.</p>
<div class="section level5">
<h5 id="star-caps-default-enabled-1">7.3.1 Star caps (default enabled)<a class="anchor" aria-label="anchor" href="#star-caps-default-enabled-1"></a>
</h5>
<p>Star caps are defined in ¬ß6.1.1. This section adds only the
operational requirement that the step log captures star-cap effects at
the pipeline boundary:</p>
<p><strong>Logging (per step; required):</strong> -
<code>star_cap_rejects</code> - <code>star_cap_reject_items</code></p>
<p>If <code>global_identified == TRUE</code>, conditional star-cap
override behavior (¬ß6.1.1) may apply. Override usage and reasons must be
logged:</p>
<p><strong>Logging (per step; required):</strong> -
<code>star_override_used</code> - <code>star_override_reason</code></p>
</div>
<div class="section level5">
<h5 id="optional-continuous-degree-regularization-off-by-default-1">7.3.2 Optional continuous degree regularization (off by
default)<a class="anchor" aria-label="anchor" href="#optional-continuous-degree-regularization-off-by-default-1"></a>
</h5>
<p>If continuous degree regularization is enabled, it MUST be applied
only after star-cap filtering (pipeline Step 6), using:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><msub><mi>U</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>i</mi><mo>,</mo><mi>j</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><msup><mrow><mo stretchy="true" form="prefix">(</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">g</mi></mrow><mi>i</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mrow><mi mathvariant="normal">d</mi><mi mathvariant="normal">e</mi><mi mathvariant="normal">g</mi></mrow><mi>j</mi></msub><mo>+</mo><mn>1</mn><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mi>Œ±</mi></msup></mfrac></mrow><annotation encoding="application/x-tex">
U(i,j) = \frac{U_0(i,j)}{((\mathrm{deg}_i + 1)(\mathrm{deg}_j + 1))^{\alpha}}
</annotation></semantics></math></p>
<p>subject to: - <strong>Gated</strong>: applied only when both
endpoints have <code>deg ‚â• 2</code> - <strong>Weak</strong>:
<code>Œ± ‚â§ 0.1</code> - <strong>Capped</strong>: maximum penalty
multiplier ‚â§ 2‚Äì3√ó</p>
<p>When regularization is off (default), the final scoring utility is
<code>U_ij = U0_ij</code>.</p>
<p><strong>Logging (per step; required):</strong> -
<code>n_candidates_scored</code> must equal
<code>n_candidates_after_star_caps</code> when regularization is
off.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="filter-by-invariants-and-duplicate-policy-normative">7.4 Filter by invariants and duplicate policy (normative)<a class="anchor" aria-label="anchor" href="#filter-by-invariants-and-duplicate-policy-normative"></a>
</h4>
<p>Candidates are removed only for the following reasons:</p>
<p><strong>Hard invariant filters</strong> - self-pairs (i = j) are
forbidden, - transactional constraints (no partial commit; see ¬ß2.2
Invariant 2), - order-reversal feasibility for repeats (see ¬ß7.6): if
<code>{i,j}</code> has been committed before, only the required next
order is feasible.</p>
<p><strong>Duplicate policy</strong> - Apply default or relaxed
duplicate caps as specified by the active stage (¬ß5.3.2).</p>
<p><strong>Non-hard preferences (not filters)</strong> - Position
balance is a best-effort assignment at ordering time (¬ß7.6) and must not
be used to exclude an unordered pair.</p>
<hr>
<div class="section level5">
<h5 id="under-represented-set-normative">Under-represented set (normative)<a class="anchor" aria-label="anchor" href="#under-represented-set-normative"></a>
</h5>
<p>Define an under-represented set <code>underrep_set</code> for use by
coverage quota routing (¬ß3.2) and exploration selection (¬ß7.5.2):</p>
<ul>
<li>Let <code>deg[i]</code> be total committed degree.</li>
<li>Let <code>recent_deg[i]</code> be rolling-window participation
(¬ß6.1.1).</li>
</ul>
<p>Define: - <code>D_min = min_i deg[i]</code> -
<code>underrep_set = { i : deg[i] ‚â§ D_min + 1 }</code></p>
<p>If <code>underrep_set</code> is empty due to numerical issues, set
<code>underrep_set</code> to all items.</p>
<p>Implementation note: this definition is intentionally simple and
stable; star caps already control extreme recent imbalances.</p>
</div>
</div>
<div class="section level4">
<h4 id="select-the-next-pair-exploitation-vs-exploration">7.5 Select the next pair (exploitation vs exploration)<a class="anchor" aria-label="anchor" href="#select-the-next-pair-exploitation-vs-exploration"></a>
</h4>
<p>Selection chooses exactly one pair at each step.</p>
<div class="section level5">
<h5 id="coverage-quota-override-early-phase">7.5.1 Coverage quota override (early phase)<a class="anchor" aria-label="anchor" href="#coverage-quota-override-early-phase"></a>
</h5>
<p>While <code>min_degree &lt; 2</code>, enforce the early-phase
coverage quota (¬ß3.2) as a <strong>stepwise rule</strong>:</p>
<ul>
<li>With probability <code>quota_eps</code> (default 0.20), the selected
pair must include a low-degree endpoint.</li>
<li>Otherwise proceed normally.</li>
</ul>
<p>This rule is disabled after <code>min_degree ‚â• 2</code>.</p>
</div>
<div class="section level5">
<h5 id="exploration-routing-per-step">7.5.2 Exploration routing (per step)<a class="anchor" aria-label="anchor" href="#exploration-routing-per-step"></a>
</h5>
<p>If the quota override does not apply:</p>
<ul>
<li>With probability <code>explore_rate_used</code>, perform
<strong>exploration selection</strong>.</li>
<li>With probability
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mo>‚àí</mo><mtext mathvariant="normal">explore_rate_used</mtext></mrow><annotation encoding="application/x-tex">1 - \text{explore\_rate\_used}</annotation></semantics></math>,
perform <strong>exploitation selection</strong>.</li>
</ul>
<p><code>explore_rate_used</code> equals <code>explore_rate</code>
unless <code>global_identified == TRUE</code>, in which case it is
tapered per ¬ß4.2.</p>
<p>All exploration/exploitation selection is performed over the
candidate set defined by the active <code>round_stage</code> (i.e., the
stage constraint is applied before exploration partner choice).</p>
</div>
<div class="section level5">
<h5 id="exploration-selection-with-non-local-connections">Exploration selection (with non-local connections)<a class="anchor" aria-label="anchor" href="#exploration-selection-with-non-local-connections"></a>
</h5>
<p>Exploration is designed to improve representation and occasionally
create long-range constraints.</p>
<p>Exploration proceeds as follows:</p>
<ol style="list-style-type: decimal">
<li><p>Choose an endpoint <code>i</code> uniformly at random from
<code>underrep_set</code> (¬ß7.4).</p></li>
<li>
<p>Decide exploration mode:</p>
<ul>
<li>With probability <code>explore_nonlocal_rate</code>, use
<strong>non-local exploration</strong>.</li>
<li>Otherwise use <strong>local exploration</strong>.</li>
</ul>
</li>
</ol>
<p>Let <code>r(x)</code> denote the 1..N rank index of item
<code>x</code> in <code>rank_mu</code>.</p>
<ol start="3" style="list-style-type: decimal">
<li><p>Define eligible partners: <code>J(i)</code> = all <code>j</code>
such that <code>{i,j}</code> survives the canonical pipeline through
Step 5 (¬ß5.2.1), i.e., hard filters + duplicate policy + star
caps.</p></li>
<li><p>Select partner:</p></li>
</ol>
<p><strong>Local exploration (default):</strong> - Choose
<code>j ‚àà J(i)</code> that minimizes <code>|Œº_i - Œº_j|</code>. -
Tie-breaker 1: maximize <code>U0(i,j)</code> - Tie-breaker 2: minimize
<code>recent_deg[j]</code> - Tie-breaker 3: deterministic by
<code>item_id</code></p>
<p><strong>Non-local exploration:</strong> - Choose
<code>j ‚àà J(i)</code> that maximizes rank distance in
<code>rank_mu</code>: - maximize <code>|r(i) - r(j)|</code> -
Tie-breaker 1: maximize <code>U0(i,j)</code> (avoid obviously
uninformative extremes) - Tie-breaker 2: minimize
<code>recent_deg[j]</code> - Tie-breaker 3: deterministic by
<code>item_id</code></p>
<p>If no valid partner exists for sampled <code>i</code>, resample
<code>i</code> up to <code>explore_resample_max</code> times (default
10). If still no valid pair is found, invoke the fallback ladder (¬ß5.3),
and only set candidate_starved=TRUE if the ladder exhausts.</p>
<p><strong>Defaults:</strong></p>
<pre><code><span><span class="va">explore_resample_max</span> <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="va">explore_nonlocal_rate</span> <span class="op">=</span> <span class="fl">0.15</span></span></code></pre>
<p><strong>Logging:</strong> Each exploration step must log
<code>explore_mode ‚àà {local, nonlocal}</code>.</p>
</div>
<div class="section level5">
<h5 id="exploitation-selection">Exploitation selection<a class="anchor" aria-label="anchor" href="#exploitation-selection"></a>
</h5>
<ul>
<li>Select the single highest-utility remaining pair (by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>U</mi><mn>0</mn></msub><annotation encoding="application/x-tex">U_0</annotation></semantics></math>
or
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>U</mi><annotation encoding="application/x-tex">U</annotation></semantics></math>),
subject to invariants, star caps, and duplicate constraints.</li>
</ul>
</div>
<div class="section level5">
<h5 id="precedence-rule">Precedence rule<a class="anchor" aria-label="anchor" href="#precedence-rule"></a>
</h5>
<p>Coverage quota and exploration routing do not override hard
invariants, duplicate rules, or star caps. If the routed policy (quota
or exploration) cannot produce a valid pair, the step invokes the
fallback ladder (¬ß5.3). If all fallback stages fail, the run stops with
<code>candidate_starvation</code>.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="assign-presentation-order-ab-and-enforce-order-invariants-normative">7.6 Assign presentation order (A/B) and enforce order invariants
(normative)<a class="anchor" aria-label="anchor" href="#assign-presentation-order-ab-and-enforce-order-invariants-normative"></a>
</h4>
<p>After selecting an unordered pair <code>{i,j}</code>, assign ordered
presentation <code>(A,B)</code> using this priority:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Order-reversal invariant (hard):</strong> If
<code>pair_obs_count[{i,j}] &gt;= 1</code>, the next committed
observation must reverse the most recent committed order (from
pair_last_order) for this unordered pair.
<ul>
<li>If last committed order was <code>(i,j)</code>, require
<code>(j,i)</code> next.</li>
<li>If last committed order was <code>(j,i)</code>, require
<code>(i,j)</code> next.</li>
</ul>
</li>
<li>
<strong>Otherwise, position balance (best-effort):</strong> Choose
the order that reduces the absolute per-item imbalance:
<ul>
<li>define
<code>imbalance(x) = pos_count_A[x] - pos_count_B[x]</code>
</li>
<li>prefer assigning <code>x</code> to position A when
<code>imbalance(x)</code> is smaller (more negative) than its
partner‚Äôs.</li>
</ul>
</li>
<li>
<strong>Deterministic tie-break:</strong> If still tied, set
<code>A = min(i,j)</code> and <code>B = max(i,j)</code> (or any fixed
deterministic rule).</li>
</ol>
<p>Position assignment does not affect utility and must never invalidate
an unordered selection.</p>
<hr>
</div>
<div class="section level4">
<h4 id="fallback-ladder-if-starved">7.7 Fallback ladder if starved<a class="anchor" aria-label="anchor" href="#fallback-ladder-if-starved"></a>
</h4>
<p>If no valid pair can be selected at the current step:</p>
<ul>
<li>invoke the fallback ladder (¬ß5.3) within the step,</li>
<li>attempt progressively relaxed stages,</li>
<li>if all stages fail, stop with reason
<code>candidate_starvation</code>.</li>
</ul>
<p>All fallback activity and reasons are logged.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="mcmc-configuration-and-diagnostics">8. MCMC Configuration and Diagnostics<a class="anchor" aria-label="anchor" href="#mcmc-configuration-and-diagnostics"></a>
</h3>
<div class="section level4">
<h4 id="chains-and-parallelism">8.1 Chains and Parallelism<a class="anchor" aria-label="anchor" href="#chains-and-parallelism"></a>
</h4>
<ul>
<li>Default chains: <code>min(8, physical_cores)</code>
</li>
<li>Parallel chains: <code>min(chains, core_budget)</code>
</li>
</ul>
<p>All values must be printed at refit time.</p>
<hr>
</div>
<div class="section level4">
<h4 id="diagnostics-gate">8.2 Diagnostics Gate<a class="anchor" aria-label="anchor" href="#diagnostics-gate"></a>
</h4>
<p>Posterior is usable only if:</p>
<ul>
<li>Divergences = 0</li>
<li>Max R‚Äëhat ‚â§ 1.01</li>
<li>Min bulk ESS ‚â• applicable threshold</li>
</ul>
<p>Where the applicable threshold is:</p>
<ul>
<li>
<code>ess_bulk_min</code> before Phase 3 entry</li>
<li>
<code>ess_bulk_min_near_stop</code> after Phase 3 entry (¬ß5.4)</li>
</ul>
<hr>
</div>
<div class="section level4">
<h4 id="reliability-eap">8.3 Reliability (EAP)<a class="anchor" aria-label="anchor" href="#reliability-eap"></a>
</h4>
<p>EAP reliability is computed as:
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">Rel</mtext><mrow><mi>E</mi><mi>A</mi><mi>P</mi></mrow></msub><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">  
\text{Rel}_{EAP} = \frac{\mathrm{Var}(\mathbb{E}[\theta_i])}{\mathrm{Var}(\mathbb{E}[\theta_i]) + \mathbb{E}[\mathrm{Var}(\theta_i)]}
</annotation></semantics></math></p>
<p><strong>Interpretation:</strong> proportion of total variance
attributable to true between‚Äëitem differences.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="stopping-criteria">9. Stopping Criteria<a class="anchor" aria-label="anchor" href="#stopping-criteria"></a>
</h3>
<p>Stopping is based on posterior reliability and global stability. The
algorithm stops only when the posterior is diagnostically sound,
reliable, and stable across refits.</p>
<p>Stopping is evaluated at BTL refit rounds only and occurs immediately
when all required gates pass at an eligible refit.</p>
<hr>
</div>
<div class="section level3">
<h3 id="mcmc-diagnostics-gate">9.1 MCMC Diagnostics Gate<a class="anchor" aria-label="anchor" href="#mcmc-diagnostics-gate"></a>
</h3>
<p>All posterior quantities used by the adaptive algorithm‚Äîincluding
ranking, uncertainty estimates, utilities, reliability, and stopping
criteria‚Äîare considered valid only if the MCMC sampler passes a strict
diagnostics gate. This gate ensures that the posterior has been explored
accurately and that numerical artifacts do not influence downstream
decisions.</p>
<p>The diagnostics gate requires all three of the following conditions
to hold.</p>
<hr>
<div class="section level4">
<h4 id="divergences-must-be-zero">9.1.1 Divergences (must be zero)<a class="anchor" aria-label="anchor" href="#divergences-must-be-zero"></a>
</h4>
<p><strong>Definition</strong> A divergence is reported when Stan‚Äôs
Hamiltonian Monte Carlo (HMC) sampler encounters regions of the
posterior geometry that it cannot traverse accurately. Divergences
typically arise from:</p>
<ul>
<li>sharp curvature in the posterior,</li>
<li>funnel-like geometries,</li>
<li>or insufficient numerical resolution during integration.</li>
</ul>
<p><strong>Rule</strong></p>
<pre class="text"><code>Number of divergences = 0</code></pre>
<p><strong>Interpretation:</strong> Divergences indicate that some
regions of the posterior may be systematically under-sampled, even if
other diagnostics appear acceptable. When divergences are present,
posterior means, variances, and tail probabilities may be biased.</p>
<p><strong>Design stance:</strong> Any nonzero divergence count
invalidates the posterior for adaptive decision-making and stopping.
Sampling must continue or be corrected before results are trusted.</p>
<hr>
</div>
<div class="section level4">
<h4 id="r-hat-gelmanrubin-convergence-statistic">9.1.2 R-hat (Gelman‚ÄìRubin convergence statistic)<a class="anchor" aria-label="anchor" href="#r-hat-gelmanrubin-convergence-statistic"></a>
</h4>
<p><strong>Definition</strong> R-hat compares:</p>
<ul>
<li>variability <em>within</em> each MCMC chain</li>
<li>variability <em>between</em> chains</li>
</ul>
<p>If all chains have converged to the same target distribution, these
quantities should agree.</p>
<p>Formally, values close to 1 indicate convergence: [ ]</p>
<p><strong>Rule</strong></p>
<pre class="text"><code>max R-hat ‚â§ 1.01</code></pre>
<p><strong>Interpretation</strong></p>
<ul>
<li>( &gt; 1.01): chains have not fully mixed or converged</li>
<li>( ): chains are sampling from the same posterior distribution</li>
</ul>
<p>The threshold of 1.01 is intentionally conservative, reflecting the
fact that ranking stability and stopping criteria can be sensitive to
small posterior inaccuracies.</p>
<hr>
</div>
<div class="section level4">
<h4 id="effective-sample-size-ess">9.1.3 Effective Sample Size (ESS)<a class="anchor" aria-label="anchor" href="#effective-sample-size-ess"></a>
</h4>
<p><strong>Definition</strong></p>
<p>MCMC samples are autocorrelated. The effective sample size (ESS)
measures how many independent draws the correlated chain is equivalent
to.</p>
<p>Stan reports multiple ESS measures. This design uses bulk ESS, which
governs the accuracy of posterior means, variances, and
correlations.</p>
<hr>
<p><strong>Rule (normative)</strong></p>
<p>At refit <code>t</code>, define the required minimum bulk ESS:</p>
<pre><code>ESS_required(t) =
ess_bulk_min if Phase 3 has not been entered
ess_bulk_min_near_stop if Phase 3 has been entered</code></pre>
<p>The diagnostics gate requires:</p>
<pre class="text"><code>min bulk ESS ‚â• ESS_required(t)</code></pre>
<p><strong>Interpretation</strong></p>
<p>Bulk ESS below threshold indicates that Monte Carlo noise may still
meaningfully affect: - EAP estimates, - reliability calculations, -
lagged stability correlations, - stopping decisions.</p>
<p>Scaling ESS requirements with N ensures comparable numerical
reliability across problem sizes.</p>
<p><strong>Logging</strong></p>
<p>Each refit must log: - <code>min_ess_bulk</code> -
<code>ess_bulk_required</code> so that diagnostics decisions are fully
auditable.</p>
<hr>
</div>
<div class="section level4">
<h4 id="why-all-three-diagnostics-are-required">9.1.4 Why all three diagnostics are required<a class="anchor" aria-label="anchor" href="#why-all-three-diagnostics-are-required"></a>
</h4>
<p>Each diagnostic detects a distinct failure mode:</p>
<table class="table">
<thead><tr class="header">
<th>Diagnostic</th>
<th>Detects</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>Divergences</td>
<td>Posterior geometry / bias problems</td>
</tr>
<tr class="even">
<td>R-hat</td>
<td>Lack of convergence or chain disagreement</td>
</tr>
<tr class="odd">
<td>ESS</td>
<td>Excess Monte Carlo noise</td>
</tr>
</tbody>
</table>
<p>All three conditions must pass to ensure that:</p>
<ul>
<li>posterior means are accurate,</li>
<li>uncertainty estimates are trustworthy,</li>
<li>ranking stability metrics are meaningful,</li>
<li>stopping decisions are defensible.</li>
</ul>
<hr>
</div>
<div class="section level4">
<h4 id="operational-rule">9.1.5 Operational rule<a class="anchor" aria-label="anchor" href="#operational-rule"></a>
</h4>
<blockquote>
<p><strong>No diagnostics, no decisions.</strong></p>
</blockquote>
<p>If any diagnostic fails:</p>
<ul>
<li>the posterior is treated as provisional,</li>
<li>adaptive sampling may continue,</li>
<li>but reliability checks, uncertainty gates, and stopping criteria are
suspended until diagnostics pass.</li>
</ul>
<p>This guarantees that all reported rankings and termination decisions
are based on numerically sound Bayesian inference, not sampling
artifacts.</p>
<hr>
</div>
<div class="section level4">
<h4 id="reliability-gate-eap">9.2 Reliability Gate (EAP)<a class="anchor" aria-label="anchor" href="#reliability-gate-eap"></a>
</h4>
<p>Bayesian EAP reliability is computed as defined in ¬ß8.3:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="normal">Rel</mtext><mrow><mi>E</mi><mi>A</mi><mi>P</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>‚à£</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><mrow><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>‚à£</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">]</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow><mo>+</mo><mi>ùîº</mi><mrow><mo stretchy="true" form="prefix">[</mo><mrow><mi mathvariant="normal">V</mi><mi mathvariant="normal">a</mi><mi mathvariant="normal">r</mi></mrow><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>Œ∏</mi><mi>i</mi></msub><mo>‚à£</mo><mtext mathvariant="normal">data</mtext><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">]</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\text{Rel}_{EAP}(t) =
\frac{\mathrm{Var}(\mathbb{E}[\theta_i \mid \text{data}])}
{\mathrm{Var}(\mathbb{E}[\theta_i \mid \text{data}]) + \mathbb{E}[\mathrm{Var}(\theta_i \mid \text{data})]}
</annotation></semantics></math></p>
<div class="section level5">
<h5 id="condition">Condition<a class="anchor" aria-label="anchor" href="#condition"></a>
</h5>
<pre><code>Rel_EAP(t) ‚â• eap_reliability_min</code></pre>
</div>
<div class="section level5">
<h5 id="logged-flag">Logged flag<a class="anchor" aria-label="anchor" href="#logged-flag"></a>
</h5>
<ul>
<li>
<code>eap_pass</code> = TRUE if the condition holds at refit
<em>t</em>, FALSE otherwise</li>
</ul>
</div>
<div class="section level5">
<h5 id="interpretation">Interpretation<a class="anchor" aria-label="anchor" href="#interpretation"></a>
</h5>
<p>When this gate passes, the majority of observed variation in item
estimates reflects <strong>true between-item differences</strong>, not
posterior uncertainty.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="theta-stability-gate-lagged">9.3 Theta Stability Gate (Lagged)<a class="anchor" aria-label="anchor" href="#theta-stability-gate-lagged"></a>
</h4>
<div class="section level5">
<h5 id="eligibility">Eligibility<a class="anchor" aria-label="anchor" href="#eligibility"></a>
</h5>
<p>Lagged stability metrics are evaluated only when a valid lagged
comparison exists.</p>
<p>Specifically, the theta stability gate is eligible at refit
<em>t</em> if:</p>
<pre><code><span><span class="va">t</span> <span class="op">&gt;</span> <span class="va">stability_lag</span></span></code></pre>
<p>When ineligible, all lagged metrics and pass flags are recorded as
<code>NA</code>.</p>
</div>
<div class="section level5">
<h5 id="definitions">Definitions<a class="anchor" aria-label="anchor" href="#definitions"></a>
</h5>
<p>Let:</p>
<ul>
<li>
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msup><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><annotation encoding="application/x-tex">\hat\theta^{(t)}</annotation></semantics></math>
be the vector of item <strong>EAP</strong> estimates at refit
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>t</mi><annotation encoding="application/x-tex">t</annotation></semantics></math>
</li>
<li><math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>L</mi><mo>=</mo><mtext mathvariant="normal">stability_lag</mtext></mrow><annotation encoding="application/x-tex">L = \text{stability\_lag}</annotation></semantics></math></li>
</ul>
<p>Compute:</p>
<ol style="list-style-type: decimal">
<li><p><strong>Lagged theta correlation</strong>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÅ</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>cor</mo><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">(</mo><msup><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo>,</mo><mspace width="0.167em"></mspace><msup><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>‚àí</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo minsize="1.2" maxsize="1.2" stretchy="false" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">
\rho_{\theta}(t) = \operatorname{cor}\big(\hat\theta^{(t)},\, \hat\theta^{(t-L)}\big)
</annotation></semantics></math></p></li>
<li><p><strong>Relative change in theta spread</strong>
<math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Œî</mi><mi>S</mi><msub><mi>D</mi><mi>Œ∏</mi></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">|</mo><mi>S</mi><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo>‚àí</mo><mi>S</mi><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>‚àí</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo minsize="1.2" maxsize="1.2" stretchy="false" form="prefix">|</mo></mrow><mrow><mi>S</mi><mi>D</mi><mrow><mo stretchy="true" form="prefix">(</mo><msup><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>‚àí</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow></msup><mo stretchy="true" form="postfix">)</mo></mrow></mrow></mfrac></mrow><annotation encoding="application/x-tex">
\Delta SD_{\theta}(t) = \frac{\big|SD(\hat\theta^{(t)}) - SD(\hat\theta^{(t-L)})\big|}{SD(\hat\theta^{(t-L)})}
</annotation></semantics></math></p></li>
</ol>
<p>Implementation notes (normative for reproducibility):</p>
<ul>
<li>Correlations must use <code>use="pairwise.complete.obs"</code>.</li>
<li>If <code>SD(Œ∏^(t-L)) = 0</code>, set <code>ŒîSD_theta(t) = NA</code>
and <code>delta_sd_theta_pass = NA</code>.</li>
</ul>
</div>
<div class="section level5">
<h5 id="conditions">Conditions<a class="anchor" aria-label="anchor" href="#conditions"></a>
</h5>
<pre><code>rho_theta(t) ‚â• theta_corr_min
ŒîSD_theta(t) ‚â§ theta_sd_rel_change_max</code></pre>
</div>
<div class="section level5">
<h5 id="logged-flags">Logged flags<a class="anchor" aria-label="anchor" href="#logged-flags"></a>
</h5>
<ul>
<li><code>theta_corr_pass</code></li>
<li><code>delta_sd_theta_pass</code></li>
</ul>
<p>Each flag is TRUE or FALSE when eligible, and NA otherwise.</p>
</div>
<div class="section level5">
<h5 id="interpretation-1">Interpretation<a class="anchor" aria-label="anchor" href="#interpretation-1"></a>
</h5>
<p>The latent scale is no longer meaningfully reshaping or expanding as
new data arrive.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="rank-stability-gate-lagged">9.4 Rank Stability Gate (Lagged)<a class="anchor" aria-label="anchor" href="#rank-stability-gate-lagged"></a>
</h4>
<p>This gate ensures that the <strong>implied ranking itself has
stabilized</strong>, not just the numeric latent scale.</p>
<div class="section level5">
<h5 id="eligibility-1">Eligibility<a class="anchor" aria-label="anchor" href="#eligibility-1"></a>
</h5>
<p>The rank stability gate is eligible at refit <em>t</em> if:</p>
<pre><code><span><span class="va">t</span> <span class="op">&gt;</span> <span class="va">stability_lag</span></span></code></pre>
<p>Otherwise, rank stability metrics are recorded as
<code>NA</code>.</p>
</div>
<div class="section level5">
<h5 id="definition-1">Definition<a class="anchor" aria-label="anchor" href="#definition-1"></a>
</h5>
<p>Let <code>rank(t)</code> be the ranking induced by the EAP estimates
at refit <em>t</em>.</p>
<p>Compute the lagged Spearman rank correlation:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>œÅ</mi><mtext mathvariant="normal">rank</mtext></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mo>Spearman</mo><mrow><mo stretchy="true" form="prefix">(</mo><mtext mathvariant="normal">rank</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>,</mo><mspace width="0.167em"></mspace><mtext mathvariant="normal">rank</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>‚àí</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
\rho_{\text{rank}}(t) =
\operatorname{Spearman}(\text{rank}(t),\, \text{rank}(t-L))
</annotation></semantics></math></p>
<p>Implementation notes (normative for reproducibility):</p>
<ul>
<li>Induced ranks must be computed with deterministic tie handling:
<ul>
<li><code>rank(theta_eap, ties.method="average")</code></li>
</ul>
</li>
</ul>
</div>
<div class="section level5">
<h5 id="condition-1">Condition<a class="anchor" aria-label="anchor" href="#condition-1"></a>
</h5>
<pre><code>rho_rank(t) ‚â• rank_spearman_min</code></pre>
</div>
<div class="section level5">
<h5 id="logged-flag-1">Logged flag<a class="anchor" aria-label="anchor" href="#logged-flag-1"></a>
</h5>
<ul>
<li>
<code>rho_rank_pass</code> (TRUE/FALSE when eligible; NA
otherwise)</li>
</ul>
</div>
<div class="section level5">
<h5 id="interpretation-2">Interpretation<a class="anchor" aria-label="anchor" href="#interpretation-2"></a>
</h5>
<p>When this gate passes, remaining posterior movement no longer alters
the global ordering in a meaningful way.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="stopping-configuration-summary-defaults">9.5 Stopping Configuration Summary (Defaults)<a class="anchor" aria-label="anchor" href="#stopping-configuration-summary-defaults"></a>
</h4>
<table class="table">
<colgroup>
<col width="34%">
<col width="56%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th>Parameter</th>
<th>Meaning</th>
<th>Default</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>eap_reliability_min</code></td>
<td>Minimum EAP reliability required</td>
<td><code>0.90</code></td>
</tr>
<tr class="even">
<td><code>stability_lag</code></td>
<td>Lag (in refits) for stability comparisons</td>
<td><code>2</code></td>
</tr>
<tr class="odd">
<td><code>theta_corr_min</code></td>
<td>Minimum lagged theta correlation</td>
<td><code>0.95</code></td>
</tr>
<tr class="even">
<td><code>theta_sd_rel_change_max</code></td>
<td>Maximum relative change in theta SD</td>
<td><code>0.10</code></td>
</tr>
<tr class="odd">
<td><code>rank_spearman_min</code></td>
<td>Minimum lagged rank correlation</td>
<td><code>0.95</code></td>
</tr>
</tbody>
</table>
<p>All stopping parameters are fully configurable. Stopping occurs
immediately when all applicable gates pass at an eligible refit.</p>
<hr>
</div>
</div>
<div class="section level3">
<h3 id="outputs-and-logs">10. Outputs and Logs<a class="anchor" aria-label="anchor" href="#outputs-and-logs"></a>
</h3>
<p>The primary adaptive outputs are the <code>step_log</code>,
<code>round_log</code>, and <code>item_log</code>. Any additional
summary tables are derived views of these logs and must not introduce
new computed quantities or alter recorded values. All stopping decisions
must be reproducible directly from the logged fields.</p>
<div class="section level4">
<h4 id="per-step-log-step_log">10.1 Per-Step Log (<code>step_log</code>)<a class="anchor" aria-label="anchor" href="#per-step-log-step_log"></a>
</h4>
<p>One row per adaptive <strong>step</strong> (one attempted pair
selection). This log supports audit of selection behavior, feasibility,
and fallbacks.</p>
<p>At minimum, each <code>step_log</code> row must include:</p>
<div class="section level5">
<h5 id="step-identity-and-outcome">Step identity and outcome<a class="anchor" aria-label="anchor" href="#step-identity-and-outcome"></a>
</h5>
<ul>
<li><code>step_id</code></li>
<li>
<code>pair_id</code> (monotone index of committed comparisons;
<code>NA</code> if no pair committed)</li>
<li>selected items: <code>i</code>, <code>j</code> (unordered endpoints;
<code>NA</code> if none selected)</li>
<li>ordered presentation: <code>A</code>, <code>B</code> (ordered;
<code>NA</code> if none selected)</li>
<li>outcome <code>Y</code> (1 = A wins, 0 = B wins; <code>NA</code> if
no committed result)</li>
</ul>
</div>
<div class="section level5">
<h5 id="selection-routing-and-health">Selection routing and health<a class="anchor" aria-label="anchor" href="#selection-routing-and-health"></a>
</h5>
<ul>
<li>
<code>is_explore_step</code> (TRUE/FALSE)</li>
<li>
<code>explore_mode</code> (<code>local</code>,
<code>nonlocal</code>, or <code>NA</code>)</li>
<li>
<code>explore_reason</code> (e.g., <code>probabilistic</code>,
<code>coverage_quota_override</code>, <code>NA</code>)</li>
<li>
<code>candidate_starved</code> (TRUE/FALSE)</li>
<li>
<code>fallback_used</code> (one of: <code>base</code>,
<code>expand_locality</code>, <code>uncertainty_pool</code>,
<code>dup_relax</code>, <code>global_safe</code>; <code>base</code> if
none)</li>
<li>
<code>fallback_path</code> (e.g.,
<code>base&gt;expand_locality&gt;dup_relax</code>; <code>base</code> if
none)</li>
<li>
<code>starvation_reason</code> (best-effort; <code>NA</code> if not
starved)</li>
<li>
<code>explore_rate_used</code> (numeric; effective exploration rate
applied at this step)</li>
<li>
<code>local_priority_mode</code> (<code>standard</code>,
<code>near_tie</code>, <code>boundary</code>, or <code>NA</code>)</li>
<li>
<code>long_gate_pass</code> (TRUE/FALSE/NA)</li>
<li>
<code>long_gate_reason</code> (e.g., <code>posterior_extreme</code>,
<code>posterior_unavailable</code>, <code>NA</code>)</li>
<li>
<code>star_override_used</code> (TRUE/FALSE) (should be FALSE (not
NA) when a pair is committed and no override was needed, and NA only
when no pair was selected)</li>
<li>
<code>star_override_reason</code> (e.g.,
<code>near_tie_override</code>, <code>budget_exhausted</code>,
<code>deg_extreme</code>, <code>NA</code>)</li>
</ul>
</div>
<div class="section level5">
<h5 id="candidate-counts-per-step-aligned-to-canonical-pipeline-5-2-1">Candidate counts (per step; aligned to canonical pipeline
¬ß5.2.1)<a class="anchor" aria-label="anchor" href="#candidate-counts-per-step-aligned-to-canonical-pipeline-5-2-1"></a>
</h5>
<ul>
<li><code>n_candidates_generated</code></li>
<li><code>n_candidates_after_hard_filters</code></li>
<li><code>n_candidates_after_duplicates</code></li>
<li><code>n_candidates_after_star_caps</code></li>
<li>
<code>n_candidates_scored</code> (equals
<code>n_candidates_after_star_caps</code> when degree regularization is
off)</li>
</ul>
</div>
<div class="section level5">
<h5 id="key-endpoint-diagnostics">Key endpoint diagnostics<a class="anchor" aria-label="anchor" href="#key-endpoint-diagnostics"></a>
</h5>
<ul>
<li>
<code>deg_i</code>, <code>deg_j</code>
</li>
<li>
<code>recent_deg_i</code>, <code>recent_deg_j</code>
</li>
<li>
<code>mu_i</code>, <code>mu_j</code>
</li>
<li>
<code>sigma_i</code>, <code>sigma_j</code>
</li>
<li>
<code>p_ij</code> and <code>U0_ij</code> for the selected pair (if
committed; else <code>NA</code>)</li>
</ul>
</div>
<div class="section level5">
<h5 id="round-scheduling-and-strata-fields">Round scheduling and strata fields<a class="anchor" aria-label="anchor" href="#round-scheduling-and-strata-fields"></a>
</h5>
<ul>
<li><p><code>round_id</code> (current round index; increments when a new
round begins)</p></li>
<li><p><code>round_stage</code> ‚àà {<code>anchor_link</code>,
<code>long_link</code>, <code>mid_link</code>,
<code>local_link</code>}</p></li>
<li><p><code>pair_type</code> (alias of <code>round_stage</code>;
included for convenience)</p></li>
<li><p><code>used_in_round_i</code>, <code>used_in_round_j</code> (0/1/2
usage counts at time of selection; <code>NA</code> if no
selection)</p></li>
<li><p><code>is_anchor_i</code>, <code>is_anchor_j</code>
(TRUE/FALSE/NA)</p></li>
<li><p><code>stratum_i</code>, <code>stratum_j</code> (integer stratum
ids; <code>NA</code> if no selection)</p></li>
<li><p><code>dist_stratum</code> (|stratum_i ‚àí stratum_j|;
<code>NA</code> if no selection)</p></li>
<li><p><code>stage_committed_so_far</code> (committed pairs already
produced within this round and stage, prior to this step;
<code>NA</code> if not applicable)</p></li>
<li><p><code>stage_quota</code> (target committed pairs for this
round-stage; <code>NA</code> if not applicable)</p></li>
</ul>
</div>
<div class="section level5">
<h5 id="star-cap-diagnostics-per-step">Star-cap diagnostics (per step)<a class="anchor" aria-label="anchor" href="#star-cap-diagnostics-per-step"></a>
</h5>
<ul>
<li><code>star_cap_rejects</code></li>
<li>
<code>star_cap_reject_items</code> (unique items triggering star-cap
rejections)</li>
</ul>
<p>This schema is intentionally redundant to support debugging,
regression tests, and post-hoc analysis.</p>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="per-refit-log-round_log">10.2 Per-Refit Log (<code>round_log</code>)<a class="anchor" aria-label="anchor" href="#per-refit-log-round_log"></a>
</h4>
<p>Despite its name, <code>round_log</code> records one row per Bayesian
refit (not per Pollitt-style round). The field
<code>round_id_at_refit</code> links each refit to the most recent
completed scheduling round.</p>
<p>This log is the primary ‚Äústop audit trail‚Äù: every stopping decision
must be reproducible from these fields.</p>
<p>At minimum, each <code>round_log</code> row must include:</p>
<div class="section level5">
<h5 id="run-scale-sampling-state">Run scale / sampling state<a class="anchor" aria-label="anchor" href="#run-scale-sampling-state"></a>
</h5>
<ul>
<li>
<code>refit_id</code> (1, 2, ‚Ä¶; one row per Bayesian refit)</li>
<li>
<code>round_id_at_refit</code> (the Pollitt-style round index at the
time this refit was run)</li>
<li><code>step_id_at_refit</code></li>
<li><code>model_variant</code></li>
<li><code>n_items</code></li>
<li>
<code>total_pairs_done</code> (total committed comparisons at
refit)</li>
<li><code>new_pairs_since_last_refit</code></li>
<li><code>n_unique_pairs_seen</code></li>
</ul>
</div>
<div class="section level5">
<h5 id="candidateselection-health-stepwise">Candidate/selection health (stepwise)<a class="anchor" aria-label="anchor" href="#candidateselection-health-stepwise"></a>
</h5>
<ul>
<li>
<code>proposed_pairs_mode</code> (typical
<code>n_candidates_scored</code> per step since last refit; e.g.,
median)</li>
<li>
<code>starve_rate_since_last_refit</code> (fraction of steps with
<code>candidate_starved=TRUE</code>)</li>
<li>
<code>fallback_rate_since_last_refit</code> (fraction of steps with
<code>fallback_used != base</code>, where <code>base</code> denotes no
fallback beyond the stage‚Äôs default candidate rule).</li>
<li>
<code>fallback_used_mode</code> (most frequent fallback stage since
last refit)</li>
<li>
<code>starvation_reason_mode</code> (most frequent starvation reason
among starved steps)</li>
</ul>
</div>
<div class="section level5">
<h5 id="global-identifiability-and-quota-adaptation">Global identifiability and quota adaptation<a class="anchor" aria-label="anchor" href="#global-identifiability-and-quota-adaptation"></a>
</h5>
<ul>
<li><p><code>global_identified</code> (TRUE/FALSE)</p></li>
<li><p><code>global_identified_reliability_min</code></p></li>
<li><p><code>global_identified_rank_corr_min</code></p></li>
<li><p><code>long_quota_raw</code></p></li>
<li><p><code>long_quota_effective</code></p></li>
<li><p><code>long_quota_removed</code></p></li>
<li><p><code>realloc_to_mid</code></p></li>
<li><p><code>realloc_to_local</code></p></li>
</ul>
<p>These quota fields refer to the most recently completed Pollitt-style
round prior to the refit (i.e., the round indexed by
<code>round_id_at_refit</code>).</p>
</div>
<div class="section level5">
<h5 id="imbalance-coverage-diagnostics">Imbalance / coverage diagnostics<a class="anchor" aria-label="anchor" href="#imbalance-coverage-diagnostics"></a>
</h5>
<ul>
<li>
<code>mean_degree</code>, <code>min_degree</code>
</li>
<li>
<code>pos_balance_sd</code> (SD of per-item position balance; near 0
is ideal)</li>
</ul>
</div>
<div class="section level5">
<h5 id="model-parameter-monitoring-posterior-percentiles">Model-parameter monitoring (posterior percentiles)<a class="anchor" aria-label="anchor" href="#model-parameter-monitoring-posterior-percentiles"></a>
</h5>
<p>For any global model parameters included in the fitted model,
<code>round_log</code> must record posterior mean and a fixed set of
percentiles.</p>
<ul>
<li>
<p><strong>Lapse rate</strong> <code>epsilon</code> (Models B and D;
otherwise <code>NA</code>):</p>
<ul>
<li><code>epsilon_mean</code></li>
<li>
<code>epsilon_p2.5</code>, <code>epsilon_p5</code>,
<code>epsilon_p50</code>, <code>epsilon_p95</code>,
<code>epsilon_p97.5</code>
</li>
</ul>
</li>
<li>
<p><strong>Position bias</strong> <code>b</code> (Models C and D;
otherwise <code>NA</code>):</p>
<ul>
<li><code>b_mean</code></li>
<li>
<code>b_p2.5</code>, <code>b_p5</code>, <code>b_p50</code>,
<code>b_p95</code>, <code>b_p97.5</code>
</li>
</ul>
</li>
</ul>
</div>
<div class="section level5">
<h5 id="trueskill-monitoring-audit-only">TrueSkill monitoring (audit-only)<a class="anchor" aria-label="anchor" href="#trueskill-monitoring-audit-only"></a>
</h5>
<ul>
<li>
<p>TrueSkill summary at refit:</p>
<ul>
<li><code>ts_sigma_mean</code></li>
<li><code>ts_sigma_max</code></li>
<li><code>ts_degree_sigma_corr</code></li>
</ul>
</li>
<li>
<p>Alignment with BTL estimates:</p>
<ul>
<li><code>ts_btl_theta_corr</code></li>
<li><code>ts_btl_rank_spearman</code></li>
</ul>
</li>
</ul>
</div>
<div class="section level5">
<h5 id="near-tie-and-credible-interval-width-diagnostics-btl-posterior-audit-interpretability">Near-tie and credible-interval width diagnostics (BTL posterior;
audit + interpretability)<a class="anchor" aria-label="anchor" href="#near-tie-and-credible-interval-width-diagnostics-btl-posterior-audit-interpretability"></a>
</h5>
<p>These diagnostics do not affect stopping directly unless explicitly
configured, but must be logged to support the ‚Äúresidual uncertainty
dominated by near-ties‚Äù interpretation.</p>
<p>Compute per-item 95% credible-interval widths:</p>
<ul>
<li><code>ci95_theta_width_i = theta_p97.5[i] - theta_p2.5[i]</code></li>
</ul>
<p>Log summary widths:</p>
<ul>
<li>
<code>ci95_theta_width_mean</code> = mean of
<code>ci95_theta_width_i</code>
</li>
<li>
<code>ci95_theta_width_median</code> = median of
<code>ci95_theta_width_i</code>
</li>
<li>
<code>ci95_theta_width_p90</code> = 90th percentile of
<code>ci95_theta_width_i</code>
</li>
<li>
<code>ci95_theta_width_max</code> = max of
<code>ci95_theta_width_i</code>
</li>
</ul>
<p>Compute near-tie diagnostics based on posterior win-probabilities for
adjacent ranks:</p>
<ul>
<li>Let items be ordered by EAP rank at refit <code>t</code>:
<code>r1, r2, ..., rN</code>.</li>
<li>For each adjacent pair <code>(r_k, r_{k+1})</code>, compute:
<ul>
<li><code>p_adj_k = Pr(theta_{r_k} &gt; theta_{r_{k+1}} | posterior)</code></li>
<li><code>near_tie_k = (p_adj_k ‚àà [near_tie_p_low, near_tie_p_high])</code></li>
</ul>
</li>
</ul>
<p>Log:</p>
<ul>
<li>
<code>near_tie_adj_frac</code> = mean of <code>near_tie_k</code>
over k=1..N-1</li>
<li>
<code>near_tie_adj_count</code> = sum of
<code>near_tie_k</code>
</li>
<li>
<code>p_adj_median</code> = median of <code>p_adj_k</code>
</li>
</ul>
<p>Defaults:</p>
<pre><code><span><span class="va">near_tie_p_low</span> <span class="op">=</span> <span class="fl">0.40</span></span>
<span><span class="va">near_tie_p_high</span> <span class="op">=</span> <span class="fl">0.60</span></span></code></pre>
<p>Implementation note (normative): estimate <code>p_adj_k</code> using
posterior draws as: -
<code>p_adj_k = mean( I(theta_draw[r_k] &gt; theta_draw[r_{k+1}]) )</code>
computed over all retained post-warmup draws (across all chains).</p>
</div>
<div class="section level5">
<h5 id="additional-global-efficiency-metrics-report-only-not-used-for-stopping">Additional global efficiency metrics (report-only; not used for
stopping)<a class="anchor" aria-label="anchor" href="#additional-global-efficiency-metrics-report-only-not-used-for-stopping"></a>
</h5>
<p>Posterior concentration / covariance (Œ∏): -
<code>cov_trace_theta</code> (trace of posterior covariance of Œ∏; lower
is better concentration) - <code>cov_logdet_diag_theta</code> (log det
of diag(cov(Œ∏)); stable proxy for overall uncertainty) -
<code>post_sd_theta_p10</code>, <code>post_sd_theta_p50</code>,
<code>post_sd_theta_p90</code> (distribution of per-item posterior
SDs)</p>
<p>Top-k decision uncertainty: -
<code>top20_boundary_entropy_mean</code> (uncertainty mass around the
top-20 cutoff; lower is better) -
<code>top20_boundary_entropy_p90</code></p>
<p>Local separation uncertainty: - <code>nn_diff_sd_mean</code>
(posterior SD of adjacent-rank Œ∏ differences; lower indicates cleaner
local separation) - <code>nn_diff_sd_p90</code></p>
</div>
<div class="section level5">
<h5 id="stopping-gates-and-core-posterior-summaries">Stopping gates and core posterior summaries<a class="anchor" aria-label="anchor" href="#stopping-gates-and-core-posterior-summaries"></a>
</h5>
<ul>
<li>
<code>diagnostics_pass</code>, <code>divergences</code>,
<code>max_rhat</code>, <code>min_ess_bulk</code>,
<code>ess_bulk_required</code>
</li>
<li><code>reliability_EAP</code></li>
<li><code>theta_sd_eap</code></li>
<li>
<code>rho_theta</code> and <code>delta_sd_theta</code> (lagged theta
stability; ¬ß9.3)</li>
<li>
<code>rho_rank</code> and <code>rho_rank_pass</code> (lagged rank
stability; ¬ß9.4)</li>
</ul>
<p>Lagged metrics are computed only when eligible; otherwise
<code>NA</code>.</p>
</div>
<div class="section level5">
<h5 id="stop-decision">Stop decision<a class="anchor" aria-label="anchor" href="#stop-decision"></a>
</h5>
<ul>
<li>
<code>stop_decision</code> (TRUE/FALSE)</li>
<li>
<code>stop_reason</code> (if stopped)</li>
</ul>
<hr>
</div>
</div>
<div class="section level4">
<h4 id="item-level-log-item_log">10.3 Item-Level Log (<code>item_log</code>)<a class="anchor" aria-label="anchor" href="#item-level-log-item_log"></a>
</h4>
<p>Item-level posterior summaries are recorded at each refit.</p>
<p>The item log is stored internally as a list of per-refit tables,
indexed by refit number. Each table contains item-level posterior
summaries for that refit.</p>
<div class="section level5">
<h5 id="contents-per-refit">Contents (per refit)<a class="anchor" aria-label="anchor" href="#contents-per-refit"></a>
</h5>
<p>At minimum, each item-level table includes:</p>
<ul>
<li><code>refit_id</code></li>
<li><code>item_id</code></li>
<li>posterior mean
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mover><mi>Œ∏</mi><mo accent="true">ÃÇ</mo></mover><annotation encoding="application/x-tex">\hat\theta</annotation></semantics></math>
</li>
<li>posterior percentiles (e.g., p2.5 / p50 / p97.5)</li>
<li>induced rank</li>
<li>item degree</li>
<li>position exposure counts</li>
</ul>
</div>
<div class="section level5">
<h5 id="access-and-summaries">Access and summaries<a class="anchor" aria-label="anchor" href="#access-and-summaries"></a>
</h5>
<ul>
<li>By default, summary functions return the most recent refit‚Äôs item
table.</li>
<li>Users may request a specific refit by numeric index.</li>
<li>Optionally, all refits may be stacked for longitudinal
analysis.</li>
</ul>
</div>
<div class="section level5">
<h5 id="disk-writing">Disk writing<a class="anchor" aria-label="anchor" href="#disk-writing"></a>
</h5>
<p>Writing item-level logs to disk is optional. When enabled, one file
per refit is written. Item-level logging itself is always performed
in-memory, regardless of disk output settings.</p>
<hr>
</div>
</div>
</div>
<div class="section level3">
<h3 id="interpretation-guarantees">11. Interpretation Guarantees<a class="anchor" aria-label="anchor" href="#interpretation-guarantees"></a>
</h3>
<p>When the algorithm stops:</p>
<ul>
<li>Ranking is globally stable</li>
<li>Residual uncertainty is dominated by near‚Äëties</li>
<li>MCMC error is negligible</li>
<li>Sampling imbalance is controlled and measurable</li>
<li>ESS thresholds scale with problem size, ensuring that numerical
precision of posterior summaries is comparable across different values
of <code>N</code>.</li>
</ul>
<hr>
</div>
<div class="section level3">
<h3 id="design-philosophy">12. Design Philosophy<a class="anchor" aria-label="anchor" href="#design-philosophy"></a>
</h3>
<ul>
<li>TrueSkill model to guide adaptive pairing; Bayesian BTL model to
determine stopping</li>
<li>One utility</li>
<li>Explicit invariants</li>
<li>Adaptive but auditable</li>
<li>Defaults scale with N</li>
<li>Diagnostics first, always</li>
<li>
<strong>User-facing documentation:</strong> All exported functions
and outputs must include detailed Roxygen documentation describing
argument options (including model variants and stopping parameters),
defaults, and the meaning/interpretation of key output columns. A user
should be able to understand what each logged value means without
inspecting implementation code.</li>
</ul>
</div>
<div class="section level3">
<h3 id="citation">13. Citation<a class="anchor" aria-label="anchor" href="#citation"></a>
</h3>
<blockquote>
<p>Mercer, S. H. (2026). <em>Bayesian BTL adaptive pairing design</em>
[R package vignette]. In <em>pairwiseLLM: Pairwise comparison tools for
large language model-based writing evaluation</em>. <a href="https://doi.org/10.32614/CRAN.package.pairwiseLLM" class="external-link uri">https://doi.org/10.32614/CRAN.package.pairwiseLLM</a></p>
</blockquote>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Sterett H. Mercer.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.2.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
