<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Advanced: Submitting and Polling Multiple Batches</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Advanced: Submitting and Polling Multiple
Batches</h1>



<div id="overview" class="section level1">
<h1>1. Overview</h1>
<p>This vignette demonstrates how to use <strong>pairwiseLLM</strong>
for more complex <strong>batch workflows</strong>, including:</p>
<ul>
<li>Submitting many batches at once (e.g., across templates, providers,
models, and “thinking” settings)</li>
<li>Polling batches until they complete</li>
<li>Downloading and parsing batch results</li>
<li>Writing a <strong>batch registry CSV</strong> so you can safely
<strong>resume</strong> after interruptions</li>
</ul>
<p>The examples are based on the A/B template testing dev scripts
for:</p>
<ul>
<li>OpenAI (via <code>run_openai_batch_pipeline()</code> +
<code>openai_get_batch()</code>)</li>
<li>Anthropic (via <code>run_anthropic_batch_pipeline()</code> +
<code>anthropic_get_batch()</code>)</li>
<li>Gemini (via low-level helpers such as
<code>build_gemini_batch_requests()</code> and
<code>gemini_create_batch()</code>)</li>
</ul>
<p>At present, batch helpers are implemented for OpenAI, Anthropic, and
Gemini. Together.ai and Ollama are supported only via the live APIs
(<code>submit_llm_pairs()</code> / <code>llm_compare_pair()</code>).</p>
<blockquote>
<p>Note: All heavy API calls in this vignette are set to
<code>eval = FALSE</code> so that the vignette remains CRAN-safe. You
can enable them in your own project.</p>
</blockquote>
<p>For basic function usage, see the companion vignette:</p>
<ul>
<li><a href="https://shmercer.github.io/pairwiseLLM/articles/getting-started.html"><code>vignette(&quot;getting-started&quot;)</code></a></li>
</ul>
<p>For prompt evaluation and positional-bias diagnostics, see the
companion vignette:</p>
<ul>
<li><a href="https://shmercer.github.io/pairwiseLLM/articles/prompt-template-bias.html"><code>vignette(&quot;prompt-template-bias&quot;)</code></a></li>
</ul>
</div>
<div id="setup-and-api-keys" class="section level1">
<h1>2. Setup and API Keys</h1>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(pairwiseLLM)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(tidyr)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(readr)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">library</span>(stringr)</span></code></pre></div>
<p>Required environment variables:</p>
<table>
<thead>
<tr class="header">
<th>Provider</th>
<th>Environment Variable</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>OpenAI</td>
<td><code>OPENAI_API_KEY</code></td>
</tr>
<tr class="even">
<td>Anthropic</td>
<td><code>ANTHROPIC_API_KEY</code></td>
</tr>
<tr class="odd">
<td>Gemini</td>
<td><code>GEMINI_API_KEY</code></td>
</tr>
</tbody>
</table>
<p>Check which are set:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">check_llm_api_keys</span>()</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">#&gt; All known LLM API keys are set: OPENAI_API_KEY, ANTHROPIC_API_KEY, GEMINI_API_KEY, TOGETHER_API_KEY.</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#&gt; # A tibble: 4 × 4</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">#&gt;   backend   service       env_var           has_key</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;     &lt;chr&gt;         &lt;chr&gt;             &lt;lgl&gt;  </span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">#&gt; 1 openai    OpenAI        OPENAI_API_KEY    TRUE   </span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="co">#&gt; 2 anthropic Anthropic     ANTHROPIC_API_KEY TRUE   </span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="co">#&gt; 3 gemini    Google Gemini GEMINI_API_KEY    TRUE   </span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co">#&gt; 4 together  Together.ai   TOGETHER_API_KEY  TRUE</span></span></code></pre></div>
</div>
<div id="example-data-and-prompt-template" class="section level1">
<h1>3. Example Data and Prompt Template</h1>
<p>We use the built-in writing samples and a single trait
(<code>overall_quality</code>).</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">data</span>(<span class="st">&quot;example_writing_samples&quot;</span>, <span class="at">package =</span> <span class="st">&quot;pairwiseLLM&quot;</span>)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>td <span class="ot">&lt;-</span> <span class="fu">trait_description</span>(<span class="st">&quot;overall_quality&quot;</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>td</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">#&gt; $name</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Overall Quality&quot;</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="co">#&gt; $description</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Overall quality of the writing, considering how well ideas are expressed,\n      how clearly the writing is organized, and how effective the language and\n      conventions are.&quot;</span></span></code></pre></div>
<p>Default prompt template:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>tmpl <span class="ot">&lt;-</span> <span class="fu">set_prompt_template</span>()</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">substr</span>(tmpl, <span class="dv">1</span>, <span class="dv">400</span>), <span class="st">&quot;...</span><span class="sc">\n</span><span class="st">&quot;</span>)</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt; You are a debate adjudicator. Your task is to weigh the comparative strengths of two writing samples regarding a specific trait.</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co">#&gt; TRAIT: {TRAIT_NAME}</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="co">#&gt; DEFINITION: {TRAIT_DESCRIPTION}</span></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="co">#&gt; SAMPLES:</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">#&gt; === SAMPLE_1 ===</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="co">#&gt; {SAMPLE_1}</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="co">#&gt; === SAMPLE_2 ===</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="co">#&gt; {SAMPLE_2}</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co">#&gt; EVALUATION PROCESS (Mental Simulation):</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="co">#&gt; </span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="co">#&gt; 1.  **Advocate for SAMPLE_1**: Mentally list the single strongest point of evidence that makes SAMPLE_1 the  ...</span></span></code></pre></div>
<p>Construct a modest number of pairs to keep the example light:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>pairs_all <span class="ot">&lt;-</span> example_writing_samples <span class="sc">|&gt;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>  <span class="fu">make_pairs</span>()</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>n_pairs <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="dv">40</span><span class="dt">L</span>, <span class="fu">nrow</span>(pairs_all))</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>pairs_forward <span class="ot">&lt;-</span> pairs_all <span class="sc">|&gt;</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  <span class="fu">sample_pairs</span>(<span class="at">n_pairs =</span> n_pairs, <span class="at">seed =</span> <span class="dv">123</span>) <span class="sc">|&gt;</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="fu">randomize_pair_order</span>(<span class="at">seed =</span> <span class="dv">456</span>)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>pairs_reverse <span class="ot">&lt;-</span> <span class="fu">sample_reverse_pairs</span>(</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  pairs_forward,</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  <span class="at">reverse_pct =</span> <span class="fl">1.0</span>,</span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>  <span class="at">seed        =</span> <span class="dv">789</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>)</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>get_pairs_for_direction <span class="ot">&lt;-</span> <span class="cf">function</span>(<span class="at">direction =</span> <span class="fu">c</span>(<span class="st">&quot;forward&quot;</span>, <span class="st">&quot;reverse&quot;</span>)) {</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>  direction <span class="ot">&lt;-</span> <span class="fu">match.arg</span>(direction)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">identical</span>(direction, <span class="st">&quot;forward&quot;</span>)) {</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    pairs_forward</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    pairs_reverse</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  }</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="designing-the-batch-grid" class="section level1">
<h1>4. Designing the Batch Grid</h1>
<p>Suppose we want to test several prompt templates across:</p>
<ul>
<li>Anthropic models (with/without “thinking”)</li>
<li>OpenAI models (with/without “thinking” for specific models)</li>
<li>Gemini models (with “thinking” enabled)</li>
</ul>
<p>Here we define a small grid:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>anthropic_models <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="st">&quot;claude-sonnet-4-5&quot;</span>,</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="st">&quot;claude-haiku-4-5&quot;</span>,</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="st">&quot;claude-opus-4-5&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>gemini_models <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="st">&quot;gemini-3-pro-preview&quot;</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>openai_models <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  <span class="st">&quot;gpt-4.1&quot;</span>,</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  <span class="st">&quot;gpt-4o&quot;</span>,</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>  <span class="st">&quot;gpt-5.1&quot;</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>)</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>thinking_levels <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;no_thinking&quot;</span>, <span class="st">&quot;with_thinking&quot;</span>)</span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>directions <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;forward&quot;</span>, <span class="st">&quot;reverse&quot;</span>)</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>anthropic_grid <span class="ot">&lt;-</span> tidyr<span class="sc">::</span><span class="fu">expand_grid</span>(</span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>  <span class="at">provider  =</span> <span class="st">&quot;anthropic&quot;</span>,</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>  <span class="at">model     =</span> anthropic_models,</span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>  <span class="at">thinking  =</span> thinking_levels,</span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>  <span class="at">direction =</span> directions</span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>)</span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>gemini_grid <span class="ot">&lt;-</span> tidyr<span class="sc">::</span><span class="fu">expand_grid</span>(</span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>  <span class="at">provider  =</span> <span class="st">&quot;gemini&quot;</span>,</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>  <span class="at">model     =</span> gemini_models,</span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>  <span class="at">thinking  =</span> <span class="st">&quot;with_thinking&quot;</span>,</span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>  <span class="at">direction =</span> directions</span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>)</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>openai_grid <span class="ot">&lt;-</span> tidyr<span class="sc">::</span><span class="fu">expand_grid</span>(</span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>  <span class="at">provider  =</span> <span class="st">&quot;openai&quot;</span>,</span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>  <span class="at">model     =</span> openai_models,</span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>  <span class="at">thinking  =</span> thinking_levels,</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>  <span class="at">direction =</span> directions</span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>  <span class="co"># For example, only allow &quot;with_thinking&quot; for gpt-5.1</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">filter</span>(model <span class="sc">==</span> <span class="st">&quot;gpt-5.1&quot;</span> <span class="sc">|</span> thinking <span class="sc">==</span> <span class="st">&quot;no_thinking&quot;</span>)</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>batch_grid <span class="ot">&lt;-</span> dplyr<span class="sc">::</span><span class="fu">bind_rows</span>(</span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>  anthropic_grid,</span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a>  gemini_grid,</span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a>  openai_grid</span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>)</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>batch_grid</span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a><span class="co">#&gt; # A tibble: 22 × 4</span></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a><span class="co">#&gt;    provider  model             thinking      direction</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a><span class="co">#&gt;    &lt;chr&gt;     &lt;chr&gt;             &lt;chr&gt;         &lt;chr&gt;    </span></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a><span class="co">#&gt;  1 anthropic claude-sonnet-4-5 no_thinking   forward  </span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a><span class="co">#&gt;  2 anthropic claude-sonnet-4-5 no_thinking   reverse  </span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a><span class="co">#&gt;  3 anthropic claude-sonnet-4-5 with_thinking forward  </span></span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a><span class="co">#&gt;  4 anthropic claude-sonnet-4-5 with_thinking reverse  </span></span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a><span class="co">#&gt;  5 anthropic claude-haiku-4-5  no_thinking   forward  </span></span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a><span class="co">#&gt;  6 anthropic claude-haiku-4-5  no_thinking   reverse  </span></span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a><span class="co">#&gt;  7 anthropic claude-haiku-4-5  with_thinking forward  </span></span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a><span class="co">#&gt;  8 anthropic claude-haiku-4-5  with_thinking reverse  </span></span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a><span class="co">#&gt;  9 anthropic claude-opus-4-5   no_thinking   forward  </span></span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a><span class="co">#&gt; 10 anthropic claude-opus-4-5   no_thinking   reverse  </span></span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a><span class="co">#&gt; # ℹ 12 more rows</span></span></code></pre></div>
<p>We will also imagine multiple prompt templates have been registered.
For simplicity, we use the same <code>tmpl</code> string, but in
practice you would substitute different text:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>templates_tbl <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="at">template_id     =</span> <span class="fu">c</span>(<span class="st">&quot;test1&quot;</span>, <span class="st">&quot;test2&quot;</span>, <span class="st">&quot;test3&quot;</span>, <span class="st">&quot;test4&quot;</span>, <span class="st">&quot;test5&quot;</span>),</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="at">prompt_template =</span> <span class="fu">list</span>(tmpl, tmpl, tmpl, tmpl, tmpl)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>templates_tbl</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="co">#&gt; # A tibble: 5 × 2</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="co">#&gt;   template_id prompt_template</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">#&gt;   &lt;chr&gt;       &lt;list&gt;         </span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">#&gt; 1 test1       &lt;chr [1]&gt;      </span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="co">#&gt; 2 test2       &lt;chr [1]&gt;      </span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="co">#&gt; 3 test3       &lt;chr [1]&gt;      </span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co">#&gt; 4 test4       &lt;chr [1]&gt;      </span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co">#&gt; 5 test5       &lt;chr [1]&gt;</span></span></code></pre></div>
</div>
<div id="phase-1-submitting-many-batches-no-polling-yet" class="section level1">
<h1>5. Phase 1: Submitting Many Batches (No Polling Yet)</h1>
<p>We will:</p>
<ol style="list-style-type: decimal">
<li>Loop over all
<code>(template_id, provider, model, thinking, direction)</code>
combinations.</li>
<li>Submit a batch for each combination.</li>
<li>Record metadata (including <code>batch_id</code>) in an in-memory
<code>jobs</code> list.</li>
<li>Write a <strong>batch index CSV</strong> to disk.</li>
</ol>
<p>Create an output directory:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>out_dir <span class="ot">&lt;-</span> <span class="st">&quot;dev-output/advanced-multi-batch&quot;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="fu">dir.create</span>(out_dir, <span class="at">recursive =</span> <span class="cn">TRUE</span>, <span class="at">showWarnings =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Submit all batches:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="cf">for</span> (t_row <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(templates_tbl))) {</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  template_id <span class="ot">&lt;-</span> templates_tbl<span class="sc">$</span>template_id[t_row]</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  tmpl_string <span class="ot">&lt;-</span> templates_tbl<span class="sc">$</span>prompt_template[[t_row]]</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_len</span>(<span class="fu">nrow</span>(batch_grid))) {</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>    row <span class="ot">&lt;-</span> batch_grid[i, ]</span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>    provider <span class="ot">&lt;-</span> row<span class="sc">$</span>provider</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>    model <span class="ot">&lt;-</span> row<span class="sc">$</span>model</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>    thinking <span class="ot">&lt;-</span> row<span class="sc">$</span>thinking</span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>    direction <span class="ot">&lt;-</span> row<span class="sc">$</span>direction</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>    <span class="fu">message</span>(</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>      <span class="st">&quot;Submitting batch: template=&quot;</span>, template_id,</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>      <span class="st">&quot; | &quot;</span>, provider, <span class="st">&quot; / &quot;</span>, model,</span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>      <span class="st">&quot; / &quot;</span>, thinking, <span class="st">&quot; / &quot;</span>, direction</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    )</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    pairs_use <span class="ot">&lt;-</span> <span class="fu">get_pairs_for_direction</span>(direction)</span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>    is_thinking <span class="ot">&lt;-</span> <span class="fu">identical</span>(thinking, <span class="st">&quot;with_thinking&quot;</span>)</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>    prefix <span class="ot">&lt;-</span> <span class="fu">paste</span>(provider, template_id, model, thinking, direction,</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>      <span class="at">sep =</span> <span class="st">&quot;_&quot;</span></span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    )</span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>    prefix <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;[^A-Za-z0-9_.-]&quot;</span>, <span class="st">&quot;-&quot;</span>, prefix)</span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>    batch_input_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">paste0</span>(prefix, <span class="st">&quot;_input.jsonl&quot;</span>))</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>    batch_output_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">paste0</span>(prefix, <span class="st">&quot;_output.jsonl&quot;</span>))</span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>    csv_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="fu">paste0</span>(prefix, <span class="st">&quot;.csv&quot;</span>))</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(provider, <span class="st">&quot;openai&quot;</span>)) {</span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>      <span class="co"># OpenAI: use the helpers from the dev scripts</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>      include_thoughts <span class="ot">&lt;-</span> is_thinking <span class="sc">&amp;&amp;</span> <span class="fu">grepl</span>(<span class="st">&quot;^gpt-5</span><span class="sc">\\</span><span class="st">.1&quot;</span>, model)</span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a>      pipeline <span class="ot">&lt;-</span> <span class="fu">run_openai_batch_pipeline</span>(</span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>        <span class="at">pairs             =</span> pairs_use,</span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>        <span class="at">model             =</span> model,</span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>        <span class="at">trait_name        =</span> td<span class="sc">$</span>name,</span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a>        <span class="at">trait_description =</span> td<span class="sc">$</span>description,</span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>        <span class="at">prompt_template   =</span> tmpl_string,</span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a>        <span class="at">include_thoughts  =</span> include_thoughts,</span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>        <span class="at">include_raw       =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>        <span class="at">batch_input_path  =</span> batch_input_path,</span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a>        <span class="at">batch_output_path =</span> batch_output_path,</span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a>        <span class="at">poll              =</span> <span class="cn">FALSE</span></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a>      )</span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a>      jobs[[<span class="fu">length</span>(jobs) <span class="sc">+</span> <span class="dv">1</span><span class="dt">L</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a>        <span class="at">template_id       =</span> template_id,</span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a>        <span class="at">provider          =</span> provider,</span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a>        <span class="at">model             =</span> model,</span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a>        <span class="at">thinking          =</span> thinking,</span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a>        <span class="at">direction         =</span> direction,</span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a>        <span class="at">prefix            =</span> prefix,</span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a>        <span class="at">batch_type        =</span> <span class="st">&quot;openai&quot;</span>,</span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a>        <span class="at">batch_id          =</span> pipeline<span class="sc">$</span>batch<span class="sc">$</span>id,</span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>        <span class="at">batch_input_path  =</span> pipeline<span class="sc">$</span>batch_input_path,</span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a>        <span class="at">batch_output_path =</span> batch_output_path,</span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a>        <span class="at">csv_path          =</span> csv_path,</span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a>        <span class="at">done              =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a>        <span class="at">results           =</span> <span class="cn">NULL</span></span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a>      )</span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">identical</span>(provider, <span class="st">&quot;anthropic&quot;</span>)) {</span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a>      <span class="co"># Anthropic: use run_anthropic_batch_pipeline()</span></span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a>      reasoning <span class="ot">&lt;-</span> <span class="cf">if</span> (is_thinking) <span class="st">&quot;enabled&quot;</span> <span class="cf">else</span> <span class="st">&quot;none&quot;</span></span>
<span id="cb9-68"><a href="#cb9-68" tabindex="-1"></a>      temperature_arg <span class="ot">&lt;-</span> <span class="cf">if</span> (<span class="sc">!</span>is_thinking) <span class="dv">0</span> <span class="cf">else</span> <span class="cn">NULL</span></span>
<span id="cb9-69"><a href="#cb9-69" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" tabindex="-1"></a>      pipeline <span class="ot">&lt;-</span> <span class="fu">run_anthropic_batch_pipeline</span>(</span>
<span id="cb9-71"><a href="#cb9-71" tabindex="-1"></a>        <span class="at">pairs             =</span> pairs_use,</span>
<span id="cb9-72"><a href="#cb9-72" tabindex="-1"></a>        <span class="at">model             =</span> model,</span>
<span id="cb9-73"><a href="#cb9-73" tabindex="-1"></a>        <span class="at">trait_name        =</span> td<span class="sc">$</span>name,</span>
<span id="cb9-74"><a href="#cb9-74" tabindex="-1"></a>        <span class="at">trait_description =</span> td<span class="sc">$</span>description,</span>
<span id="cb9-75"><a href="#cb9-75" tabindex="-1"></a>        <span class="at">prompt_template   =</span> tmpl_string,</span>
<span id="cb9-76"><a href="#cb9-76" tabindex="-1"></a>        <span class="at">reasoning         =</span> reasoning,</span>
<span id="cb9-77"><a href="#cb9-77" tabindex="-1"></a>        <span class="at">include_thoughts  =</span> is_thinking,</span>
<span id="cb9-78"><a href="#cb9-78" tabindex="-1"></a>        <span class="at">batch_input_path  =</span> batch_input_path,</span>
<span id="cb9-79"><a href="#cb9-79" tabindex="-1"></a>        <span class="at">batch_output_path =</span> batch_output_path,</span>
<span id="cb9-80"><a href="#cb9-80" tabindex="-1"></a>        <span class="at">poll              =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-81"><a href="#cb9-81" tabindex="-1"></a>        <span class="at">temperature       =</span> temperature_arg,</span>
<span id="cb9-82"><a href="#cb9-82" tabindex="-1"></a>        <span class="at">include_raw       =</span> <span class="cn">TRUE</span></span>
<span id="cb9-83"><a href="#cb9-83" tabindex="-1"></a>      )</span>
<span id="cb9-84"><a href="#cb9-84" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" tabindex="-1"></a>      jobs[[<span class="fu">length</span>(jobs) <span class="sc">+</span> <span class="dv">1</span><span class="dt">L</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-86"><a href="#cb9-86" tabindex="-1"></a>        <span class="at">template_id       =</span> template_id,</span>
<span id="cb9-87"><a href="#cb9-87" tabindex="-1"></a>        <span class="at">provider          =</span> provider,</span>
<span id="cb9-88"><a href="#cb9-88" tabindex="-1"></a>        <span class="at">model             =</span> model,</span>
<span id="cb9-89"><a href="#cb9-89" tabindex="-1"></a>        <span class="at">thinking          =</span> thinking,</span>
<span id="cb9-90"><a href="#cb9-90" tabindex="-1"></a>        <span class="at">direction         =</span> direction,</span>
<span id="cb9-91"><a href="#cb9-91" tabindex="-1"></a>        <span class="at">prefix            =</span> prefix,</span>
<span id="cb9-92"><a href="#cb9-92" tabindex="-1"></a>        <span class="at">batch_type        =</span> <span class="st">&quot;anthropic&quot;</span>,</span>
<span id="cb9-93"><a href="#cb9-93" tabindex="-1"></a>        <span class="at">batch_id          =</span> pipeline<span class="sc">$</span>batch<span class="sc">$</span>id,</span>
<span id="cb9-94"><a href="#cb9-94" tabindex="-1"></a>        <span class="at">batch_input_path  =</span> pipeline<span class="sc">$</span>batch_input_path,</span>
<span id="cb9-95"><a href="#cb9-95" tabindex="-1"></a>        <span class="at">batch_output_path =</span> batch_output_path,</span>
<span id="cb9-96"><a href="#cb9-96" tabindex="-1"></a>        <span class="at">csv_path          =</span> csv_path,</span>
<span id="cb9-97"><a href="#cb9-97" tabindex="-1"></a>        <span class="at">done              =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-98"><a href="#cb9-98" tabindex="-1"></a>        <span class="at">results           =</span> <span class="cn">NULL</span></span>
<span id="cb9-99"><a href="#cb9-99" tabindex="-1"></a>      )</span>
<span id="cb9-100"><a href="#cb9-100" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">identical</span>(provider, <span class="st">&quot;gemini&quot;</span>)) {</span>
<span id="cb9-101"><a href="#cb9-101" tabindex="-1"></a>      <span class="co"># Gemini: typically use low-level helpers, as in the dev scripts</span></span>
<span id="cb9-102"><a href="#cb9-102" tabindex="-1"></a>      req_tbl <span class="ot">&lt;-</span> <span class="fu">build_gemini_batch_requests</span>(</span>
<span id="cb9-103"><a href="#cb9-103" tabindex="-1"></a>        <span class="at">pairs             =</span> pairs_use,</span>
<span id="cb9-104"><a href="#cb9-104" tabindex="-1"></a>        <span class="at">model             =</span> model,</span>
<span id="cb9-105"><a href="#cb9-105" tabindex="-1"></a>        <span class="at">trait_name        =</span> td<span class="sc">$</span>name,</span>
<span id="cb9-106"><a href="#cb9-106" tabindex="-1"></a>        <span class="at">trait_description =</span> td<span class="sc">$</span>description,</span>
<span id="cb9-107"><a href="#cb9-107" tabindex="-1"></a>        <span class="at">prompt_template   =</span> tmpl_string,</span>
<span id="cb9-108"><a href="#cb9-108" tabindex="-1"></a>        <span class="at">thinking_level    =</span> <span class="st">&quot;low&quot;</span>, <span class="co"># example</span></span>
<span id="cb9-109"><a href="#cb9-109" tabindex="-1"></a>        <span class="at">include_thoughts  =</span> <span class="cn">TRUE</span></span>
<span id="cb9-110"><a href="#cb9-110" tabindex="-1"></a>      )</span>
<span id="cb9-111"><a href="#cb9-111" tabindex="-1"></a></span>
<span id="cb9-112"><a href="#cb9-112" tabindex="-1"></a>      batch <span class="ot">&lt;-</span> <span class="fu">gemini_create_batch</span>(</span>
<span id="cb9-113"><a href="#cb9-113" tabindex="-1"></a>        <span class="at">requests    =</span> req_tbl<span class="sc">$</span>request,</span>
<span id="cb9-114"><a href="#cb9-114" tabindex="-1"></a>        <span class="at">model       =</span> model,</span>
<span id="cb9-115"><a href="#cb9-115" tabindex="-1"></a>        <span class="at">api_key     =</span> <span class="fu">Sys.getenv</span>(<span class="st">&quot;GEMINI_API_KEY&quot;</span>),</span>
<span id="cb9-116"><a href="#cb9-116" tabindex="-1"></a>        <span class="at">api_version =</span> <span class="st">&quot;v1beta&quot;</span></span>
<span id="cb9-117"><a href="#cb9-117" tabindex="-1"></a>      )</span>
<span id="cb9-118"><a href="#cb9-118" tabindex="-1"></a></span>
<span id="cb9-119"><a href="#cb9-119" tabindex="-1"></a>      batch_name <span class="ot">&lt;-</span> batch<span class="sc">$</span>name <span class="sc">%||%</span> <span class="fu">stop</span>(</span>
<span id="cb9-120"><a href="#cb9-120" tabindex="-1"></a>        <span class="st">&quot;Gemini batch did not return a `name` field.&quot;</span>,</span>
<span id="cb9-121"><a href="#cb9-121" tabindex="-1"></a>        <span class="at">call. =</span> <span class="cn">FALSE</span></span>
<span id="cb9-122"><a href="#cb9-122" tabindex="-1"></a>      )</span>
<span id="cb9-123"><a href="#cb9-123" tabindex="-1"></a></span>
<span id="cb9-124"><a href="#cb9-124" tabindex="-1"></a>      jobs[[<span class="fu">length</span>(jobs) <span class="sc">+</span> <span class="dv">1</span><span class="dt">L</span>]] <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb9-125"><a href="#cb9-125" tabindex="-1"></a>        <span class="at">template_id       =</span> template_id,</span>
<span id="cb9-126"><a href="#cb9-126" tabindex="-1"></a>        <span class="at">provider          =</span> provider,</span>
<span id="cb9-127"><a href="#cb9-127" tabindex="-1"></a>        <span class="at">model             =</span> model,</span>
<span id="cb9-128"><a href="#cb9-128" tabindex="-1"></a>        <span class="at">thinking          =</span> thinking,</span>
<span id="cb9-129"><a href="#cb9-129" tabindex="-1"></a>        <span class="at">direction         =</span> direction,</span>
<span id="cb9-130"><a href="#cb9-130" tabindex="-1"></a>        <span class="at">prefix            =</span> prefix,</span>
<span id="cb9-131"><a href="#cb9-131" tabindex="-1"></a>        <span class="at">batch_type        =</span> <span class="st">&quot;gemini&quot;</span>,</span>
<span id="cb9-132"><a href="#cb9-132" tabindex="-1"></a>        <span class="at">batch_id          =</span> batch_name,</span>
<span id="cb9-133"><a href="#cb9-133" tabindex="-1"></a>        <span class="at">batch_input_path  =</span> batch_input_path,</span>
<span id="cb9-134"><a href="#cb9-134" tabindex="-1"></a>        <span class="at">batch_output_path =</span> batch_output_path,</span>
<span id="cb9-135"><a href="#cb9-135" tabindex="-1"></a>        <span class="at">csv_path          =</span> csv_path,</span>
<span id="cb9-136"><a href="#cb9-136" tabindex="-1"></a>        <span class="at">done              =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-137"><a href="#cb9-137" tabindex="-1"></a>        <span class="at">results           =</span> <span class="cn">NULL</span></span>
<span id="cb9-138"><a href="#cb9-138" tabindex="-1"></a>      )</span>
<span id="cb9-139"><a href="#cb9-139" tabindex="-1"></a>    }</span>
<span id="cb9-140"><a href="#cb9-140" tabindex="-1"></a>  }</span>
<span id="cb9-141"><a href="#cb9-141" tabindex="-1"></a>}</span></code></pre></div>
<div id="writing-a-batch-registry-csv-important" class="section level2">
<h2>5.1 Writing a Batch Registry CSV (Important!)</h2>
<p>To avoid losing batch IDs if your session dies, write a compact index
of all jobs to disk:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>jobs_tbl <span class="ot">&lt;-</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="at">idx =</span> <span class="fu">seq_along</span>(jobs),</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="at">template_id =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;template_id&quot;</span>),</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="at">provider =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;provider&quot;</span>),</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="at">model =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;model&quot;</span>),</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="at">thinking =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;thinking&quot;</span>),</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  <span class="at">direction =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;direction&quot;</span>),</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  <span class="at">prefix =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;prefix&quot;</span>),</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  <span class="at">batch_type =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;batch_type&quot;</span>),</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="at">batch_id =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;batch_id&quot;</span>),</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="at">batch_input_path =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;batch_input_path&quot;</span>),</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="at">batch_output_path =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;batch_output_path&quot;</span>),</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="at">csv_path =</span> <span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">character</span>(<span class="dv">1</span>), <span class="st">&quot;csv_path&quot;</span>)</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>jobs_index_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">&quot;batch_jobs_index.csv&quot;</span>)</span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>readr<span class="sc">::</span><span class="fu">write_csv</span>(jobs_tbl, jobs_index_path)</span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>jobs_index_path</span></code></pre></div>
<p>You can now <strong>stop R</strong> or close RStudio safely — all
critical details are in <code>batch_jobs_index.csv</code>.</p>
</div>
</div>
<div id="phase-2-polling-downloading-and-parsing" class="section level1">
<h1>6. Phase 2: Polling, Downloading, and Parsing</h1>
<p>In a <em>new</em> session, you can:</p>
<ol style="list-style-type: decimal">
<li>Reload the batch index CSV<br />
</li>
<li>Rebuild the <code>jobs</code> list<br />
</li>
<li>Poll providers for batch status<br />
</li>
<li>Download and parse results when complete<br />
</li>
<li>Save per-job CSVs of parsed results</li>
</ol>
<p>First, helper functions for terminal states:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>is_terminal_openai <span class="ot">&lt;-</span> <span class="cf">function</span>(status) {</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;completed&quot;</span>, <span class="st">&quot;failed&quot;</span>, <span class="st">&quot;cancelled&quot;</span>, <span class="st">&quot;expired&quot;</span>)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>}</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>is_terminal_anthropic <span class="ot">&lt;-</span> <span class="cf">function</span>(status) {</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  status <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;ended&quot;</span>, <span class="st">&quot;errored&quot;</span>, <span class="st">&quot;canceled&quot;</span>, <span class="st">&quot;expired&quot;</span>)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>}</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>is_terminal_gemini <span class="ot">&lt;-</span> <span class="cf">function</span>(state) {</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  state <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;SUCCEEDED&quot;</span>, <span class="st">&quot;FAILED&quot;</span>, <span class="st">&quot;CANCELLED&quot;</span>, <span class="st">&quot;EXPIRED&quot;</span>)</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>}</span></code></pre></div>
<p>Now the polling loop, with a small delay between jobs to reduce 429
(rate limit) risks:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>interval_seconds <span class="ot">&lt;-</span> <span class="dv">60</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>per_job_delay <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="co"># seconds between polling calls</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co"># Reload batch index</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>jobs_index_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">&quot;batch_jobs_index.csv&quot;</span>)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>jobs_tbl <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(jobs_index_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="co"># Rebuild jobs list skeleton</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">pmap</span>(</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>  jobs_tbl,</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="cf">function</span>(idx, template_id, provider, model, thinking, direction,</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>           prefix, batch_type, batch_id,</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>           batch_input_path, batch_output_path, csv_path, ...) {</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a>      <span class="at">template_id       =</span> template_id,</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>      <span class="at">provider          =</span> provider,</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>      <span class="at">model             =</span> model,</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>      <span class="at">thinking          =</span> thinking,</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>      <span class="at">direction         =</span> direction,</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>      <span class="at">prefix            =</span> prefix,</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>      <span class="at">batch_type        =</span> batch_type,</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>      <span class="at">batch_id          =</span> batch_id,</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>      <span class="at">batch_input_path  =</span> batch_input_path,</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a>      <span class="at">batch_output_path =</span> batch_output_path,</span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a>      <span class="at">csv_path          =</span> csv_path,</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>      <span class="at">done              =</span> <span class="cn">FALSE</span>,</span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>      <span class="at">results           =</span> <span class="cn">NULL</span></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>    )</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>  }</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a>)</span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>unfinished <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="st">&quot;done&quot;</span>))</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a><span class="cf">while</span> (<span class="fu">length</span>(unfinished) <span class="sc">&gt;</span> <span class="dv">0</span><span class="dt">L</span>) {</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Polling &quot;</span>, <span class="fu">length</span>(unfinished), <span class="st">&quot; unfinished batch(es)...&quot;</span>)</span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> unfinished) {</span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>    job <span class="ot">&lt;-</span> jobs[[j]]</span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>    <span class="cf">if</span> (job<span class="sc">$</span>done) <span class="cf">next</span></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a></span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a>    batch_type <span class="ot">&lt;-</span> job<span class="sc">$</span>batch_type</span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">identical</span>(batch_type, <span class="st">&quot;openai&quot;</span>)) {</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>      batch <span class="ot">&lt;-</span> <span class="fu">openai_get_batch</span>(job<span class="sc">$</span>batch_id)</span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a>      status <span class="ot">&lt;-</span> batch<span class="sc">$</span>status <span class="sc">%||%</span> <span class="st">&quot;unknown&quot;</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;  [OpenAI] &quot;</span>, job<span class="sc">$</span>prefix, <span class="st">&quot; status: &quot;</span>, status)</span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is_terminal_openai</span>(status)) {</span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">identical</span>(status, <span class="st">&quot;completed&quot;</span>)) {</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a>          <span class="fu">openai_download_batch_output</span>(</span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a>            <span class="at">batch_id =</span> job<span class="sc">$</span>batch_id,</span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a>            <span class="at">path     =</span> job<span class="sc">$</span>batch_output_path</span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a>          )</span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">parse_openai_batch_output</span>(job<span class="sc">$</span>batch_output_path)</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>          jobs[[j]]<span class="sc">$</span>results <span class="ot">&lt;-</span> res</span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>          readr<span class="sc">::</span><span class="fu">write_csv</span>(res, job<span class="sc">$</span>csv_path)</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>          <span class="fu">message</span>(<span class="st">&quot;    -&gt; Results written to: &quot;</span>, job<span class="sc">$</span>csv_path)</span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>        }</span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>        jobs[[j]]<span class="sc">$</span>done <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>      }</span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">identical</span>(batch_type, <span class="st">&quot;anthropic&quot;</span>)) {</span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a>      batch <span class="ot">&lt;-</span> <span class="fu">anthropic_get_batch</span>(job<span class="sc">$</span>batch_id)</span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a>      status <span class="ot">&lt;-</span> batch<span class="sc">$</span>processing_status <span class="sc">%||%</span> <span class="st">&quot;unknown&quot;</span></span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;  [Anthropic] &quot;</span>, job<span class="sc">$</span>prefix, <span class="st">&quot; status: &quot;</span>, status)</span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is_terminal_anthropic</span>(status)) {</span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">identical</span>(status, <span class="st">&quot;ended&quot;</span>)) {</span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a>          output_path <span class="ot">&lt;-</span> <span class="fu">anthropic_download_batch_results</span>(</span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a>            <span class="at">batch_id    =</span> job<span class="sc">$</span>batch_id,</span>
<span id="cb12-71"><a href="#cb12-71" tabindex="-1"></a>            <span class="at">output_path =</span> job<span class="sc">$</span>batch_output_path</span>
<span id="cb12-72"><a href="#cb12-72" tabindex="-1"></a>          )</span>
<span id="cb12-73"><a href="#cb12-73" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">parse_anthropic_batch_output</span>(</span>
<span id="cb12-75"><a href="#cb12-75" tabindex="-1"></a>            <span class="at">jsonl_path  =</span> output_path,</span>
<span id="cb12-76"><a href="#cb12-76" tabindex="-1"></a>            <span class="at">tag_prefix  =</span> <span class="st">&quot;&lt;BETTER_SAMPLE&gt;&quot;</span>,</span>
<span id="cb12-77"><a href="#cb12-77" tabindex="-1"></a>            <span class="at">tag_suffix  =</span> <span class="st">&quot;&lt;/BETTER_SAMPLE&gt;&quot;</span></span>
<span id="cb12-78"><a href="#cb12-78" tabindex="-1"></a>          )</span>
<span id="cb12-79"><a href="#cb12-79" tabindex="-1"></a></span>
<span id="cb12-80"><a href="#cb12-80" tabindex="-1"></a>          jobs[[j]]<span class="sc">$</span>results <span class="ot">&lt;-</span> res</span>
<span id="cb12-81"><a href="#cb12-81" tabindex="-1"></a>          readr<span class="sc">::</span><span class="fu">write_csv</span>(res, job<span class="sc">$</span>csv_path)</span>
<span id="cb12-82"><a href="#cb12-82" tabindex="-1"></a>          <span class="fu">message</span>(<span class="st">&quot;    -&gt; Results written to: &quot;</span>, job<span class="sc">$</span>csv_path)</span>
<span id="cb12-83"><a href="#cb12-83" tabindex="-1"></a>        }</span>
<span id="cb12-84"><a href="#cb12-84" tabindex="-1"></a>        jobs[[j]]<span class="sc">$</span>done <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb12-85"><a href="#cb12-85" tabindex="-1"></a>      }</span>
<span id="cb12-86"><a href="#cb12-86" tabindex="-1"></a>    } <span class="cf">else</span> <span class="cf">if</span> (<span class="fu">identical</span>(batch_type, <span class="st">&quot;gemini&quot;</span>)) {</span>
<span id="cb12-87"><a href="#cb12-87" tabindex="-1"></a>      batch <span class="ot">&lt;-</span> <span class="fu">gemini_get_batch</span>(job<span class="sc">$</span>batch_id)</span>
<span id="cb12-88"><a href="#cb12-88" tabindex="-1"></a>      state <span class="ot">&lt;-</span> batch<span class="sc">$</span>state <span class="sc">%||%</span> <span class="st">&quot;STATE_UNSPECIFIED&quot;</span></span>
<span id="cb12-89"><a href="#cb12-89" tabindex="-1"></a>      <span class="fu">message</span>(<span class="st">&quot;  [Gemini] &quot;</span>, job<span class="sc">$</span>prefix, <span class="st">&quot; state: &quot;</span>, state)</span>
<span id="cb12-90"><a href="#cb12-90" tabindex="-1"></a></span>
<span id="cb12-91"><a href="#cb12-91" tabindex="-1"></a>      <span class="cf">if</span> (<span class="fu">is_terminal_gemini</span>(state)) {</span>
<span id="cb12-92"><a href="#cb12-92" tabindex="-1"></a>        <span class="cf">if</span> (<span class="fu">identical</span>(state, <span class="st">&quot;SUCCEEDED&quot;</span>)) {</span>
<span id="cb12-93"><a href="#cb12-93" tabindex="-1"></a>          raw_res <span class="ot">&lt;-</span> <span class="fu">gemini_download_batch_results</span>(job<span class="sc">$</span>batch_id)</span>
<span id="cb12-94"><a href="#cb12-94" tabindex="-1"></a></span>
<span id="cb12-95"><a href="#cb12-95" tabindex="-1"></a>          res <span class="ot">&lt;-</span> <span class="fu">parse_gemini_batch_output</span>(</span>
<span id="cb12-96"><a href="#cb12-96" tabindex="-1"></a>            <span class="at">raw_results =</span> raw_res,</span>
<span id="cb12-97"><a href="#cb12-97" tabindex="-1"></a>            <span class="at">tag_prefix  =</span> <span class="st">&quot;&lt;BETTER_SAMPLE&gt;&quot;</span>,</span>
<span id="cb12-98"><a href="#cb12-98" tabindex="-1"></a>            <span class="at">tag_suffix  =</span> <span class="st">&quot;&lt;/BETTER_SAMPLE&gt;&quot;</span></span>
<span id="cb12-99"><a href="#cb12-99" tabindex="-1"></a>          )</span>
<span id="cb12-100"><a href="#cb12-100" tabindex="-1"></a></span>
<span id="cb12-101"><a href="#cb12-101" tabindex="-1"></a>          jobs[[j]]<span class="sc">$</span>results <span class="ot">&lt;-</span> res</span>
<span id="cb12-102"><a href="#cb12-102" tabindex="-1"></a>          readr<span class="sc">::</span><span class="fu">write_csv</span>(res, job<span class="sc">$</span>csv_path)</span>
<span id="cb12-103"><a href="#cb12-103" tabindex="-1"></a>          <span class="fu">message</span>(<span class="st">&quot;    -&gt; Results written to: &quot;</span>, job<span class="sc">$</span>csv_path)</span>
<span id="cb12-104"><a href="#cb12-104" tabindex="-1"></a>        }</span>
<span id="cb12-105"><a href="#cb12-105" tabindex="-1"></a>        jobs[[j]]<span class="sc">$</span>done <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb12-106"><a href="#cb12-106" tabindex="-1"></a>      }</span>
<span id="cb12-107"><a href="#cb12-107" tabindex="-1"></a>    }</span>
<span id="cb12-108"><a href="#cb12-108" tabindex="-1"></a></span>
<span id="cb12-109"><a href="#cb12-109" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(per_job_delay)</span>
<span id="cb12-110"><a href="#cb12-110" tabindex="-1"></a>  }</span>
<span id="cb12-111"><a href="#cb12-111" tabindex="-1"></a></span>
<span id="cb12-112"><a href="#cb12-112" tabindex="-1"></a>  unfinished <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="st">&quot;done&quot;</span>))</span>
<span id="cb12-113"><a href="#cb12-113" tabindex="-1"></a></span>
<span id="cb12-114"><a href="#cb12-114" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(unfinished) <span class="sc">&gt;</span> <span class="dv">0</span><span class="dt">L</span>) {</span>
<span id="cb12-115"><a href="#cb12-115" tabindex="-1"></a>    <span class="fu">message</span>(<span class="st">&quot;Sleeping &quot;</span>, interval_seconds, <span class="st">&quot; seconds before next poll...&quot;</span>)</span>
<span id="cb12-116"><a href="#cb12-116" tabindex="-1"></a>    <span class="fu">Sys.sleep</span>(interval_seconds)</span>
<span id="cb12-117"><a href="#cb12-117" tabindex="-1"></a>  }</span>
<span id="cb12-118"><a href="#cb12-118" tabindex="-1"></a>}</span>
<span id="cb12-119"><a href="#cb12-119" tabindex="-1"></a></span>
<span id="cb12-120"><a href="#cb12-120" tabindex="-1"></a><span class="fu">message</span>(<span class="st">&quot;All batches have reached a terminal state.&quot;</span>)</span></code></pre></div>
<p>At the end of this loop:</p>
<ul>
<li>All completed batches have their outputs downloaded.</li>
<li>Each job has a parsed results CSV (<code>csv_path</code>).</li>
<li>You can now perform consistency and positional-bias analyses, or fit
BT/Elo models.</li>
</ul>
</div>
<div id="resuming-after-interruption" class="section level1">
<h1>7. Resuming After Interruption</h1>
<p>If the polling loop is interrupted:</p>
<ol style="list-style-type: decimal">
<li>Restart R.</li>
<li>Reload <code>batch_jobs_index.csv</code>.</li>
<li>Rebuild <code>jobs</code> as above.</li>
<li>Recompute <code>unfinished</code> and re-enter the polling
loop.</li>
</ol>
<p>Because all of the essential metadata (provider, model, template,
direction, batch IDs, file paths) is stored in the registry CSV, you can
safely recover and continue.</p>
<p>For example:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>jobs_index_path <span class="ot">&lt;-</span> <span class="fu">file.path</span>(out_dir, <span class="st">&quot;batch_jobs_index.csv&quot;</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>jobs_tbl <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(jobs_index_path, <span class="at">show_col_types =</span> <span class="cn">FALSE</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="co"># Rebuild jobs list as before...</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co"># Then:</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>unfinished <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="sc">!</span><span class="fu">vapply</span>(jobs, <span class="st">`</span><span class="at">[[</span><span class="st">`</span>, <span class="fu">logical</span>(<span class="dv">1</span>), <span class="st">&quot;done&quot;</span>))</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">length</span>(unfinished) <span class="sc">&gt;</span> <span class="dv">0</span><span class="dt">L</span>) {</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;Resuming polling for &quot;</span>, <span class="fu">length</span>(unfinished), <span class="st">&quot; unfinished batch(es).&quot;</span>)</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  <span class="co"># ... re-enter the polling loop ...</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  <span class="fu">message</span>(<span class="st">&quot;All jobs are already complete.&quot;</span>)</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="advanced-simplified-multibatch-workflow" class="section level1">
<h1>8. Advanced: Simplified Multi‑Batch Workflow</h1>
<p>When running multiple combinations of providers, models, templates,
and “thinking” settings, you no longer need to manually build loops to
create and poll batches. The multi‑batch helpers can encapsulate this
entire process.</p>
<p>Below, <code>batch_grid</code> is a tibble containing one row per
combination of provider/model/thinking/direction; <code>tmpl</code> is a
prompt template; and <code>td</code> is a trait description. For each
combination we submit a single batch job (or split further using
<code>n_segments</code>) and record its metadata:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>jobs <span class="ot">&lt;-</span> purrr<span class="sc">::</span><span class="fu">pmap</span>(batch_grid, <span class="cf">function</span>(provider, model, thinking, direction) {</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  pairs_use <span class="ot">&lt;-</span> <span class="fu">get_pairs_for_direction</span>(direction)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  <span class="fu">llm_submit_pairs_multi_batch</span>(</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="at">pairs              =</span> pairs_use,</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>    <span class="at">backend            =</span> provider,</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>    <span class="at">model              =</span> model,</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="at">trait_name         =</span> td<span class="sc">$</span>name,</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>    <span class="at">trait_description  =</span> td<span class="sc">$</span>description,</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>    <span class="at">prompt_template    =</span> tmpl,</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>    <span class="at">n_segments         =</span> <span class="dv">1</span>,</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>    <span class="at">output_dir         =</span> out_dir,</span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>    <span class="at">write_registry     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>    <span class="at">include_thoughts   =</span> (thinking <span class="sc">==</span> <span class="st">&quot;with_thinking&quot;</span>)</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  )<span class="sc">$</span>jobs[[<span class="dv">1</span>]]</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>})</span></code></pre></div>
<p>Once all jobs are submitted, poll all providers and download
results:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">llm_resume_multi_batches</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  <span class="at">jobs               =</span> jobs,</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  <span class="at">interval_seconds   =</span> <span class="dv">60</span>,</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="at">write_results_csv  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="at">write_combined_csv =</span> <span class="cn">TRUE</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<p>This single call performs all polling, downloading, and parsing,
writing per‑batch CSVs as well as a merged results CSV. If your session
is interrupted, simply reload the registry CSV from the output directory
and call <code>llm_resume_multi_batches()</code> again.</p>
</div>
<div id="next-steps" class="section level1">
<h1>9. Next Steps</h1>
<p>Once you have per-job results CSVs (e.g., one per template × model ×
thinking × direction), you can:</p>
<ul>
<li>Compute <strong>reverse consistency</strong> with
<code>compute_reverse_consistency()</code></li>
<li>Analyze <strong>positional bias</strong> with
<code>check_positional_bias()</code></li>
<li>Aggregate results by provider/model/template using standard
<code>dplyr</code> pipelines</li>
<li>Fit <strong>Bradley–Terry</strong> models with
<code>build_bt_data()</code> + <code>fit_bt_model()</code></li>
<li>Fit <strong>Elo</strong> models with <code>fit_elo_model()</code>
(when <code>EloChoice</code> is installed)</li>
</ul>
</div>
<div id="citation" class="section level1">
<h1>10. Citation</h1>
<blockquote>
<p>Mercer, S. (2025). <em>Advanced: Submitting and Polling Multiple
Batches</em> (Version 1.0.0) [R package vignette]. In <em>pairwiseLLM:
Pairwise Comparison Tools for Large Language Model-Based Writing
Evaluation</em>. <a href="https://shmercer.github.io/pairwiseLLM/" class="uri">https://shmercer.github.io/pairwiseLLM/</a></p>
</blockquote>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
